var FL={mapSize:32,cellSize:16,rockCount:15,rockDensity:30,rockHillChance:0.4,plainHillChance:0.04,playerCount:2,minBaseDistanceSqr:8,minMainBaseDistanceSqr:200,minMainBaseSideDistance:4,minMainBaseCenterDistance:6,baseHealRate:0.1,baseSightRangeSqr:12,baseArmor:10,baseMiningRangeSqr:5,animationStepsPerSecond:20,dir4:[[0,1],[-1,0],[0,-1],[1,0]],dir8:[[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1]],sound:function(a){var b=new Audio();b.src="audio/"+a+".ogg";b.play()},random:function(a){return Math.floor(Math.random()*a)},getIjs4:function(b){var a=[];for(var c=0;c<4;++c){a.push(FL.Vector.add(b,FL.dir4[c]))}return a},getIjs8:function(b){var a=[];for(var c=0;c<8;++c){a.push(FL.Vector.add(b,FL.dir8[c]))}return a},fight:function(d,b,c){var a=0.001;var f=FL.random(c.length);var e=c[f];if(b&&e.fortified){++b}d/=e.type.armor+b*e.type.defense;if(e.health<=d+a){c.splice(f,1)}else{e.health-=d}},heal:function(c,b){var a=0.001;c+=b;return(1-c<a)?1:c},ijToXy:function(a){return[FL.cellSize*a[1],FL.cellSize*a[0]]},getHealthColor:function(a){return JW.Color.str(JW.Color.multiGradient([[0,"#600"],[0.2,"#B00"],[0.6,"#FF0"],[1,"#0B0"]],a))}};FL.AI={behaviours:["build","patrol","hold","rush","attack","attacking","assaulting","support","bombard","fly"],patrolDistance:3,healSafeDistance:3,aquisitionDistanceSqr:50,baseHoldRangeSqr:10,unitHoldRangeSqr:4,patrolInitial:3,patrolPerBase:1,initialProductionCoef:1,productionCoefPerWin:0.1,productionCoefPerLoss:0.05,mcvLimit:2,baseFirstProductionProfit:15,baseExtraProductionProfit:-4,baseDistanceProfit:-2,stackCostInitial:-30,stackCostPerBase:60,process:function(h,q){var a=h.bases.$toArray().filter(JW.byValue("player",q));var n=h.units.$toArray().filter(JW.byValue("player",q));var d=FL.AI.stackCostInitial+FL.AI.stackCostPerBase*a.length;var o=JW.Map.map(FL.Unit.types,function(){return 0});var k=JW.Map.map(FL.Unit.types,function(){return 0});var r=JW.Array.$index(FL.AI.behaviours,JW.byField()).map(function(){return[]});var m=JW.Map.map(r,function(){return 0});JW.Array.each(n,function(i){++o[i.type.id];++k[i.type.id];if(i.cell.base){if(i.cell.base.unitType.get()&&(i.cell.base.unitType.get()!==i.type)){r[i.behaviour].push(i)}else{if(FL.AI.isUnitReady(i,d)){r[i.behaviour].push(i)}}}else{if(i.isHealed()||FL.AI.isEnemyWithin(h,q,i.ij.get(),FL.AI.healSafeDistance)){r[i.behaviour].push(i)}}++m[i.behaviour]});JW.Array.each(a,function(j){var i=j.unitType.get();if(i){++k[i.id]}if(j.unitBehaviour){++m[j.unitBehaviour]}});var g=FL.AI.behaviours.concat();JW.Array.each(a,function(w){if(w.unitType.get()){return}var i=h.map.getCell(w.ij);if(i.unit&&!FL.AI.isUnitReady(i.unit,d)){w.unitType.set(i.unit.type);return}var s;if(m.build===0){s=FL.Unit.types.mcv}else{if(m.build>=FL.AI.mcvLimit){JW.Array.removeItem(g,"build")}if(m.patrol>=FL.AI.patrolInitial+FL.AI.patrolPerBase*a.length){JW.Array.removeItem(g,"patrol")}var u=w.getAvailableUnitTypes();u=JW.Array.filter(u,function(x){return JW.Array.some(x.ai,function(y){return JW.Array.containsItem(g,y)})});var t=JW.Array.filter(u,JW.byField("aiPreferred"));if(t.length){u=t}s=u[FL.random(u.length)]}w.unitType.set(s);++k[s.id];var j=JW.Array.filter(s.ai,function(x){return JW.Array.containsItem(g,x)});var v=j.length?j[FL.random(j.length)]:s.ai[FL.random(s.ai.length)];w.unitBehaviour=v;++m[v]});JW.Array.each(r.build,function(j){var i=j.ijTarget||FL.AI.findBaseSpot(h,j.ij.get(),q);if(FL.Vector.equal(i,j.ij.get())){h.buildBase(j)}else{j.ijTarget=i}});var l=new JW.Set();h.units.each(function(u){if(u.player===q){return}var j,v=Number.POSITIVE_INFINITY;JW.Array.each(a,function(x){var w=FL.Vector.lengthSqr(FL.Vector.diff(u.ij.get(),x.ij));if(w<v){j=x;v=w}});if(v>FL.AI.aquisitionDistanceSqr){return}var i,t=Number.POSITIVE_INFINITY;JW.Array.each(r.patrol,function(x){if(l.contains(x)){return}var w=FL.Vector.lengthSqr(FL.Vector.diff(x.ij.get(),j.ij));if(w<t){i=x;t=w}});if(!i){return}l.add(i);var s=FL.Vector.round(FL.Vector.between(u.ij.get(),j.ij,0.45));if(!i.ijTarget||!FL.Vector.equal(s,i.ijTarget)){i.ijTarget=s}else{if(!u.type.defense&&!i.type.defense){i.ijTarget=u.ij.get()}}});JW.Array.each(r.patrol,function(j){if(l.contains(j)){return}if(j.ijTarget){return}var s=a[FL.random(a.length)];if(!s){return}var i=h.map.getRect(s.ij,FL.AI.patrolDistance);j.ijTarget=[i.iMin+FL.random(i.iMax-i.iMin+1),i.jMin+FL.random(i.jMax-i.jMin+1)]});var c=FL.random(2)?"assaulting":"attacking";r[c]=r[c].concat(r.attack);JW.Array.each(r.attack,function(i){i.behaviour=c});FL.AI.issueAttack(h,q,r.attacking,true,true);FL.AI.issueAttack(h,q,r.assaulting,false,true);var b=new FL.Matrix(h.map.size);JW.Array.each(a,function(i){h.map.eachWithin(i.ij,FL.AI.baseHoldRangeSqr,function(j,s){b.setCell(s,true)})});JW.Array.each(r.hold,function(i){i.hold=false});for(var f=0;f<h.map.size;++f){for(var e=0;e<h.map.size;++e){var p=[f,e];if(!h.isPassable(p)||h.isChoke(p)){b.setCell(p,true)}}}JW.Array.each(r.hold,function(y){if(!b.getCell(y.ij.get())){y.hold=true;h.map.eachWithin(y.ij.get(),FL.AI.unitHoldRangeSqr,function(i,j){b.setCell(j,true)})}if(y.hold){return}var s,x=Number.POSITIVE_INFINITY;for(var w=0;w<h.map.size;++w){for(var t=0;t<h.map.size;++t){var v=[w,t];if(b.getCell(v)){continue}var u=FL.Vector.lengthSqr(FL.Vector.diff(y.ij.get(),v))+0.2*FL.Vector.lengthSqr(FL.Vector.diff(h.map.ijCenter(),v));if(u<x){s=v;x=u}}}if(s){y.ijTarget=s}else{y.ijTarget=FL.Vector.add(y.ij.get(),FL.dir8[FL.random(8)]);if(!h.map.inMatrix(y.ijTarget)){y.ijTarget=null}}})},findBaseSpot:function(d,b,k){var g=null;var f=Number.NEGATIVE_INFINITY;for(var e=0;e<d.map.size;++e){for(var c=0;c<d.map.size;++c){var l=[e,c];var h=d.map.getCell(l);if(h.rock||h.miningBase){continue}if(h.unit&&!FL.Vector.equal(b,l)){continue}var a=FL.AI.getBaseProfit(d,l,k)+FL.AI.baseDistanceProfit*FL.Vector.length(FL.Vector.diff(b,l));if(a<=f){continue}if(!d.isBaseBuildable(l)){continue}g=l;f=a}}return g},getBaseProfit:function(d,e,c){var a=0;var b=false;d.map.eachWithin(e,FL.baseMiningRangeSqr,function(f,g){if(f.rock||f.miningBase){return}if(f.unit&&(f.unit.player!==c)){a-=10000}a+=f.hill?2:1;if(f.resource){if(f.resource.aiProfit){a+=f.resource.aiProfit}if(f.resource.aiProduction){if(b){a+=FL.AI.baseExtraProductionProfit}else{b=true;a+=FL.AI.baseFirstProductionProfit}}}});return a},issueAttack:function(f,c,a,d,b){var e=[];if(b){f.bases.each(function(g){if(g.player!==c){e.push(g.ij)}})}if(d){f.units.each(function(g){if(g.player!==c){e.push(g.ij.get())}})}JW.Array.each(a,function(i){var g,h=Number.POSITIVE_INFINITY;JW.Array.each(e,function(k){var j=FL.Vector.lengthSqr(FL.Vector.diff(i.ij.get(),k));if(j<h){g=k;h=j}});if(!g){return}if(f.getPath(i.ij.get(),g,c)){i.ijTarget=g}else{i.behaviour="attacking";i.ijTarget=FL.Vector.add(i.ij.get(),FL.dir8[FL.random(8)]);if(!f.map.inMatrix(i.ijTarget)){i.ijTarget=null}}})},isUnitReady:function(a,b){return(a.behaviour==="hold")||(a.getCount()>=Math.min(a.type.capacity,Math.round(b/a.type.cost)))},isEnemyWithin:function(g,e,d,h){var f=g.map.getRect(d,h);for(var c=f.iMin;c<=f.iMax;++c){for(var b=f.jMin;b<=f.jMax;++b){var a=g.map.getCell([c,b]);if(a.unit&&(a.unit.player!==e)){return true}if(a.base&&(a.base.player!==e)){return true}}}return false}};FL.AI.productionCoef=FL.AI.initialProductionCoef+(localStorage.wins||0)*FL.AI.productionCoefPerWin-(localStorage.losses||0)*FL.AI.productionCoefPerLoss;FL.AlternateAnimation=function(a){FL.AlternateAnimation._super.call(this);this.updater=a.updater;this.finish=a.finish;this.scope=a.scope||this;this.time=new Date().getTime();this.own(new JW.Interval(this._animate,this,40))};JW.extend(FL.AlternateAnimation,JW.Class,{destroy:function(){if(this.finish){this.finish.call(this.scope)}this._super()},_animate:function(){var a=new Date().getTime()-this.time;a=Math.abs(JW.smod(a,1000))/500;if(this.updater){this.updater.call(this.scope,a)}}});FL.App=function(a){FL.App._super.call(this);this.data=a};JW.extend(FL.App,JW.UI.Component,{renderRoot:function(a){a.bind("contextmenu",JW.UI.preventDefault)},renderMonitor:function(){return this.monitor=new FL.Monitor(this.data)
},afterRender:function(){this._super();this.data.lostEvent.bind(this._onLost,this)},_onLost:function(a){this.children.set(new FL.ScreenWin(a!==0),"monitor")}});JW.UI.template(FL.App,{main:'<div jwclass="fl-app"><div jwid="monitor"></div></div>'});FL.Base=function(b,a){FL.Base._super.call(this);this.ij=b;this.player=a;this.unitType=this.own(new JW.Property(null));this.unitBehaviour=null;this.production=JW.Map.map(FL.Unit.types,function(){return 0});this.mining=0;this.overflow=0;this.resources=[];this.health=this.own(new JW.Property(0.1))};JW.extend(FL.Base,JW.Class,{isUnitTypeAvailable:function(a){if(!a.resources){return true}return JW.Array.every(a.resources,function(b){return JW.Array.containsItem(this.resources,FL.Resource.types[b])},this)},getAvailableUnitTypes:function(){return JW.Array.filter(FL.Unit.typeArray,this.isUnitTypeAvailable,this)},heal:function(){this.health.set(FL.heal(this.health.get(),FL.baseHealRate))},toPerson:function(){var a=new FL.Unit.Person(FL.Unit.baseType);a.health=this.health.get();return a}});FL.ButtonAnimation=function(a){FL.ButtonAnimation._super.call(this);this.own(new FL.AlternateAnimation({updater:function(c){var b=JW.Color.str(JW.Color.gradient("#00D000","#009000",c));a.css("background-color",b);a.css("border-color",b)},finish:function(){a.css("background-color","");a.css("border-color","")},scope:this}))};JW.extend(FL.ButtonAnimation,JW.Class);FL.Cell=function(a){FL.Cell._super.call(this);this.ij=a;this.rock=false;this.hill=(Math.random()<FL.plainHillChance);this.base=null;this.miningBase=null;this.unit=null;this.resource=null;this.scouted=false;this.visible=false;this.invalid=false};JW.extend(FL.Cell,JW.Class,{reveal:function(){if(this.scouted&&this.visible){return}this.scouted=true;this.visible=true;this.invalid=true;if(this.unit){this.unit.visible=true;this.unit.resetAnimation()}},hide:function(){if(!this.scouted||!this.visible){return}this.visible=false;this.invalid=true;if(this.unit){this.unit.visible=false;this.unit.resetAnimation()}},setBase:function(a){if(this.base===a){return}this.base=a;this.invalid=true},setMiningBase:function(a){if(a||(a!==this.miningBase)){this.invalid=true}this.miningBase=a},setUnit:function(a){if(this.unit===a){return}this.unit=a;this.invalid=true}});JW.Color={colors:{aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],grey:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],honeydew:[240,255,240],hotpink:[255,105,180],"indianred ":[205,92,92],"indigo ":[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgrey:[211,211,211],lightgreen:[144,238,144],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,216],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[216,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},_format1:/^rgb\s*\(\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*([0-9]+)\s*\)$/,_format2:/^rgb\s*\(\s*(-?[0-9]+(?:\.[0-9]+)?)\%\s*,\s*(-?[0-9]+(?:\.[0-9]+)?)\%\s*,\s*(-?[0-9]+(?:\.[0-9]+)?)\%\s*\)$/,_format3:/^#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})$/,_format4:/^#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])$/,parse:function(b){if(typeof b==="number"){if(!JW.isInt(b)||(b<0)||(b>16777215)){return null}return[(b>>16),(b>>8)&255,(b)&255]}if(typeof b==="string"){var a;b=JW.String.trim(b).toLowerCase();if(a=JW.Color.colors[b]){return a.concat()}if(a=JW.Color._format1.exec(b)){return JW.Color._parseArray([parseInt(a[1]),parseInt(a[2]),parseInt(a[3])])}if(a=JW.Color._format2.exec(b)){for(var c=0;c<3;++c){a[c+1]=parseFloat(a[c+1]);if(a[c+1]<0||a[c+1]>100){return null}}return JW.Color._parseArray([Math.round(a[1]*2.55),Math.round(a[2]*2.55),Math.round(a[3]*2.55)])}if(a=JW.Color._format3.exec(b)){return JW.Color._parseArray([parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)])}if(a=JW.Color._format4.exec(b)){return JW.Color._parseArray([parseInt(a[1],16)*17,parseInt(a[2],16)*17,parseInt(a[3],16)*17])}return null}if(JW.isArray(b)&&b.length===3&&(typeof b[0]==="number")&&(typeof b[1]==="number")&&(typeof b[2]==="number")&&JW.Color._parseArray(b)){return b.concat()}return null},suggest:function(b){if(typeof b==="number"){b=JW.mod(Math.round(b),16777216);return[(b>>16),(b>>8)&255,(b)&255]}if(typeof b==="string"){var a;b=JW.String.trim(b).toLowerCase();if(a=JW.Color.colors[b]){return a.concat()}if(a=JW.Color._format1.exec(b)){return JW.Color._suggestArray([parseInt(a[1]),parseInt(a[2]),parseInt(a[3])])}if(a=JW.Color._format2.exec(b)){return JW.Color._suggestArray([parseFloat(a[1])*2.55,parseFloat(a[2])*2.55,parseFloat(a[3])*2.55])}if(a=JW.Color._format3.exec(b)){return JW.Color._suggestArray([parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)])}if(a=JW.Color._format4.exec(b)){return JW.Color._suggestArray([parseInt(a[1],16)*17,parseInt(a[2],16)*17,parseInt(a[3],16)*17])}return null}if(JW.isArray(b)&&b.length===3&&(typeof b[0]==="number")&&(typeof b[1]==="number")&&(typeof b[2]==="number")){return JW.Color._suggestArray(b)}return null},rgb:function(b){if(typeof b==="number"){return[(b>>16),(b>>8)&255,(b)&255]}if(typeof b==="string"){var a;b=JW.String.trim(b).toLowerCase();if(a=JW.Color.colors[b]){return a.concat()}if(a=JW.Color._format1.exec(b)){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3])]
}if(a=JW.Color._format2.exec(b)){return[Math.round(parseFloat(a[1])*2.55),Math.round(parseFloat(a[2])*2.55),Math.round(parseFloat(a[3])*2.55)]}if(a=JW.Color._format3.exec(b)){return[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]}if(a=JW.Color._format4.exec(b)){return[parseInt(a[1],16)*17,parseInt(a[2],16)*17,parseInt(a[3],16)*17]}return null}return b.concat()},str:function(a){if(typeof a==="string"){return a}a=JW.Color.num(a);return"#"+JW.String.prepend(a.toString(16),6,"0")},num:function(a){if(typeof a==="number"){return a}a=JW.Color.rgb(a);return(a[0]<<16)|(a[1]<<8)|a[2]},hex:function(a){return"#"+JW.String.prepend(JW.Color.num(a).toString(16),6,"0")},darken:function(a,b){return JW.Color.gradient(a,"black",b)},lighten:function(a,b){return JW.Color.gradient(a,"white",b)},gradient:function(d,c,b){d=JW.Color.rgb(d);c=JW.Color.rgb(c);for(var a=0;a<3;++a){d[a]+=(c[a]-d[a])*b}return d},multiGradient:function(g,f){var e;for(e=0;e<g.length;++e){if(f<g[e][0]){break}}if(e==0){return g[0][1]}if(e==g.length){return g[e-1][1]}var d=g[e-1];var c=g[e];return JW.Color.gradient(d[1],c[1],(f-d[0])/(c[0]-d[0]))},fg:function(a){var a=JW.Color.rgb(a);return(a[0]+a[1]+a[2]>=384)?[0,0,0]:[255,255,255]},_parseArray:function(a){for(var b=0;b<3;++b){if(!JW.isInt(a[b])||(a[b]<0)||(a[b]>255)){return null}}return a},_suggestArray:function(b){var a=[];for(var c=0;c<3;++c){a[c]=Math.round(Math.max(0,Math.min(255,b[c])))}return a}};FL.Data=function(){FL.Data._super.call(this);this.map=null;this.bases=new JW.Set();this.units=new JW.ObservableArray();this.logEvent=new JW.Event();this.lostEvent=new JW.Event();this.nextPlayerEvent=new JW.Event();this.turn=1;this.player=0;this.animationManager=this.own(new FL.Data.AnimationManager(this));this._generateMap()};JW.extend(FL.Data,JW.Class,{createBase:function(b,a){var c=new FL.Base(b,a);this.bases.add(c);this.map.getCell(b).base=c;if(a==0){this.reveal(b,FL.baseSightRangeSqr)}return c},destroyBase:function(a){this.bases.remove(a);this.map.getCell(a.ij).setBase(null);a.destroy();if(this.bases.count(JW.byValue("player",a.player))===0){this.lostEvent.trigger(a.player)}},createUnit:function(b,a,c,e){var d=new FL.Unit(this,b,a,c,e);this.units.add(d);if(a==0){this.reveal(b,d.getSightRangeSqr())}return d},destroyUnit:function(a){this.units.removeItem(a);a.destroy()},moveUnit:function(f,e){if(!f.ijTarget){return}if(FL.Vector.equal(f.ij.get(),f.ijTarget)){f.ijTarget=null;return}var g=this.getPath(f.ij.get(),f.ijTarget,f.player);if(!g){f.ijTarget=null;return}f.hold=false;f.skipped=false;if(!e||!JW.Array.some(e,JW.byField())){e=JW.Array.map(f.persons.get(),function(){return true})}if(!JW.Array.every(e,JW.byField())){f=f.split(e)}var a=JW.Array.count(e,JW.byField());for(var d=0;(d<g.length)&&f.movement.get();++d){var c=FL.Vector.add(f.ij.get(),FL.dir8[g[d]]);if(!this.isPassable(c)){break}var h=f.cell;var b=this.map.getCell(c);if(b.unit){if((b.unit.player!==f.player)&&FL.Vector.equal(c,f.ijTarget)&&(f.type.damage!==0)){this.fightUnit(f,b.unit)}else{if((b.unit.player===f.player)&&(b.unit.type===f.type)&&(b.unit.getCount()+a<=f.type.capacity)&&FL.Vector.equal(c,f.ijTarget)){f.decreaseMovement();f.ij.set(c);break}}f.ijTarget=null;break}if(b.base&&(b.base.player!==f.player)){if(FL.Vector.equal(c,f.ijTarget)&&(f.type.damage!==0)){this.fightBase(f,b.base)}f.ijTarget=null;break}f.decreaseMovement();f.ij.set(c)}if(f.ijTarget&&FL.Vector.equal(f.ij.get(),f.ijTarget)){f.ijTarget=null}if((f.cell.unit!=null)&&(f.cell.unit!==f)&&f.alive){f.cell.unit.merge(f.persons.get());this.destroyUnit(f)}},moveUnits:function(a){this.units.$filter(JW.byValue("player",a)).each(function(b){this.moveUnit(b)},this)},fightUnit:function(d,c){var b=JW.Array.map(d.persons.get(),JW.byMethod("clone"));var f=JW.Array.map(c.persons.get(),JW.byMethod("clone"));var g=1+(c.cell.hill?1:0);var a=JW.Array.count(b,JW.byField("attack"));var e=JW.Array.count(f,JW.byField("defend"));while((a!==0)&&(f.length!==0)){--a;FL.fight(d.type.damage,g,f)}while((e!==0)&&(b.length!==0)){--e;FL.fight(c.type.damage,0,b)}d.setPersons(b);c.setPersons(f);d.retainAttacks(a);c.retainDefends(e)},fightBase:function(b,d){var c=[d.toPerson()];var a=JW.Array.count(b.persons.get(),JW.byField("attack"));while((a!==0)&&(c.length!==0)){--a;FL.fight(b.type.damage,0,c)}if(c.length===0){this.destroyBase(d);this.resetMining()}else{d.health.set(c[0].health)}b.retainAttacks(a)},endTurn:function(){if(this.player===0){this.log("End turn")}this.moveUnits(this.player);this.animationManager.startSequentialAnimation()},nextPlayer:function(){this._endTurnPlayer(this.player);this.player=(this.player+1)%2;if(this.player===0){++this.turn;this.log("Turn "+this.turn)}this.units.$filter(JW.byValue("player",this.player)).each(JW.byMethod("heal"));this.bases.$filter(JW.byValue("player",this.player)).each(JW.byMethod("heal"));this.nextPlayerEvent.trigger();if(this.player!==0){FL.AI.process(this,this.player);this.endTurn()}},_endTurnPlayer:function(a){this.units.$filter(JW.byValue("player",a)).each(JW.byMethod("refresh"));this.resetVision();this._produce(a)},reveal:function(b,a){this.map.eachWithin(b,a,JW.byMethod("reveal"))},resetVision:function(){for(var b=0;b<this.map.size;++b){for(var a=0;a<this.map.size;++a){this.map.getCell([b,a]).hide()}}this.bases.each(function(c){if(c.player===0){this.reveal(c.ij,FL.baseSightRangeSqr)}},this);this.units.each(function(c){if(c.player===0){this.reveal(c.ij.get(),c.getSightRangeSqr())}},this)},resetMining:function(){var b=new FL.Matrix(this.map.size);this.bases.each(function(g){g.mining=0;g.resources=[];this.map.eachWithin(g.ij,FL.baseMiningRangeSqr,function(h,i){if(h.rock){return}var j=b.getCell(i);if(!j){b.setCell(i,g);return}if(FL.Vector.lengthSqr(FL.Vector.diff(i,j.ij))>FL.Vector.lengthSqr(FL.Vector.diff(i,g.ij))){b.setCell(i,g);return}},this)},this);for(var e=0;e<this.map.size;++e){for(var c=0;c<this.map.size;++c){var d=[e,c];var f=b.getCell(d);this.map.getCell(d).setMiningBase(f);if(!f){continue}var a=this.map.getCell(d);if(a.resource){f.resources.push(a.resource)}if(a.rock){continue}f.mining+=a.hill?2:1;if(a.resource&&a.resource.bonus){f.mining+=a.resource.bonus}}}},buildBase:function(a){this.createBase(a.ij.get(),a.player);this.destroyUnit(a);this.resetMining()},isBaseBuildable:function(a,b){if(!this.isPassable(a)){return false}if(this.map.getCell(a).resource){return false}b=b||FL.minBaseDistanceSqr;return this.bases.every(function(c){return FL.Vector.lengthSqr(FL.Vector.diff(a,c.ij))>=b},this)},isPassable:function(a){return this.map.inMatrix(a)&&!this.map.getCell(a).rock},isDroppable:function(b,c){var a=this.map.getCell(b);if(!this.isPassable(b)||a.unit||(a.base&&a.base.player!==c)){return false}if((c===0)&&!a.visible){return false}return true},isChoke:function(c){var a=FL.getIjs8(c);if(this.isPassable(a[0])&&!this.isPassable(a[2])&&this.isPassable(a[4])&&!this.isPassable(a[6])){return true}if(!this.isPassable(a[0])&&this.isPassable(a[2])&&!this.isPassable(a[4])&&this.isPassable(a[6])){return true}for(var e=0;e<8;e+=2){if(!this.isPassable(a[e])&&this.isPassable(a[e+1])&&!this.isPassable(a[(e+2)%8])){for(var b=3;b<8;++b){if(this.isPassable(a[(e+b)%8])){return true}}}}return false},isByEnemy:function(b,a){return this.map.someWithin8(b,1,function(c){return c.unit&&(c.unit.player!==a)},this)},revealEnemies:function(b,a){var c=this.map.someWithin8(b,1,function(d){return d.unit&&(d.unit.player!==a)&&d.unit.visible},this);if(c){return false}this.map.everyWithin8(b,1,function(d){if(d.unit){d.reveal()}},this);return true},getPath:function(m,b,n){if(FL.Vector.equal(m,b)){return[]}var g=[m];var i=0;var a=new FL.Matrix(this.map.size);a.setCell(m,true);while(i<g.length){var f=g[i++];for(var j=0;j<FL.dir8.length;++j){var e=(j<4)?(2*j):(2*j-7);var h=FL.Vector.add(f,FL.dir8[e]);if(!this.map.inMatrix(h)||(a.getCell(h)!=null)){continue}var l=this.map.getCell(h);if((n!==0)||l.scouted){if(!this.isPassable(h)){continue}}if((n!==0)||l.visible){var k=l.unit;if(k&&!FL.Vector.equal(h,b)){continue}if(!k&&this.isByEnemy(f,n)&&this.isByEnemy(h,n)){continue
}var c=l.base;if(c&&(c.player!==n)&&!FL.Vector.equal(h,b)){continue}}g.push(h);a.setCell(h,e);if(FL.Vector.equal(h,b)){return this._backtracePath(a,b)}}}return null},log:function(b,a){this.logEvent.trigger([b,a])},isControllable:function(){return(this.player===0)&&!this.animationManager.sequential},_generateMap:function(){this.map=new FL.Matrix(FL.mapSize);for(var d=0;d<FL.mapSize;++d){for(var b=0;b<FL.mapSize;++b){var c=[d,b];var a=new FL.Cell(c);this.map.setCell(c,a)}}this._generateRocks();this._generateResources();this._generateBases();this.resetMining();this.bases.each(function(e){this.map.eachWithin(e.ij,FL.baseMiningRangeSqr,function(g){if(g.resource){if(g.resource.deniedAtStart){this._generateResource(g.resource);g.resource=null}else{if(g.resource.bonus&&(e.mining-g.resource.bonus>=20)){e.mining-=g.resource.bonus;g.resource=null}}}},this);var f;if(e.mining<20){f="aluminum"}else{if(e.mining<24){f="oil"}else{if(e.mining<26){f="iron"}else{if(e.mining<30){f="copper"}else{return}}}}this.map.eachWithin(e.ij,2,function(g){if(f&&!g.resource){g.resource=FL.Resource.types[f];f=null}},this)},this);this.resetMining()},_generateRocks:function(){for(var f=0;f<FL.rockCount;++f){var l,b;do{l=this.map.ijRandom();b=this.isPassable(l)&&!this.isChoke(l)}while(!b);var e=[];var a=JW.inScope(function(i){if(!this.isPassable(i)||this.isChoke(i)){return}e.push(i);this.map.getCell(i).rock=true;for(var m=0;m<4;++m){var j=FL.Vector.add(i,FL.dir4[m]);if(this.map.inMatrix(j)&&(Math.random()<FL.rockHillChance)){this.map.getCell(j).hill=true}}},this);a(l);var k=FL.random(FL.rockDensity);for(var c=0;c<k;++c){var h=FL.random(4);var g=FL.Vector.add(e[FL.random(e.length)],FL.dir4[h]);a(g)}}},_generateResources:function(){JW.Array.each(FL.Resource.typeArray,function(b){for(var a=0;a<b.count;++a){this._generateResource(b)}},this)},_generateResource:function(c){var b;do{b=this.map.ijRandom();var a=this.map.getCell(b)}while(a.rock||a.resource||a.miningBase||this._isResourceTooClose(c,b));a.resource=c},_isResourceTooClose:function(c,b){if(!c.minDistanceSqr){return false}var a=false;this.map.eachWithin(b,c.minDistanceSqr,function(d){a=a||(d.resource===c)},this);return a},_generateBases:function(){for(var a=0;a<FL.playerCount;++a){var l;while(true){l=this.map.ijRandom();if(!this.isBaseBuildable(l,FL.minMainBaseDistanceSqr)){continue}var f=this.map.ijCenter();var h=FL.Vector.diff(l,f);var g=FL.Vector.length8(h);if(g<FL.minMainBaseCenterDistance){continue}var m=this.map.size/2-g;if(m<FL.minMainBaseSideDistance){continue}break}for(var c=-1;c<=1;++c){for(var b=-1;b<=1;++b){var k=this.map.getCell(FL.Vector.add(l,[c,b]));if(k){k.rock=false}}}this.createBase(l,a).health.set(1);for(var e=0;e<4;++e){this.createUnit(FL.Vector.add(l,FL.dir4[e]),a,FL.Unit.types.militia,"patrol")}}},_backtracePath:function(c,a){var b=[];while(true){var e=c.getCell(a);if(e===true){b.reverse();return b}b.push(e);a=FL.Vector.diff(a,FL.dir8[e])}},_produce:function(a){this.bases.each(function(e){if(e.player!==a){return}var c=e.unitType.get();if(!c){return}var d=(a===0)?1:FL.AI.productionCoef;var f=e.production[c.id]+e.overflow+Math.round(d*e.mining);var b=this.map.getCell(e.ij);if(f<c.cost){e.production[c.id]=Math.min(f,c.cost);e.overflow=0;return}if(!b.unit){this.createUnit(e.ij,e.player,c,e.unitBehaviour)}else{if((b.unit.type===e.unitType.get())&&(b.unit.getCount()<b.unit.type.capacity)){b.unit.merge([new FL.Unit.Person(b.unit.type)])}else{return}}e.production[c.id]=0;e.overflow=f-c.cost;e.unitType.set(null);e.unitBehaviour=null},this)}});FL.Data.AnimationManager=function(a){FL.Data.AnimationManager._super.call(this);this.data=a;this.animationQueue=[];this.sequential=false;this.lastHit=new Date().getTime();this.timer=this.own(new JW.Property(new JW.Interval(this._onInterval,this,17))).ownValue();this.success=true};JW.extend(FL.Data.AnimationManager,JW.Class,{enqueue:function(a){if(!JW.Array.containsItem(this.animationQueue,a)){this.animationQueue.push(a)}},startSequentialAnimation:function(){this.sequential=true},animate:function(){if(!this.success){this.timer.set(null);return}this.success=false;if(!this.sequential){this.animateAll()}else{if(this.data.player===0){this.animateAll()}else{this.animateSingle()}if(this.animationQueue.length===0){this.sequential=false;this.data.nextPlayer()}}this.success=true},animateSingle:function(){while(this.animationQueue.length){var a=this.animationQueue[0];if(this._animateUnit(a)){this.animationQueue.shift()}else{break}}},animateAll:function(){var b=this.animationQueue;this.animationQueue=[];for(var c=0,a=b.length;c<a;++c){var d=b[c];if(!this._animateUnit(d)){this.animationQueue.push(d)}}},_animateUnit:function(a){while(a.animations.length){var b=a.animations[0];if(!b.animate()){return false}a.animations.shift();if(!b.immediate){return false}}return true},_onInterval:function(){var a=new Date().getTime();while(this.lastHit<a){this.lastHit+=1000/FL.animationStepsPerSecond;this.animate()}}});FL.El={xy:function(b,a){b.css({left:a[1]+"px",top:a[0]+"px"})},size:function(b,a){b.css({width:a[1]+"px",height:a[0]+"px"})}};FL.Matrix=function(b){FL.Matrix._super.call(this);this.size=b;this.cells=new Array(b);for(var a=0;a<b;++a){this.cells[a]=new Array(b)}};JW.extend(FL.Matrix,JW.Class,{getCell:function(a){return JW.get(this.cells,a)},setCell:function(a,b){this.cells[a[0]][a[1]]=b},inMatrix:function(a){return(a[0]>=0)&&(a[0]<this.size)&&(a[1]>=0)&&(a[1]<this.size)},ijRandom:function(){return[FL.random(this.size),FL.random(this.size)]},ijCenter:function(){return FL.Vector.mult([this.size,this.size],0.5)},getRect:function(a,b){return{iMin:Math.max(0,a[0]-b),iMax:Math.min(this.size-1,a[0]+b),jMin:Math.max(0,a[1]-b),jMax:Math.min(this.size-1,a[1]+b)}},eachWithin:function(c,a,h,k){var b=Math.ceil(Math.sqrt(a));var f=this.getRect(c,b);for(var e=f.iMin;e<=f.iMax;++e){for(var d=f.jMin;d<=f.jMax;++d){var g=[e,d];if(FL.Vector.lengthSqr(FL.Vector.diff(g,c))<=a){h.call(k||this,this.getCell(g),g)}}}},everyWithin8:function(d,h,g,e){var f=this.getRect(d,h);for(var c=f.iMin;c<=f.iMax;++c){for(var a=f.jMin;a<=f.jMax;++a){var b=[c,a];if(g.call(e||this,this.getCell(b),b)===false){return false}}}return true},someWithin8:function(a,d,c,b){return !this.everyWithin8(a,d,function(){return !c.apply(this,arguments)},b)}});FL.Monitor=function(a){FL.Monitor._super.call(this);this.data=a;this.cellSelect=null;this.cellAnimation=this.own(new JW.Property()).ownValue();this.endTurnAnimation=this.own(new JW.Property()).ownValue();this.panel=this.own(new JW.Property()).ownValue();this.selectionQueue=[];this.selectionTail=0;this.baseExitAttachment=this.own(new JW.Property()).ownValue();this.order=null;this.cells=new FL.Matrix(this.data.map.size);this.unitSelection=[];this.own(this.data.nextPlayerEvent.bind(this._onNextPlayer,this))};JW.extend(FL.Monitor,JW.UI.Component,{renderNext:function(a){a.click(JW.inScope(function(){this.selectNext()},this))},renderEndTurn:function(a){a.click(JW.inScope(function(){if(!this.data.isControllable()){return}this.selectionQueue=[];this.endTurnAnimation.set(null);this.selectCell(null);this.data.endTurn();this.updateMap()},this))},renderLog:function(a){this.data.logEvent.bind(function(b){var c=jQuery('<div class="fl-message"></div>');c.text(b[0]);if(b[1]){c.addClass(b[1])}a.append(c);a.scrollTop(1000000)},this)},renderCells:function(f){f.mousedown(JW.inScope(this._onMapMouseDown,this));var g=this.data.map;for(var e=0;e<g.size;++e){var c=jQuery('<div class="fl-monitor-row"></div>');for(var b=0;b<g.size;++b){var d=[e,b];var a=jQuery('<div class="fl-monitor-cell"></div>');this.cells.setCell(d,a);a.attr("fl-i",e);a.attr("fl-j",b);this._updateCell(a,d);c.append(a)}c.append('<div class="fl-clear"></div>');f.append(c)}},renderUnits:function(){return this.data.units.createMapper({createItem:function(a){return new FL.UnitView(a)},destroyItem:JW.destroy,scope:this}).target},renderPanel:function(){return this.panel},afterRender:function(){this._super();this.selectNext()},selectCell:function(b){if(!this.data.isControllable()){b=null
}this.resetOrder();if(this.cellSelect){this.cellAnimation.set(null)}this.baseExitAttachment.set(null);this.unitSelection=[];this.cellSelect=b?this.data.map.getCell(b):null;if(this.cellSelect){var a=this._getCell(b).children(".fl-border");this.cellAnimation.set(new FL.AlternateAnimation({updater:function(d){a.css("background","rgba(255, 255, 255, "+d.toFixed(2)+")")},finish:function(){a.css("background","")},scope:this}));var c=this.cellSelect.base;if(this._isBaseAutoSelectable(c)){this.baseExitAttachment.set(c.unitType.changeEvent.bind(this.selectNext,this))}if(this.cellSelect.unit&&(this.cellSelect.unit.player===0)){this.unitSelection=JW.Array.map(this.cellSelect.unit.persons.get(),function(){return false})}this.panel.set(new FL.Panel(this,this.cellSelect))}else{this.panel.set(null)}},selectNext:function(){if(!this.data.isControllable()){this.selectCell(null);return}while(this.selectionTail<this.selectionQueue.length){var a=this.data.map.getCell(this.selectionQueue[this.selectionTail++]);var b=this._isUnitAutoSelectable(a.unit);var c=this._isBaseAutoSelectable(a.base);if(b||c){this.selectCell(a.ij);return}}this._refreshSelectionQueue();if(this.selectionQueue.length){this.selectCell(this.selectionQueue[this.selectionTail++]);return}this.data.moveUnits(0);this.updateMap();this._refreshSelectionQueue();if(this.selectionQueue.length){this.selectCell(this.selectionQueue[this.selectionTail++]);return}this.selectCell(null);this.endTurnAnimation.set(new FL.ButtonAnimation(this.getElement("end-turn")))},updateMap:function(e){var f=this.data.map;for(var d=0;d<f.size;++d){for(var b=0;b<f.size;++b){var c=[d,b];var a=this.data.map.getCell(c);if(e||a.invalid){this._updateCell(this._getCell(c),c)}}}},initOrder:function(a){this.selectCell(null);this.order=a;this.getElement("cells").addClass("fl-order-active");for(var d=0;d<this.data.map.size;++d){for(var b=0;b<this.data.map.size;++b){var c=[d,b];if(!this.order.test.call(this.order.scope||this,c)){this._getCell(c).append('<div class="fl-order-overlay"></div>')}}}this.panel.set(new FL.Panel.Order())},resetOrder:function(){if(!this.order){return}var a=this.order;this.order=null;this.getElement("cells").removeClass("fl-order-active");this.getElement("cells").find(".fl-order-overlay").remove();if(a.finish){a.finish.call(a.scope||this)}},_getCell:function(a){return this.cells.getCell(a)},_updateCell:function(a,h){a=a||this._getCell(h);var i=this.data.map.getCell(h);i.invalid=false;a.empty();a.toggleClass("fl-scouted",i.scouted);a.toggleClass("fl-visible",i.visible);a.toggleClass("fl-rock",i.rock);a.toggleClass("fl-hill",i.hill);if(i.miningBase){a.attr("fl-player",i.miningBase.player);a.append('<div class="fl-mining"></div>')}else{a.removeAttr("fl-player")}var c=jQuery('<div class="fl-border"></div>');c.toggleClass("fl-hold",(i.unit!=null)&&i.unit.hold&&(i.unit.player===0));for(var g=0;g<4;++g){var f=FL.Vector.add(i.ij,FL.dir4[g]);var b=this.data.map.getCell(f);c.toggleClass("fl-border-"+g,b&&!b.rock&&!i.rock&&i.miningBase&&(b.miningBase!==i.miningBase)&&(b.miningBase?(i.miningBase._iid>b.miningBase._iid):true))}a.append(c);if(i.resource){var e=jQuery('<div class="fl-resource"></div>');e.attr("fl-type",i.resource.id);a.append(e)}if(i.base){var j=jQuery('<div class="fl-base"></div>');j.attr("fl-player",i.base.player);a.append(j)}if(i.scouted&&!i.visible){a.append('<div class="fl-fog"></div>')}},_onNextPlayer:function(){this.updateMap();this.selectNext()},_onMapMouseDown:function(c){c.preventDefault();var a=jQuery(c.target);if(!a.hasClass("fl-monitor-cell")){a=a.parents(".fl-monitor-cell").eq(0)}if(!a.hasClass("fl-monitor-cell")){return}var b=[+a.attr("fl-i"),+a.attr("fl-j")];switch(c.which){case 1:this._onLeftMouseDown(a,b);break;case 3:this._onRightMouseDown(a,b);break}},_onLeftMouseDown:function(a,b){this.selectCell(b)},_onRightMouseDown:function(a,b){if(!this.data.isControllable()){return}if(this.order){if(!this.order.test.call(this.order.scope||this,b)){return}this.order.execute.call(this.order.scope||this,b);this.resetOrder();this.selectNext();return}if(!this.cellSelect){return}var c=this.cellSelect.unit;if(!c||(c.player!==0)){return}var d=FL.Vector.length8(FL.Vector.diff(b,c.ij.get()));if(d===0){c.ijTarget=null;this.selectNext();return}if(d===1){if(this.data.isByEnemy(c.ij.get(),0)&&this.data.isByEnemy(b,0)){if(this.data.revealEnemies(b,0)){this.updateMap();return}}}c.ijTarget=b;this.data.moveUnit(c,this.unitSelection);this.updateMap();if(c.alive&&c.movement.get()){this.selectCell(c.ij.get())}else{this.selectNext()}},_refreshSelectionQueue:function(){this.selectionQueue=[];this.selectionTail=0;this.data.units.each(function(a){if(this._isUnitAutoSelectable(a)){this.selectionQueue.push(a.ij.get())}},this);this.data.bases.each(function(b){var a=JW.Array.some(this.selectionQueue,function(c){return FL.Vector.equal(c,b.ij)},this);if(!a&&this._isBaseAutoSelectable(b)){this.selectionQueue.push(b.ij)}},this)},_isUnitAutoSelectable:function(a){return a&&(a.player===0)&&(a.movement.get()!==0)&&!a.hold&&!a.skipped&&!a.ijTarget},_isBaseAutoSelectable:function(a){return a&&(a.player===0)&&(a.unitType.get()==null)}});JW.UI.template(FL.Monitor,{main:'<div jwclass="fl-monitor"><div jwid="left-panel"><div jwid="buttons"><button jwid="next">Next unit/base</button> <button jwid="end-turn">End turn</button></div><div jwid="log"></div><div jwid="help"><div>Left mouse button - select unit or base.</div><div>Right mouse button - move unit.</div><div>&nbsp;</div><div>Units can\'t move from a tile near an enemy unit to another tile near an enemy unit. You must retreat, fight or defend in this case.</div><div>&nbsp;</div><div>Two units can\'t share the same tile. Beware: your base can\'t produce a unit if the tile is taken by another unit.</div></div></div><div jwid="map"><div jwid="cells"></div><div jwid="units"></div></div><div jwid="panel"></div><div class="fl-clear"></div></div>'});FL.Panel=function(b,a){FL.Panel._super.call(this);this.monitor=b;this.cell=a};JW.extend(FL.Panel,JW.UI.Component,{renderTerrainName:function(a){if(!this.cell.scouted){}else{if(this.cell.rock){a.text("Mountain")}else{if(this.cell.hill){a.text("Hill")}else{a.text("Plain")}}}},renderTerrainDescription:function(a){if(!this.cell.scouted){a.text("This area is not scouted yet.")}else{if(this.cell.rock){a.text("Doesn't make production. Units can not pass.")}else{if(this.cell.hill){a.text("Improves defense and sight. Production: 2.")}else{a.text("Increases production by 1.")}}}},renderResourceName:function(a){if(this.cell.scouted&&this.cell.resource){a.text(this.cell.resource.name)}},renderResourceDescription:function(a){if(this.cell.scouted&&this.cell.resource){a.html(this.cell.resource.descriptionHtml)}},renderUnit:function(){if(this.cell.visible&&this.cell.unit){return this.own(new FL.Panel.Unit(this.monitor,this.cell.unit))}},renderBase:function(){if(this.cell.visible&&this.cell.base&&(this.cell.base.player===0)){return this.own(new FL.Panel.Base(this.cell.base))}}});JW.UI.template(FL.Panel,{main:'<div jwclass="fl-panel"><div jwid="terrain block"><div jwid="terrain-name" class="fl-title"></div><div jwid="terrain-description"></div></div><div jwid="resource block"><div jwid="resource-name" class="fl-title"></div><div jwid="resource-description"></div></div><div jwid="unit block"></div><div jwid="base block"></div></div>'});FL.Panel.Base=function(a){FL.Panel.Base._super.call(this);this.base=a};JW.extend(FL.Panel.Base,JW.UI.Component,{renderDefense:function(a){var b=this.base.health.get();a.html(((b===1)?('<span class="fl-good">'+FL.baseArmor+"</span>"):('<span class="fl-bad">'+(FL.baseArmor*b).toFixed(1)+"</span>"))+"/"+FL.baseArmor)},renderMining:function(a){a.text(this.base.mining)},renderUnits:function(){return JW.Array.$map(FL.Unit.typeArray,function(a){return this.own(new FL.Panel.UnitButton(this.base,a))},this)},renderProduction:function(){return this.own(new JW.Mapper([this.base.unitType],{createValue:function(a){return new FL.Panel.Production(this.base)},destroyValue:JW.destroy,scope:this})).target
}});JW.UI.template(FL.Panel.Base,{main:'<div jwclass="fl-panel-base"><div class="fl-title">Base defense: <span jwid="defense"></span></div><div class="fl-title">Production: <span jwid="mining"></span></div><div jwid="units"></div><div jwid="production"></div></div>'});FL.Panel.Order=function(){FL.Panel.Order._super.call(this)};JW.extend(FL.Panel.Order,JW.UI.Component,{renderRoot:function(a){a.text("Right mouse button - issue order")}});FL.Panel.Production=function(a){FL.Panel.Production._super.call(this);this.base=a;this.type=this.base.unitType.get()};JW.extend(FL.Panel.Production,JW.UI.Component,{progressWidth:200,renderProgress:function(a){a.css("width",this.progressWidth+"px")},renderProgressFill:function(b){var c=this.base.overflow+this.base.production[this.type.id];var a=Math.min(1,c/this.type.cost);b.css("width",Math.floor(this.progressWidth*a)+"px")},renderUnit:function(){return this.own(new FL.UnitInfo(this.type,this.base.player,true))}});JW.UI.template(FL.Panel.Production,{main:'<div jwclass="fl-panel-production"><div jwid="progress"><div jwid="progress-fill"></div></div><div jwid="unit"></div></div>'});FL.Panel.Unit=function(a,b){FL.Panel.Unit._super.call(this);this.monitor=a;this.unit=b};JW.extend(FL.Panel.Unit,JW.UI.Component,{renderHeader:function(){return this.own(new FL.UnitInfo.Header(this.unit.type,this.unit.player))},renderPersons:function(){return JW.Array.$map(this.unit.persons.get(),function(b,a){return this.own(new FL.Panel.UnitPerson(this.unit,this.monitor.unitSelection,a))},this)},renderButtons:function(a){return this.unit.player===0},renderHold:function(a){if(!this.unit.isHealed()){this.own(new FL.ButtonAnimation(a));a.text("Heal")}a.click(JW.inScope(function(){this.unit.hold=true;this.monitor._updateCell(null,this.unit.ij.get());this.monitor.selectNext()},this))},renderSkip:function(a){a.click(JW.inScope(function(){this.unit.hold=false;this.unit.skipped=true;this.monitor._updateCell(null,this.unit.ij.get());this.monitor.selectNext()},this))},renderBuild:function(a){if((this.unit.type.id!=="mcv")||(this.unit.movement.get()===0)){return false}if(!this.monitor.data.isBaseBuildable(this.unit.ij.get(),FL.minBaseDistanceSqr)){return false}this.own(new FL.ButtonAnimation(a));a.click(JW.inScope(function(){this.monitor.data.buildBase(this.unit);this.monitor.updateMap();this.monitor.selectCell(this.unit.ij.get())},this))},renderDrop:function(a){if(!this.unit.type.paradroppable||(this.unit.movement.get()===0)){return false}if(!this.unit.cell.miningBase||(this.unit.cell.miningBase.player!==this.unit.player)){return false}if(!this.unit.cell.resource||(this.unit.cell.resource.id!=="airport")){return false}this.own(new FL.ButtonAnimation(a));a.click(JW.inScope(function(){var c=this.unit;var b=this.monitor;var d=this.monitor.data;b.getElement("cells").addClass("fl-order-paradrop");this.monitor.initOrder({test:function(e){return d.isDroppable(e,0)},execute:function(e){c.decreaseMovement();c.ijTarget=null;c.ij.set(e);b.updateMap()},finish:function(){b.getElement("cells").removeClass("fl-order-paradrop")},scope:this})},this))},renderStats:function(){return this.own(new FL.UnitInfo.Stats(this.unit.type,false))}});JW.UI.template(FL.Panel.Unit,{main:'<div jwclass="fl-panel-unit"><div jwid="title" class="fl-title">Army</div><div jwid="header"></div><div jwid="persons"></div><div jwid="buttons"><button jwid="skip">Skip turn</button> <button jwid="hold">Hold position</button> <button jwid="build">Build base</button> <button jwid="drop">Paradrop</button></div><div jwid="stats"></div></div>'});FL.Panel.UnitButton=function(b,a){FL.Panel.UnitButton._super.call(this);this.base=b;this.type=a};JW.extend(FL.Panel.UnitButton,JW.UI.Component,{renderRoot:function(a){a.click(JW.UI.preventDefault);a.attr("fl-type",this.type.id);if(this.base.isUnitTypeAvailable(this.type)){a.attr("title","Produce "+this.type.name+" (cost: "+this.type.cost+")");a.attr("fl-player",this.base.player);a.click(JW.inScope(function(c){this.base.unitType.set(this.type)},this))}else{var b=JW.Array.map(this.type.resources,function(c){return FL.Resource.types[c].name},this);a.attr("title",this.type.name+" requires "+b.join(", "))}}});JW.UI.template(FL.Panel.UnitButton,{main:'<a href="#" class="fl-panel-unitbutton fl-unit blocklink"></a>'});FL.Panel.UnitPerson=function(c,b,a){FL.Panel.UnitPerson._super.call(this);this.unit=c;this.selection=b;this.index=a;this.person=c.persons.get()[a]};JW.extend(FL.Panel.UnitPerson,JW.UI.Component,{healthWidth:60,renderRoot:function(a){if(this.unit.player!==0){return}a.toggleClass("fl-selected",this.selection[this.index]);a.mousedown(JW.UI.preventDefault);a.click(JW.inScope(function(){this.selection[this.index]=!this.selection[this.index];a.toggleClass("fl-selected",this.selection[this.index])},this))},renderHealthValue:function(a){var b=this.person.health;a.text((this.unit.type.armor*b).toFixed(1));a.addClass((b===1)?"fl-good":"fl-bad")},renderHealth:function(a){a.css("width",this.healthWidth+"px")},renderHealthFill:function(a){a.css("width",Math.floor(this.healthWidth*this.person.health)+"px");a.css("background",FL.getHealthColor(this.person.health))},renderMovement:function(b){for(var a=this.unit.type.movement-1;a>=0;--a){b.append('<div class="fl-panel-unitperson-movement-point '+(a<this.person.movement?"fl-remaining":"fl-spent")+'"></div>')}},renderAttack:function(){return(this.unit.player===0)&&(this.unit.type.damage!==0)&&this.person.attack},renderDefend:function(){return(this.unit.player!==0)&&(this.unit.type.damage!==0)&&this.person.defend},renderFortified:function(){return(this.unit.type.defense!==0)&&this.person.fortified}});JW.UI.template(FL.Panel.UnitPerson,{main:'<div jwclass="fl-panel-unitperson"><div jwid="health-value" title="Unit armor"></div><div jwid="right"><div jwid="health" title="Unit armor"><div jwid="health-fill"></div></div><div jwid="status"><div jwid="movement" title="Movement points"></div><div jwid="fortified" title="This unit is fortified and has a defensive bonus"></div><div jwid="defend" title="This unit can strike in defense at this turn"></div><div jwid="attack" title="This unit can attack at this turn"></div><div class="clear"></div></div></div><div class="clear"></div></div>'});FL.PositionUpdater=function(a,b){FL.PositionUpdater._super.call(this);this.el=a;this.own(new JW.Updater([b],function(c){this.el.css({left:c[0]+"px",top:c[1]+"px"})},this))};JW.extend(FL.PositionUpdater,JW.Class);FL.Resource={initDescription:function(){JW.Array.each(FL.Resource.typeArray,function(c){var a="";if(c.description){a+=c.description+"<br>"}if(c.bonus){a+="Increases production by "+c.bonus+".<br>"}var b=JW.Array.filter(FL.Unit.typeArray,function(e){return(e.resources!=null)&&JW.Array.containsItem(e.resources,c.id)});if(b.length){var d=JW.Array.map(b,JW.byField("name"));a+="Required to produce units: "+d.join(", ")+"<br />"}c.descriptionHtml=a})}};FL.Resource.typeArray=[{id:"copper",name:"Copper",bonus:4,count:20,aiProfit:4},{id:"iron",name:"Iron",bonus:6,count:15,aiProfit:6},{id:"oil",name:"Oil",bonus:10,count:10,aiProfit:10},{id:"aluminum",name:"Aluminum",bonus:15,count:5,aiProfit:15},{id:"yard",name:"Advanced training yard",count:10,deniedAtStart:true,minDistanceSqr:30,aiProduction:true},{id:"light",name:"Light vehicle factory",count:10,deniedAtStart:true,minDistanceSqr:30,aiProduction:true},{id:"heavy",name:"Heavy vehicle factory",count:6,deniedAtStart:true,minDistanceSqr:50,aiProduction:true},{id:"airport",name:"Airport",description:"Drops paratroopers to any visible tile.",count:4,deniedAtStart:true,minDistanceSqr:100,aiProfit:8}];FL.Resource.types=JW.Array.index(FL.Resource.typeArray,JW.byField("id"));FL.ScreenWin=function(a){FL.ScreenWin._super.call(this);this.win=a;localStorage.wins=+(localStorage.wins||0);localStorage.losses=+(localStorage.losses||0);localStorage.wisdom=+(localStorage.wisdom||0)+1;if(a){localStorage.wins=+localStorage.wins+1}else{localStorage.losses=+localStorage.losses+1}};JW.extend(FL.ScreenWin,JW.UI.Component,{renderTitle:function(a){a.text(this.win?"You win!":"You lost...")
},renderWins:function(a){a.text(localStorage.wins)},renderLosses:function(a){a.text(localStorage.losses)},renderDifficulty:function(a){a.text(Math.round(FL.AI.productionCoef*100))},renderDifficultyModifier:function(a){if(this.win){a.text("+"+Math.round(FL.AI.productionCoefPerWin*100))}else{a.text("-"+Math.round(FL.AI.productionCoefPerLoss*100))}},renderClear:function(a){a.click(JW.inScope(function(b){b.preventDefault();localStorage.wins=0;localStorage.losses=0;this.getElement("wins").text(0);this.getElement("losses").text(0);this.getElement("difficulty").text(100);this.getElement("difficulty-modifier").text(0)},this))},renderWisdom:function(a){a.text(FL.ScreenWin.wisdoms[+localStorage.wisdom%FL.ScreenWin.wisdoms.length])}});FL.ScreenWin.wisdoms=["Soldiers usually win the battles and generals get the credit for it. -- Napoleon","The tragedy of war is that it uses man's best to do man's worst.","The Fourth World War will be fought with stones. -- Einstein","Diplomats are just as essential in starting a war as soldiers in finishing it. -- Rogers","There is no such thing as an inevitable war. If war comes it will be from failure of human wisdom. -- Law","Dictators ride to and from on tigers from which they dare not dismount. And the tigers are getting hungry. -- Churchill"];JW.UI.template(FL.ScreenWin,{main:'<div jwclass="fl-screen-win"><div jwid="title"></div><div jwid="statistics"><div><div jwid="statistics-left">Wins:</div><div jwid="statistics-right wins"></div><div class="fl-clear"></div></div><div><div jwid="statistics-left">Losses:</div><div jwid="statistics-right losses"></div><div class="fl-clear"></div></div><div><div jwid="statistics-left">Difficulty played:</div><div jwid="statistics-right"><span jwid="difficulty"></span>% (<span jwid="difficulty-modifier"></span>%)</div><div class="fl-clear"></div></div></div><a jwid="clear" class="fl-blocklink" href="#">Reset statistics and difficulty</a><div jwid="wisdom"></div><a jwid="refresh" class="fl-blocklink" href="javascript:location.reload()">Start again to find more wisdom</a></div>'});FL.Unit=function(e,b,a,c,d){FL.Unit._super.call(this);this.data=e;this.ij=this.own(new JW.Property(b));this.player=a;this.type=c;this.movement=this.own(new JW.Property(this.type.movement));this.cell=null;this.ijTarget=null;this.hold=false;this.skipped=false;this.behaviour=d||c.ai[FL.random(c.ai.length)];this.visible=false;this.persons=this.own(new JW.Property([new FL.Unit.Person(c)]));this.alive=true;this.xy=this.own(new JW.Property(FL.ijToXy(this.ij.get())));this.opacity=this.own(new JW.Property(0));this.animations=[];this.own(new JW.Switcher([this.ij],{init:function(g){this.cell=this.data.map.getCell(g);if(!this.cell.unit){this.cell.setUnit(this)}if(this.player===0){this.data.reveal(g,this.getSightRangeSqr())}var f=this.visible||this.cell.visible;this.visible=this.cell.visible;if(!f&&!this.animations.length){this.resetAnimation()}else{var h=f?new FL.Unit.MovementAnimation(this):new FL.Unit.JumpAnimation(this);this.animations.push(h);this.data.animationManager.enqueue(this)}},done:function(f){if(this.cell.unit===this){this.cell.setUnit(null)}},scope:this}))};JW.extend(FL.Unit,JW.Class,{destroy:function(){this.alive=false;this.movement.set(0);this._super()},resetAnimation:function(){this.animations=[];this.xy.set(FL.ijToXy(this.ij.get()));this.opacity.set(this.visible?1:0)},getCount:function(){return this.persons.get().length},getSightRangeSqr:function(){return this.cell.hill?this.type.sightRangeSqrHill:this.type.sightRangeSqr},merge:function(a){this.setPersons(a.concat(this.persons.get()));this.ijTarget=null},split:function(b){var a=[];var d=[];JW.Array.filter(this.persons.get(),function(f,e){if(!b||b[e]){a.push(f)}else{d.push(f)}},this);this.setPersons(d);var c=this.data.createUnit(this.ij.get(),this.player,this.type,this.behaviour);c.ijTarget=this.ijTarget;this.ijTarget=null;c.setPersons(a);return c},setPersons:function(a){if(a.length===0){this.data.destroyUnit(this)}else{this.persons.set(JW.Array.toSorted(a,JW.byField("health"),this,-1));this.movement.set(Math.min.apply(Math,JW.Array.map(a,JW.byField("movement"))))}},retainAttacks:function(a){this.setPersons(JW.Array.map(this.persons.get(),function(b){if(b.attack){if(a){--a}else{if(!this.type.blitz){b.attack=false}b.fortified=false;--b.movement}}return b},this))},retainDefends:function(a){if(this.type.cover){return}this.setPersons(JW.Array.map(this.persons.get(),function(b){if(b.defend){b.defend=(--a>=0)}return b},this))},decreaseMovement:function(){this.setPersons(JW.Array.map(this.persons.get(),function(a){a.decreaseMovement();return a},this))},isHealed:function(){return JW.Array.every(this.persons.get(),JW.byValue("health",1))},heal:function(){var a=this.isHealed();this.setPersons(JW.Array.map(this.persons.get(),JW.byMethod("heal")));if(!a&&this.isHealed()){this.hold=false}},refresh:function(){this.setPersons(JW.Array.map(this.persons.get(),JW.byMethod("refresh")));this.skipped=false}});FL.Unit.typeArray=[{id:"mcv",name:"Mobile Construction Vehicle",description:"Can build a new base.",damage:0,armor:5,defense:0,healRate:0.1,movement:1,sightRangeSqr:2,sightRangeSqrHill:5,cost:300,ai:["build"],capacity:1,aiPreferred:true},{id:"militia",name:'Militia "Meat shield"',description:"Weak defensive unit. Used for base defense in emergencies. Can be used for scouting in the early stages of the game. In the late game, can be used to slow down the enemy forces.",damage:1,armor:3,defense:1,healRate:0.1,movement:1,sightRangeSqr:2,sightRangeSqrHill:5,cost:50,ai:["patrol","hold"],capacity:10,aiPreferred:false},{id:"infantry",name:'Infantry "Cannon fodder"',description:"Spendable attacking unit. Can be used for early push and weakening the enemy defenses, but requires protection.",damage:2,armor:3,defense:0,healRate:0.1,movement:1,sightRangeSqr:2,sightRangeSqrHill:5,cost:65,ai:["patrol","attack"],capacity:10,aiPreferred:false},{id:"marine",name:'Marine "Hotheads"',description:"Strong defensive unit. Increased heal rate and low cost make them essential in the choke points protection.",damage:2,armor:4,defense:2,healRate:0.25,movement:1,sightRangeSqr:5,sightRangeSqrHill:10,cost:80,resources:["yard"],ai:["patrol","hold"],capacity:5,aiPreferred:true},{id:"paratrooper",name:'Paratrooper "Here\'s Jonny!"',description:"Strong attacking unit. Has very slow movement speed but can be paradropped to any visible point of the map from a secured airport.",damage:3,armor:5,defense:0,healRate:0.1,movement:1,sightRangeSqr:5,sightRangeSqrHill:10,cost:110,resources:["yard"],paradroppable:true,ai:["attack"],capacity:5,aiPreferred:true},{id:"humvee",name:'Hum-Vee "Us will not catch up"',description:"Low-armored, fast unit. High movement speed makes it essential in scouting, rushing enemy bases and supporting the main forces.",damage:2,armor:4,defense:0,healRate:0.1,movement:3,sightRangeSqr:5,sightRangeSqrHill:10,cost:80,resources:["light"],ai:["patrol","attack"],capacity:5,aiPreferred:true},{id:"radar",name:'Radar vehicle "Eye of Sauron"',description:"Strong defensive unit. High sight range lets it see the enemy forces from the distance and provide nasty drop locations for paratroopers.",damage:2,armor:5,defense:3,healRate:0.1,movement:2,sightRangeSqr:18,sightRangeSqrHill:27,bombRangeSqr:12,bombAttack:2,cost:125,resources:["light"],ai:["patrol"],capacity:5,aiPreferred:true},{id:"tank",name:'Tank "Shushpanzer"',description:"Powerful attacking unit. Has the highest damage and armor values among all units in the game. Can attack twice in one turn.",damage:4,armor:10,defense:0,healRate:0.1,movement:2,sightRangeSqr:8,sightRangeSqrHill:10,cost:200,resources:["heavy"],ai:["attack"],blitz:true,capacity:3,aiPreferred:true},{id:"mobile",name:'"Wunderwaffe" mobile site',description:"Powerful defensive unit. Has the highest defensive armor value among all units in the game. Can perform defensive strike multiple times in one turn.",damage:3,armor:8,defense:4,healRate:0.1,movement:2,sightRangeSqr:8,sightRangeSqrHill:10,cost:175,resources:["heavy"],ai:["patrol","attack"],cover:true,capacity:3,aiPreferred:true}];
FL.Unit.baseType={id:"base",name:"Base",damage:0,armor:10,defense:0,movement:0};FL.Unit.types=JW.Array.index(FL.Unit.typeArray,JW.byField("id"));FL.Unit.Animation=function(a){FL.Unit.Animation._super.call(this);this.unit=a};JW.extend(FL.Unit.Animation,JW.Class,{immediate:false});FL.Unit.JumpAnimation=function(a){FL.Unit.JumpAnimation._super.call(this,a);this.xyTo=FL.ijToXy(a.ij.get());this.opacityTo=a.visible?1:0};JW.extend(FL.Unit.JumpAnimation,FL.Unit.Animation,{immediate:true,animate:function(){this.unit.xy.set(this.xyTo);this.unit.opacity.set(this.opacityTo);return true}});FL.Unit.MovementAnimation=function(a){FL.Unit.MovementAnimation._super.call(this,a);this.xyFrom=null;this.opacityFrom=null;this.xyTo=FL.ijToXy(a.ij.get());this.opacityTo=a.visible?1:0;this.speed=this.animationsPerSecond*a.type.movement/FL.animationStepsPerSecond;this.progress=0;this.func=null;this.duration=0};JW.extend(FL.Unit.MovementAnimation,FL.Unit.Animation,{animationsPerSecond:4,animate:function(){if(!this.xyFrom){this.xyFrom=this.unit.xy.get();this.opacityFrom=this.unit.opacity.get();this.func=(this.unit.animations.length===1)?this._slowDownFunc:this._flatFunc;this.duration=(this.unit.animations.length===1)?2:1}this.progress=Math.min(this.duration,this.progress+this.speed);var a=this.func(this.progress);this.unit.xy.set(FL.Vector.between(this.xyFrom,this.xyTo,a));this.unit.opacity.set((1-a)*this.opacityFrom+a*this.opacityTo);return this.progress===this.duration},_slowDownFunc:function(a){return a-a*a/4},_flatFunc:function(a){return a}});FL.Unit.Person=function(a){FL.Unit.Person._super.call(this);this.type=a;this.health=1;this.movement=a?a.movement:0;this.attack=true;this.defend=true;this.fortified=false};JW.extend(FL.Unit.Person,JW.Class,{clone:function(){var a=new FL.Unit.Person(this.type);a.health=this.health;a.movement=this.movement;a.attack=this.attack;a.defend=this.defend;a.fortified=this.fortified;return a},decreaseMovement:function(){if(--this.movement===0){this.attack=false}this.fortified=false},heal:function(){if(!this.fortified){return this}var a=this.clone();a.health=FL.heal(this.health,this.type.healRate);return a},refresh:function(){var a=new FL.Unit.Person(this.type);a.health=this.health;a.fortified=(this.movement===this.type.movement);a.movement=this.type?this.type.movement:0;a.attack=true;a.defend=true;return a}});FL.UnitInfo=function(c,b,a){FL.UnitInfo._super.call(this);this.type=c;this.player=b||0;this.showCost=a||false};JW.extend(FL.UnitInfo,JW.UI.Component,{renderHeader:function(){return this.own(new FL.UnitInfo.Header(this.type,this.player))},renderStats:function(){return this.own(new FL.UnitInfo.Stats(this.type,this.showCost))}});JW.UI.template(FL.UnitInfo,{main:'<div jwclass="fl-unitinfo"><div jwid="header"></div><div jwid="stats"></div></div>'});FL.UnitInfo.Header=function(b,a){FL.UnitInfo.Header._super.call(this);this.type=b;this.player=a||0};JW.extend(FL.UnitInfo.Header,JW.UI.Component,{renderIcon:function(a){a.attr("fl-type",this.type.id);a.attr("fl-player",this.player)},renderName:function(a){a.text(this.type.name)}});JW.UI.template(FL.UnitInfo.Header,{main:'<div jwclass="fl-unitinfo-header"><div jwid="icon" class="fl-unit"></div> <span jwid="name"></span></div>'});FL.UnitInfo.Stats=function(b,a){FL.UnitInfo.Stats._super.call(this);this.type=b;this.showCost=a||false};JW.extend(FL.UnitInfo.Stats,JW.UI.Component,{renderDamageBox:function(){return this.type.damage!==0},renderDamage:function(a){a.text(this.type.damage)},renderArmorBox:function(){return this.type.armor!==0},renderArmor:function(a){a.text(this.type.armor)},renderDefenseBox:function(){return this.type.defense!==0},renderDefense:function(a){a.text(Math.round(100*this.type.defense/this.type.armor)+"%")},renderHealRate:function(a){a.text(Math.round(100*this.type.healRate)+"%")},renderMovement:function(a){a.text(this.type.movement)},renderCostBox:function(a){return this.showCost},renderCost:function(a){a.text(this.type.cost)},renderCapacity:function(a){a.text(this.type.capacity)},renderDescription:function(a){a.text(this.type.description)}});JW.UI.template(FL.UnitInfo.Stats,{main:'<div jwclass="fl-unitinfo-stats"><div title="Damage dealt to enemy unit in an attack or a defensive strike" jwid="damage-box" >Damage: <span jwid="damage"></span></div><div title="Maximum number of hit points" jwid="armor-box" >Armor: <span jwid="armor"></span></div><div title="Bonus to armor in defense, plus one if the unit is positioned on a hill, plus one if unit is fortified (i.e. didn\'t move last turn). So, this bonus can stack up to 3 times" jwid="defense-box">Defense bonus: <span jwid="defense"></span></div><div title="Number of hit points replenished per turn if unit doesn\'t move" jwid="heal-rate-box">Heal rate: <span jwid="heal-rate"></span></div><div title="Number of movement points" jwid="movement-box">Movement: <span jwid="movement"></span></div><div title="Total amount of production neccessary to spawn this unit in a base" jwid="cost-box">Cost: <span jwid="cost"></span></div><div  title="Maximum number of units in a stack. Stacked units fight together which makes them tougher and stronger" jwid="capacity-box">Stack limit: <span jwid="capacity"></span></div><div jwid="description"></div></div>'});FL.UnitView=function(a){FL.UnitView._super.call(this);this.unit=a};JW.extend(FL.UnitView,JW.UI.Component,{renderRoot:function(b){b.addClass("fl-unit fl-monitor-unit");b.attr("fl-type",this.unit.type.id);b.attr("fl-player",this.unit.player);this.own(new FL.PositionUpdater(b,this.unit.xy));this.own(new JW.UI.CssUpdater(b,"opacity",this.unit.opacity));this.own(new JW.Updater([this.unit.persons],function(c){b.html(JW.Array.map(c,function(e){var d=FL.getHealthColor(e.health);return('<div class="fl-monitor-unit-health"><div class="fl-monitor-unit-health-point" style="background-color: '+d+';"></div></div>')},this).join(""))},this));if(this.unit.player===0){var a=this.own(new JW.Functor([this.unit.movement],function(c){return c===0},this)).target;this.own(new JW.UI.ClassUpdater(b,"fl-moved",a))}}});FL.Vector={add:function(d,c){return[d[0]+c[0],d[1]+c[1]]},diff:function(d,c){return[d[0]-c[0],d[1]-c[1]]},mult:function(b,d){return[Math.round(d*b[0]),Math.round(d*b[1])]},equal:function(d,c){return(d[0]===c[0])&&(d[1]===c[1])},length:function(b){return Math.sqrt(FL.Vector.lengthSqr(b))},lengthSqr:function(b){return b[0]*b[0]+b[1]*b[1]},length8:function(b){return Math.max(Math.abs(b[0]),Math.abs(b[1]))},between:function(e,d,f){return FL.Vector.add(e,FL.Vector.mult(FL.Vector.diff(d,e),f))},round:function(b){return[Math.round(b[0]),Math.round(b[1])]},norm8:function(b){return[JW.sgn(b[0]),JW.sgn(b[1])]}};var data,app;jQuery(function(){FL.Resource.initDescription();data=new FL.Data();app=new FL.App(data);app.renderTo("body")});