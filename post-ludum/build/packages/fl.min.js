var FL={mapSize:32,cellSize:16,rockCount:15,rockDensity:30,rockHillChance:0.4,plainHillChance:0.04,playerCount:2,minBaseDistanceSqr:8,minMainBaseDistanceSqr:200,minMainBaseSideDistance:6,maxMainBaseSideDistance:8,baseHealRate:0.1,baseSightRangeSqr:12,baseArmor:10,baseMiningRangeSqr:5,animationStepsPerSecond:20,resourceEqualizeRange:7,resourceEqualizeSideBuff:10,dir4:[[0,1],[-1,0],[0,-1],[1,0]],dir8:[[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1]],sound:function(a){var b=new Audio();b.src="audio/"+a+".ogg";b.play()},random:function(a){return Math.floor(Math.random()*a)},getIjs4:function(b){var a=[];for(var c=0;c<4;++c){a.push(FL.Vector.add(b,FL.dir4[c]))}return a},getIjs8:function(b){var a=[];for(var c=0;c<8;++c){a.push(FL.Vector.add(b,FL.dir8[c]))}return a},fight:function(d,b,c){var a=0.001;var f=FL.random(c.length);var e=c[f];if(b&&e.fortified){++b}d/=e.type.armor+b*e.type.defense;if(e.health<=d+a){c.splice(f,1)}else{e.health-=d}},heal:function(c,b){var a=0.001;c+=b;return(1-c<a)?1:c},ijToXy:function(a){return[FL.cellSize*a[1],FL.cellSize*a[0]]},getHealthColor:function(a){return JW.Color.str(JW.Color.multiGradient([[0,"#600"],[0.2,"#B00"],[0.6,"#FF0"],[1,"#0B0"]],a))}};$.easing.easeOutQuad=function(a){return 1-Math.pow(1-a,2)};FL.AI=function(c,b){FL.AI._super.call(this);this.data=c;this.player=b;this.bases=c.bases.$toArray().filter(JW.byValue("player",b));this.stackCost=this.stackCostInitial+this.stackCostPerBase*this.bases.length;this.unitCount=JW.Map.map(FL.Unit.types,function(){return 0});this.totalUnitCount=JW.Map.map(FL.Unit.types,function(){return 0});this.behaviourUnits=JW.Array.$index(this.behaviours,JW.byField()).map(function(){return[]});this.totalBehaviourCount=JW.Map.map(this.behaviourUnits,function(){return 0});this.unitBehaviours={};this.basePatrolCount=JW.Array.$index(this.bases,JW.byField("_iid")).map(function(){return 0});this.units=[];this.enemyUnits=null;this.enemyBases=null;this.allEnemies=null;var a=c.units.$toArray().filter(function(d){return d.player!==this.player},this);this.threateningPairs=JW.Array.$map(a,function(e){var d,f=Number.POSITIVE_INFINITY;JW.Array.each(this.bases,function(h){var g=FL.Vector.lengthSqr(FL.Vector.diff(e.ij.get(),h.ij));if(g<f){d=h;f=g}},this);if(f>this.aquisitionDistanceSqr){return false}return[e,d]},this).filter(JW.byField());c.units.each(function(d){if(d.player!==this.player){return}this.units.push(d);++this.unitCount[d.type.id];++this.totalUnitCount[d.type.id];if(d.cell.base){if(d.cell.base.unitType.get()&&(d.cell.base.unitType.get()!==d.type)){this.makeUseful(d)}else{if(this.isUnitReady(d)){this.makeUseful(d)}}}else{if(d.isHealed()||this.isEnemyWithin(d.ij.get(),this.healSafeDistance)){this.makeUseful(d)}}++this.totalBehaviourCount[d.behaviour]},this);JW.Array.each(this.bases,function(e){var d=e.unitType.get();if(d){++this.totalUnitCount[d.id]}if(e.unitBehaviour){++this.totalBehaviourCount[e.unitBehaviour]}},this);this.availableBehaviours=this.behaviours.concat();JW.Array.each(this.bases,function(k){if(k.unitType.get()){return}var d=this.data.map.getCell(k.ij);if(d.unit&&!this.isUnitReady(d.unit)){k.unitType.set(d.unit.type);return}var h=(Math.random()<this.forcedHoldProbability)?["build","hold"]:this.availableBehaviours;var f;if(this.totalBehaviourCount.build===0){f=FL.Unit.types.mcv}else{if(this.totalBehaviourCount.build>=this.mcvLimit){JW.Array.removeItem(h,"build")}if(this.totalBehaviourCount.patrol>=this.patrolInitial+this.patrolPerBase*this.bases.length){JW.Array.removeItem(h,"patrol")}var i=k.getAvailableUnitTypes();i=JW.Array.filter(i,function(l){return JW.Array.some(l.ai,function(m){return JW.Array.containsItem(h,m)},this)},this);var g=JW.Array.filter(i,JW.byField("aiPreferred"));if(g.length){i=g}f=i[FL.random(i.length)]}k.unitType.set(f);++this.totalUnitCount[f.id];var e=JW.Array.filter(f.ai,function(l){return JW.Array.containsItem(h,l)},this);var j=e.length?e[FL.random(e.length)]:f.ai[FL.random(f.ai.length)];k.unitBehaviour=j;++this.totalBehaviourCount[j]},this);this.holdMap=new FL.Matrix(this.data.map.size);JW.Array.each(this.bases,function(d){this.data.map.eachWithin(d.ij,this.baseHoldRangeSqr,function(e,f){if(!e.resource||(e.resource.id==="airport")){this.holdMap.setCell(f,true)}},this)},this);this.data.map.every(function(d,e){if(!this.data.isPassable(e)||this.data.isChoke(e)||d.base){this.holdMap.setCell(e,true)}},this)};JW.extend(FL.AI,JW.Class,{behaviours:["build","patrol","hold","rush","drop","attack","attacking","assaulting"],patrolDistance:3,healSafeDistance:3,aquisitionDistanceSqr:37,baseHoldRangeSqr:5,unitHoldRangeSqr:4,patrolInitial:3,patrolPerBase:1,mcvLimit:2,baseFirstProductionProfit:15,baseExtraProductionProfit:-4,baseDistanceProfit:-2,stackCostInitial:-30,stackCostPerBase:80,forcedHoldProbability:0.35,doSomething:function(){if(this.build()){return true}this.findEnemies();return this.punish()||this.defend()||this.rush()||this.patrol()||this.drop()||this.attack()||this.hold()},build:function(){return JW.Array.some(this.behaviourUnits.build.concat(),function(b){this.makeUseless(b);var a=this.findBaseSpot(b.ij.get());if(!a){b.ijTarget=null;return false}if(a&&FL.Vector.equal(a,b.ij.get())){this.data.buildBase(b)}else{this.moveUnit(b,a)}return true},this)},findEnemies:function(){this.allEnemies={};this.enemyUnits={};this.data.units.each(function(a){if(a.alive&&(a.player!==this.player)){this.allEnemies[a.ij.get()]=a.ij.get();this.enemyUnits[a.ij.get()]=a}},this);this.enemyBases={};this.data.bases.each(function(a){if(a.player!==this.player){this.allEnemies[a.ij]=a.ij;this.enemyBases[a.ij]=a}},this)},punish:function(){var e={};JW.Array.each(this.units,function(g){if(!g.type.damage||!g.getAttackCount()){return}this.data.findTarget(g.ij.get(),g.player,function(h,i){if(!this.allEnemies[i]){return false}var j=e[i]||[];j.push(g);e[i]=j;return false},this,false,g.movement.get())},this);var f,b=0;JW.Map.each(e,function(k,i){var h=FL.Vector.parse(i);var g=this.data.map.getCell(h);var j=0;if(g.base){j+=10-FL.baseArmor*g.base.health.get()}if(g.unit){if(g.unit.type.id==="mcv"){j+=10}JW.Array.each(g.unit.persons.get(),function(l){var m=1;if(g.hill){++m}if(l.fortified){++m}j-=l.health*(l.type.armor+m*l.type.defense);if(l.defend){j-=2*l.type.damage}},this)}JW.Array.each(k,function(l){var n=0;var m=l.type.damage*l.getAttackCount();if(l.type.blitz&&(FL.Vector.length8(FL.Vector.diff(l.ij.get(),h))===1)){m*=1.5}n+=m;JW.Array.each(l.persons.get(),function(o){n+=0.5*o.health*o.type.armor},this);if(l.type.defense&&l.cell.resource&&!l.cell.nearBases.isEmpty()){j+=0.5*n}else{j+=n}},this);if(b<=j){f=h;b=j}},this);if(!f){return false}var d=e[f];var c,a=0;JW.Array.each(d,function(h){var g=h.type.damage*h.getAttackCount();JW.Array.each(h.persons.get(),function(i){g+=i.health},this);if(a<g){c=h;a=g}},this);if(!c){console.warn("Impossible scenario: couldn't select a punisher");return false}this.moveUnit(c,f);return true},findBaseSpot:function(c){var a=null;var b=Number.NEGATIVE_INFINITY;this.data.map.every(function(d,f){if(d.rock||d.miningBase){return}if(d.unit&&!FL.Vector.equal(c,f)){return}var e=this.getBaseProfit(f)+this.baseDistanceProfit*FL.Vector.length(FL.Vector.diff(c,f));if(e<=b){return}if(!this.data.isBaseBuildable(f)){return}a=f;b=e},this);return a},getBaseProfit:function(c){var a=0;var b=false;this.data.map.eachWithin(c,FL.baseMiningRangeSqr,function(d,e){if(d.rock||d.miningBase){return}if(d.unit&&(d.unit.player!==this.player)){a-=10000}a+=d.mining;if(d.resource){if(d.resource.aiProfit){a+=d.resource.aiProfit}if(d.resource.aiProduction){if(b){a+=this.baseExtraProductionProfit}else{b=true;a+=this.baseFirstProductionProfit}}}},this);return a},defend:function(){var a=JW.Array.find(this.threateningPairs,function(i){var h=i[0];var f=i[1];var e,g=Number.POSITIVE_INFINITY;JW.Array.each(this.behaviourUnits.patrol,function(k){var j=FL.Vector.lengthSqr(FL.Vector.diff(k.ij.get(),f.ij));if(j<g){e=k;g=j}},this);if(!e){return false}this.makeUseless(e);if(!e.type.defense){this.moveUnit(e,h.ij.get());
return true}var d,c=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY;this.data.map.everyWithin8(f.ij,1,function(j,m){if(j.base||(j.unit&&j.unit!==e)){return}var l=FL.Vector.lengthSqr(FL.Vector.diff(m,h.ij.get()));var k=FL.Vector.length8(FL.Vector.diff(m,e.ij.get()));if((l<c)||(l===c&&k<b)){d=m;c=l;b=k}},this);if(!d){this.moveUnit(e,null);return false}this.moveUnit(e,d);return true},this);if(a!=null){this.threateningPairs.splice(a,1);return true}return false},rush:function(){return JW.Array.some(this.behaviourUnits.rush.concat(),function(a){if(this.isRushable(a.cell)){this.moveUnit(a,null);return false}var b=this.data.findTarget(a.ij.get(),a.player,function(c){return this.isRushable(c)&&!c.unit},this);if(!b||(b.length===0)){this.changeBehaviour(a,"patrol");return false}this.moveUnit(a,JW.Array.getLast(b)[1]);return true},this)},isRushable:function(a){return(a.resource!=null)&&!a.nearBases.every(JW.byValue("player",this.player))},patrol:function(){if(this.behaviourUnits.patrol.length===0){return false}var d,g=Number.POSITIVE_INFINITY,b,c=0;JW.Array.each(this.bases,function(i){var k=this.basePatrolCount[i._iid];if(k>g){return}if(k>10){return}var h,j=Number.POSITIVE_INFINITY;JW.Array.each(this.behaviourUnits.patrol,function(m){var l=FL.Vector.lengthSqr(FL.Vector.diff(m.ij.get(),i.ij));if(l<j){h=m;j=l}},this);if((k===g)&&(j<c)){return}d=i;g=k;b=h;c=j},this);var a,e=Number.POSITIVE_INFINITY;var f=FL.random(2);this.data.map.everyWithin8(d.ij,1,function(h,j){if(h.rock||h.base||h.unit){return}var i=FL.Vector.lengthSqr(FL.Vector.diff(j,b.ij.get()));if(i<e){a=j;e=i+f}},this);if(!a){this.basePatrolCount[d._iid]=Number.POSITIVE_INFINITY;return true}this.basePatrolCount[d._iid]++;this.moveUnit(b,a);this.makeUseless(b);return true},drop:function(){return JW.Array.some(this.behaviourUnits.drop.concat(),function(a){if(a.canDrop()){return this.paradrop(a)}var b=this.data.findTarget(a.ij.get(),a.player,function(c){return c.isAirportBy(this.player)});if(!b){this.changeBehaviour(a,"attack",true);return false}if(b.length===0){this.moveUnit(a,null);return false}this.moveUnit(a,JW.Array.getLast(b)[1]);return true},this)},paradrop:function(b){var c=null;var a=Number.POSITIVE_INFINITY;this.data.map.every(function(d){if(!this.data.isDroppable(d.ij,b.player)){return}this.data.bases.each(function(f){if(f.player===b.player){return}var e=FL.Vector.lengthSqr(FL.Vector.diff(f.ij,d.ij));if(e<a){c=d.ij;a=e}},this)},this);b.ijTarget=null;if(!c){this.moveUnit(b,null);return false}b.drop(c);if(b.movement.get()===0){this.makeUseless(b)}b.behaviour=(a<9)?"assaulting":"attacking";return true},attack:function(){JW.Array.each(this.behaviourUnits.attack.concat(),function(a){var b=(this.isEnemyWithin(a.ij.get(),3)||FL.random(2))?"attacking":"assaulting";this.changeBehaviour(a,b,true)},this);return this.issueAttack(this.behaviourUnits.assaulting,this.enemyBases)||this.issueAttack(this.behaviourUnits.attacking,this.allEnemies)},issueAttack:function(b,a){return JW.Array.some(b.concat(),function(c){var d=this.data.findTarget(c.ij.get(),this.player,function(e,f){return a[f]!=null},this);if(d&&(d.length!==0)){this.moveUnit(c,JW.Array.getLast(d)[1]);return true}if(c.behaviour==="assaulting"){this.changeBehaviour(c,"attacking")}else{this.moveUnit(c,null)}return false},this)},hold:function(){var a=JW.Array.some(this.behaviourUnits.hold.concat(),function(b){var c;if(!this.holdMap.getCell(b.ij.get())){c=b.ij.get()}else{var d=Number.POSITIVE_INFINITY;this.holdMap.every(function(h,g){if(h){return}var e=this.data.map.getCell(g);if(e.unit){return}var f=FL.Vector.length(FL.Vector.diff(b.ij.get(),g))+0.2*FL.Vector.length(FL.Vector.diff(this.data.map.ijCenter(),g));if(f<d){c=g;d=f}},this)}if(c){this.data.map.eachWithin(c,this.unitHoldRangeSqr,function(e,f){if(!e.resource||FL.Vector.equal(f,c)){this.holdMap.setCell(f,true)}},this)}return this.moveUnit(b,c)},this);return a},isUnitReady:function(b){if(b.behaviour==="hold"){return true}if(b.getCount()>=Math.min(b.type.capacity,Math.round(this.stackCost/b.type.cost))){return true}var c=b.cell.base;if(!c){return true}if(!c.isUnitTypeAvailable(b.type)){return true}var a=c.unitType.get();return a&&(a!==b.type)},isEnemyWithin:function(a,b){return this.data.map.someWithin8(a,b,function(c,d){return(c.unit&&(c.unit.player!==this.player))||(c.base&&(c.base.player!==this.player))},this)},moveUnit:function(c,a){c.ijTarget=a;var b=this.data.moveUnit(c);if(!b||!c.alive||!c.movement.get()){this.makeUseless(c)}},makeUseful:function(a,b){if(a.alive&&(a.movement.get()!==0)){b=b||a.behaviour;this.behaviourUnits[b].push(a);this.unitBehaviours[a._iid]=b}},makeUseless:function(a){var b=this.unitBehaviours[a._iid];if(b){JW.Array.removeItem(this.behaviourUnits[b],a)}JW.Array.removeItem(this.units,a)},changeBehaviour:function(a,b,c){this.makeUseless(a);this.makeUseful(a,b);if(c){a.behaviour=b}}});JW.apply(FL.AI,{initialProductionCoef:1,productionCoefPerWin:0.1,productionCoefPerLoss:0.05});FL.AI.productionCoef=FL.AI.initialProductionCoef+(localStorage.wins||0)*FL.AI.productionCoefPerWin-(localStorage.losses||0)*FL.AI.productionCoefPerLoss;FL.AlternateAnimation=function(a){FL.AlternateAnimation._super.call(this);this.updater=a.updater;this.finish=a.finish;this.scope=a.scope||this;this.time=new Date().getTime();this.own(new JW.Interval(this._animate,this,40))};JW.extend(FL.AlternateAnimation,JW.Class,{destroy:function(){if(this.finish){this.finish.call(this.scope)}this._super()},_animate:function(){var a=new Date().getTime()-this.time;a=Math.abs(JW.smod(a,1000))/500;if(this.updater){this.updater.call(this.scope,a)}}});FL.App=function(a){FL.App._super.call(this);this.data=a};JW.extend(FL.App,JW.UI.Component,{renderRoot:function(a){a.bind("contextmenu",JW.UI.preventDefault)},renderMonitor:function(){return this.monitor=new FL.Monitor(this.data)},afterRender:function(){this._super();this.data.lostEvent.bind(this._onLost,this);this.el.tooltip({hide:false,show:false,content:function(){return $(this).prop("title")}})},_onLost:function(a){this.monitor.collapse();this.children.set(new FL.ScreenWin(a!==0),"screen-win")}});JW.UI.template(FL.App,{main:'<div jwclass="fl-app"><div jwid="monitor"></div><div jwid="screen-win"></div></div>'});FL.Base=function(c,a,b){FL.Base._super.call(this);this.data=c;this.cell=a;this.ij=a.ij;this.player=b;this.unitType=this.own(new JW.Property(null));this.unitBehaviour=null;this.production=JW.Map.map(FL.Unit.types,function(){return 0});this.name="Unnamed";this.mining=0;this.overflow=0;this.resources=[];this.health=this.own(new JW.Property(0.1))};JW.extend(FL.Base,JW.Class,{isUnitTypeAvailable:function(a){if(!a.resources){return true}return JW.Array.every(a.resources,function(b){return JW.Array.containsItem(this.resources,FL.Resource.types[b])},this)},getAvailableUnitTypes:function(){return JW.Array.filter(FL.Unit.typeArray,this.isUnitTypeAvailable,this)},heal:function(){this.health.set(FL.heal(this.health.get(),FL.baseHealRate))},toPerson:function(){var a=new FL.Unit.Person(FL.Unit.baseType);a.health=this.health.get();return a},addResource:function(a){if(!a){return}this.resources.push(a)},removeResource:function(b){if(!b){return}JW.Array.removeItem(this.resources,b);var a=this.unitType.get();if(a&&!this.isUnitTypeAvailable(a)){this.unitType.set(null)}},getShotAnimation:function(){return null},getDeathAnimation:function(){return FL.Base.deathAnimation},getCenter:function(){return FL.Vector.add(FL.ijToXy(this.ij),[FL.cellSize/2,FL.cellSize/2])},onBattleFinish:function(){if(this.health.get()===0){this.data.destroyBase(this)}},getTotalMining:function(){var a=0;this.data.map.eachWithin(this.ij,FL.baseMiningRangeSqr,function(b){if(b.rock){return}a+=b.hill?2:1;if(b.resource&&b.resource.bonus){a+=b.resource.bonus}},this);return a}});FL.Base.deathAnimation={sound:"death-heavy",originCount:1,spreadCount:1,originDistance:0,spreadDistance:0,particle:{colorFrom:"#FFF",colorTo:"#FF0",opacityFrom:1,opacityTo:0.2,radiusFrom:0.2,radiusTo:1,duration:1500}};FL.ButtonAnimation=function(a){FL.ButtonAnimation._super.call(this);
this.own(new FL.AlternateAnimation({updater:function(c){var b=JW.Color.str(JW.Color.gradient("#00D000","#009000",c));a.css("background-color",b);a.css("border-color",b)},finish:function(){a.css("background-color","");a.css("border-color","")},scope:this}))};JW.extend(FL.ButtonAnimation,JW.Class);FL.revealAll=false;FL.Cell=function(b,a){FL.Cell._super.call(this);this.data=b;this.ij=a;this.rock=false;this.hill=(Math.random()<FL.plainHillChance);this.mining=0;this.base=null;this.nearBases=this.own(new JW.Set());this.miningBase=null;this.unit=null;this.resource=null;this.scouted=[FL.revealAll,false];this.visible=[FL.revealAll,false];this.invalid=false;this.resetMining()};JW.extend(FL.Cell,JW.Class,{reveal:function(a){if(this.scouted[a]&&this.visible[a]){return}this.scouted[a]=true;this.visible[a]=true;this.invalid=true;if(this.unit){this.unit.setVisible(true,a);this.unit.resetAnimation()}this._checkEnemyApproaching()},hide:function(a){if((a===0)&&FL.revealAll){return}if(!this.scouted[a]||!this.visible[a]){return}this.visible[a]=false;this.invalid=true;if(this.unit&&(a===0)){this.unit.setVisible(false,a);this.unit.resetAnimation()}},setBase:function(a){if(this.base===a){return}this.base=a;this.invalid=true},addNearBase:function(a){if(this.rock){return}if(this.nearBases.add(a)){this._updateMiningBase()}},removeNearBase:function(a){if(this.nearBases.remove(a)){this._updateMiningBase()}},setUnit:function(a){if(this.unit===a){return}this.unit=a;this.invalid=true;this._updateMiningBase()},setRock:function(a){if(this.rock===a){return}this.rock=a;this.resetMining()},setHill:function(a){if(this.hill===a){return}this.hill=a;this.resetMining()},setResource:function(a){if(this.resource===a){return}if(this.miningBase&&this.resource){this.miningBase.removeResource(this.resource)}this.resource=a;if(this.miningBase&&this.resource){this.miningBase.addResource(this.resource)}this.resetMining()},isAirportBy:function(a){return(this.miningBase!=null)&&(this.miningBase.player===a)&&(this.resource!=null)&&(this.resource.id==="airport")},resetMining:function(){var a=this.rock?0:this.hill?2:1;if(this.resource&&this.resource.bonus){a+=this.resource.bonus}if(this.miningBase&&(a!==this.mining)){this.miningBase.mining+=a-this.mining}this.mining=a},_updateMiningBase:function(){var a=null;var b=Number.POSITIVE_INFINITY;this.nearBases.each(function(d){if(this.unit&&(this.unit.player!==d.player)){return}var c=FL.Vector.lengthSqr(FL.Vector.diff(this.ij,d.ij));if(c<b){a=d;b=c}},this);if(a===this.miningBase){return}if(this.miningBase){this.miningBase.mining-=this.mining;this.miningBase.removeResource(this.resource)}this.miningBase=a;if(this.miningBase){this.miningBase.mining+=this.mining;this.miningBase.addResource(this.resource)}this.data.map.everyWithin8(this.ij,1,function(c){c.invalid=true},this);this._checkEnemyApproaching()},_checkEnemyApproaching:function(){if(!this.data.enemyScouted&&!FL.revealAll&&this.visible[0]&&this.miningBase&&(this.miningBase.player!==0)){this.data.enemyScouted=true;FL.sound("enemy-units-approaching")}}});JW.Color={colors:{aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],grey:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],honeydew:[240,255,240],hotpink:[255,105,180],"indianred ":[205,92,92],"indigo ":[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgrey:[211,211,211],lightgreen:[144,238,144],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,216],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[216,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},_format1:/^rgb\s*\(\s*([0-9]+)\s*,\s*([0-9]+)\s*,\s*([0-9]+)\s*\)$/,_format2:/^rgb\s*\(\s*(-?[0-9]+(?:\.[0-9]+)?)\%\s*,\s*(-?[0-9]+(?:\.[0-9]+)?)\%\s*,\s*(-?[0-9]+(?:\.[0-9]+)?)\%\s*\)$/,_format3:/^#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})$/,_format4:/^#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])$/,parse:function(b){if(typeof b==="number"){if(!JW.isInt(b)||(b<0)||(b>16777215)){return null}return[(b>>16),(b>>8)&255,(b)&255]}if(typeof b==="string"){var a;b=JW.String.trim(b).toLowerCase();if(a=JW.Color.colors[b]){return a.concat()}if(a=JW.Color._format1.exec(b)){return JW.Color._parseArray([parseInt(a[1]),parseInt(a[2]),parseInt(a[3])])}if(a=JW.Color._format2.exec(b)){for(var c=0;c<3;++c){a[c+1]=parseFloat(a[c+1]);if(a[c+1]<0||a[c+1]>100){return null}}return JW.Color._parseArray([Math.round(a[1]*2.55),Math.round(a[2]*2.55),Math.round(a[3]*2.55)])}if(a=JW.Color._format3.exec(b)){return JW.Color._parseArray([parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)])}if(a=JW.Color._format4.exec(b)){return JW.Color._parseArray([parseInt(a[1],16)*17,parseInt(a[2],16)*17,parseInt(a[3],16)*17])}return null}if(JW.isArray(b)&&b.length===3&&(typeof b[0]==="number")&&(typeof b[1]==="number")&&(typeof b[2]==="number")&&JW.Color._parseArray(b)){return b.concat()}return null},suggest:function(b){if(typeof b==="number"){b=JW.mod(Math.round(b),16777216);return[(b>>16),(b>>8)&255,(b)&255]}if(typeof b==="string"){var a;b=JW.String.trim(b).toLowerCase();if(a=JW.Color.colors[b]){return a.concat()}if(a=JW.Color._format1.exec(b)){return JW.Color._suggestArray([parseInt(a[1]),parseInt(a[2]),parseInt(a[3])])
}if(a=JW.Color._format2.exec(b)){return JW.Color._suggestArray([parseFloat(a[1])*2.55,parseFloat(a[2])*2.55,parseFloat(a[3])*2.55])}if(a=JW.Color._format3.exec(b)){return JW.Color._suggestArray([parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)])}if(a=JW.Color._format4.exec(b)){return JW.Color._suggestArray([parseInt(a[1],16)*17,parseInt(a[2],16)*17,parseInt(a[3],16)*17])}return null}if(JW.isArray(b)&&b.length===3&&(typeof b[0]==="number")&&(typeof b[1]==="number")&&(typeof b[2]==="number")){return JW.Color._suggestArray(b)}return null},rgb:function(b){if(typeof b==="number"){return[(b>>16),(b>>8)&255,(b)&255]}if(typeof b==="string"){var a;b=JW.String.trim(b).toLowerCase();if(a=JW.Color.colors[b]){return a.concat()}if(a=JW.Color._format1.exec(b)){return[parseInt(a[1]),parseInt(a[2]),parseInt(a[3])]}if(a=JW.Color._format2.exec(b)){return[Math.round(parseFloat(a[1])*2.55),Math.round(parseFloat(a[2])*2.55),Math.round(parseFloat(a[3])*2.55)]}if(a=JW.Color._format3.exec(b)){return[parseInt(a[1],16),parseInt(a[2],16),parseInt(a[3],16)]}if(a=JW.Color._format4.exec(b)){return[parseInt(a[1],16)*17,parseInt(a[2],16)*17,parseInt(a[3],16)*17]}return null}return b.concat()},str:function(a){if(typeof a==="string"){return a}a=JW.Color.num(a);return"#"+JW.String.prepend(a.toString(16),6,"0")},num:function(a){if(typeof a==="number"){return a}a=JW.Color.rgb(a);return(a[0]<<16)|(a[1]<<8)|a[2]},hex:function(a){return"#"+JW.String.prepend(JW.Color.num(a).toString(16),6,"0")},darken:function(a,b){return JW.Color.gradient(a,"black",b)},lighten:function(a,b){return JW.Color.gradient(a,"white",b)},gradient:function(d,c,b){d=JW.Color.rgb(d);c=JW.Color.rgb(c);for(var a=0;a<3;++a){d[a]+=(c[a]-d[a])*b}return d},multiGradient:function(g,f){var e;for(e=0;e<g.length;++e){if(f<g[e][0]){break}}if(e==0){return g[0][1]}if(e==g.length){return g[e-1][1]}var d=g[e-1];var c=g[e];return JW.Color.gradient(d[1],c[1],(f-d[0])/(c[0]-d[0]))},fg:function(a){var a=JW.Color.rgb(a);return(a[0]+a[1]+a[2]>=384)?[0,0,0]:[255,255,255]},_parseArray:function(a){for(var b=0;b<3;++b){if(!JW.isInt(a[b])||(a[b]<0)||(a[b]>255)){return null}}return a},_suggestArray:function(b){var a=[];for(var c=0;c<3;++c){a[c]=Math.round(Math.max(0,Math.min(255,b[c])))}return a}};FL.Data=function(){FL.Data._super.call(this);this.map=null;this.bases=new JW.Set();this.units=new JW.ObservableArray();this.particles=new JW.ObservableArray();this.lostEvent=new JW.Event();this.nextPlayerEvent=new JW.Event();this.mapUpdateEvent=new JW.Event();this.turn=new JW.Property(1);this.player=0;this.animationManager=this.own(new FL.Data.AnimationManager(this));this.baseNames=FL.baseNames.concat();this.unitNames=[];this.ai=null;this.enemyScouted=false;this.lostPlayer=null;for(var a=0;a<2;++a){this.unitNames.push({worker:this.own(new FL.UnitNameList(["Worker"])),infantry:this.own(new FL.UnitNameList(FL.infantryNames)),vehicle:this.own(new FL.UnitNameList(FL.vehicleNames))})}this._generateMap()};JW.extend(FL.Data,JW.Class,{createBase:function(c,b){var a=this.map.getCell(c);var e=new FL.Base(this,a,b);if(this.baseNames.length===0){e.name="No more names"}else{var d=FL.random(this.baseNames.length);e.name=this.baseNames[d];this.baseNames.splice(d,1)}this.bases.add(e);a.base=e;this.map.eachWithin(c,FL.baseMiningRangeSqr,function(f){f.addNearBase(e)},this);this.reveal(c,FL.baseSightRangeSqr,b);if(a.visible[0]&&(this.turn.get()>1)){FL.sound("base-build")}this.mapUpdateEvent.trigger();return e},destroyBase:function(a){this.map.eachWithin(a.ij,FL.baseMiningRangeSqr,function(b){b.removeNearBase(a)},this);this.bases.remove(a);this.map.getCell(a.ij).setBase(null);a.destroy();if(a.name!=="No more names"){this.baseNames.push(a.name)}this.mapUpdateEvent.trigger();this.checkDefeat(a.player)},createUnit:function(c,b,d,g,a){var e=new FL.Unit(this,c,b,d,g);var f=this.unitNames[b][d.naming];e.name=f.checkout(a);this.units.add(e);this.reveal(c,e.getSightRangeSqr(),b);this.mapUpdateEvent.trigger();return e},destroyUnit:function(a){this.units.removeItem(a);a.destroy();this.mapUpdateEvent.trigger();this.checkDefeat(a.player)},lose:function(a){this.enemyScouted=true;this.revealAll(0);this.lostPlayer=a;this.lostEvent.trigger(a)},checkDefeat:function(c){var b=this.bases.count(JW.byValue("player",c));var a=this.units.count(function(d){return d.alive&&(d.player===c)&&(d.type.id==="mcv")},this);if(b===0&&a===0){this.lose(c)}},moveUnit:function(g,h){if(!g.ijTarget){return false}if(FL.Vector.equal(g.ij.get(),g.ijTarget)){g.ijTarget=null;return false}var j=this.getPath(g.ij.get(),g.ijTarget,g.player);if(!j){g.ijTarget=null;return false}g.hold=false;g.skipped=false;if(!h||!JW.Array.some(h,JW.byField())){h=JW.Array.map(g.persons.get(),function(){return true})}if(!JW.Array.every(h,JW.byField())){g=g.split(h)}var d=false;var f=false;for(var e=0;(e<j.length)&&g.movement.get();++e){var b=FL.Vector.add(g.ij.get(),FL.dir8[j[e]]);var a=this.getMoveOutcome(g,b,FL.Vector.equal(b,g.ijTarget));if(a===0){break}var c=this.map.getCell(b);if(a===2){d=this.fightUnit(g,c.unit)||d;g.ijTarget=null;break}if(a===3){d=this.fightBase(g,c.base)||d;g.ijTarget=null;break}d=true;if(a===5){this.map.everyWithin8(b,1,function(i){if(i.unit){i.reveal(g.player)}},this);g.ijTarget=null;break}f=true;g.decreaseMovement();g.ij.set(b);if(a===4){g.ijTarget=null;break}}if(g.ijTarget&&FL.Vector.equal(g.ij.get(),g.ijTarget)){g.ijTarget=null}if((g.cell.unit!=null)&&(g.cell.unit!==g)&&g.alive){g.cell.unit.merge(g.persons.get());this.destroyUnit(g)}if(f&&g.visible[0]){FL.sound(g.type.movementSound)}if(d){this.mapUpdateEvent.trigger()}return d?g:false},moveUnits:function(a){this.units.$filter(JW.byValue("player",a)).each(function(b){this.moveUnit(b)},this)},fightUnit:function(b,f){var g=JW.Array.map(b.persons.get(),JW.byMethod("clone"));var e=JW.Array.map(f.persons.get(),JW.byMethod("clone"));var i=1+(f.cell.hill?1:0);var c=b.getAttackCount();var a=f.getDefendCount();if(c===0){return false}var d=0;var k=0;while((c!==0)&&(e.length!==0)){--c;d+=b.type.damage;FL.fight(b.type.damage,i,e)}while((a!==0)&&(g.length!==0)){--a;k+=f.type.damage;FL.fight(f.type.damage,0,g)}var j=b.getCount()-g.length;var h=f.getCount()-e.length;b.setPersons(g,true);f.setPersons(e,true);b.retainAttacks(c);f.retainDefends(a);b.animations.push(new FL.Unit.BattleAnimation(this,b,k,j,f,d,h));this.animationManager.enqueue(b);return true},fightBase:function(b,e){if(e.health.get()===0){return false}var c=[e.toPerson()];var a=b.getAttackCount();if(a===0){return false}var d=0;while((a!==0)&&(c.length!==0)){--a;d+=b.type.damage;FL.fight(b.type.damage,0,c)}e.health.set((c.length===0)?0:c[0].health);b.animations.push(new FL.Unit.BattleAnimation(this,b,0,0,e,d,1-c.length));this.animationManager.enqueue(b);b.retainAttacks(a);return true},endTurn:function(){this.moveUnits(this.player);this.animationManager.changePlayerOnFinish=true},nextPlayer:function(){this._endTurnPlayer(this.player);this.player=(this.player+1)%2;if(this.player===0){this.turn.set(this.turn.get()+1)}this.units.$filter(JW.byValue("player",this.player)).each(JW.byMethod("heal"));this.bases.$filter(JW.byValue("player",this.player)).each(JW.byMethod("heal"));this.nextPlayerEvent.trigger();if(this.player!==0){this.ai=new FL.AI(this,this.player)}else{this.ai.destroy();this.ai=null}},_endTurnPlayer:function(a){this.units.$filter(JW.byValue("player",a)).each(JW.byMethod("refresh"));this.resetVision(a);this._produce(a);this.mapUpdateEvent.trigger()},reveal:function(c,b,a){this.map.eachWithin(c,b,JW.byMethod("reveal",[a]))},revealAll:function(a){this.map.every(function(b){b.reveal(a)},this);this.mapUpdateEvent.trigger()},resetVision:function(c){for(var b=0;b<this.map.size;++b){for(var a=0;a<this.map.size;++a){this.map.getCell([b,a]).hide(c)}}this.bases.each(function(d){if(d.player===c){this.reveal(d.ij,FL.baseSightRangeSqr,c)}},this);this.units.each(function(d){if(d.player===c){this.reveal(d.ij.get(),d.getSightRangeSqr(),c)}},this)},buildBase:function(a){this.createBase(a.ij.get(),a.player);this.destroyUnit(a)
},isBaseBuildable:function(a,b){if(!this.isPassable(a)){return false}if(this.map.getCell(a).resource){return false}b=b||FL.minBaseDistanceSqr;return this.bases.every(function(c){return FL.Vector.lengthSqr(FL.Vector.diff(a,c.ij))>=b},this)},isPassable:function(a){return this.map.inMatrix(a)&&!this.map.getCell(a).rock},isDroppable:function(b,c){var a=this.map.getCell(b);if(!this.isPassable(b)||a.unit||(a.base&&a.base.player!==c)){return false}if(!a.visible[c]){return false}return true},isChoke:function(c){var a=FL.getIjs8(c);if(this.isPassable(a[0])&&!this.isPassable(a[2])&&this.isPassable(a[4])&&!this.isPassable(a[6])){return true}if(!this.isPassable(a[0])&&this.isPassable(a[2])&&!this.isPassable(a[4])&&this.isPassable(a[6])){return true}for(var e=0;e<8;e+=2){if(!this.isPassable(a[e])&&this.isPassable(a[e+1])&&!this.isPassable(a[(e+2)%8])){for(var b=3;b<8;++b){if(this.isPassable(a[(e+b)%8])){return true}}}}return false},isByEnemy:function(b,a,c){return this.map.someWithin8(b,1,function(d){return d.unit&&(d.unit.player!==a)&&(!c||d.unit.visible[a])},this)},getMoveOutcome:function(d,b,c){if(!this.isPassable(b)){return 0}c=(c==null)||c;var e=d.cell;var a=this.map.getCell(b);if(a.unit&&(a.unit.player!==d.player)){return(d.type.damage!==0&&c)?2:0}if(this.isByEnemy(d.ij.get(),d.player)&&this.isByEnemy(b,d.player)){return this.isByEnemy(b,d.player,true)?0:5}if(a.unit&&(a.unit.player===d.player)){return((a.unit.type===d.type)&&(a.unit.getCount()+d.getCount()<=d.type.capacity)&&c)?4:0}if(a.base&&(a.base.player!==d.player)){return(d.type.damage!==0&&c)?3:0}return 1},getPath:function(d,b,c,a){var e=this.findTarget(d,c,function(f){return FL.Vector.equal(b,f.ij)},this,a);return e?JW.Array.map(e,JW.byField("0")):null},getDistanceMatrix:function(c,n,e,a,p,q){var g=new FL.Matrix(this.map.size);g.setCell(c,0);if(e.call(a||this,this.map.getCell(c),c)){return[g,c]}if(q==null){q=Number.POSITIVE_INFINITY}var l=[c];var i=0;var m=0;var h=0;while(i<l.length){if(i==h){++m;h=l.length}var f=l[i++];for(var k=0;k<FL.dir8.length;++k){var o=FL.Vector.add(f,FL.dir8[k]);var d=g.getCell(o);if(!this.map.inMatrix(o)||(d!=null)){continue}var b=this.map.getCell(o);if(p||b.scouted[n]){if(!this.isPassable(o)){continue}}var j=b.unit;var r=j&&(j.player!==n)&&(p||j.visible[n]);if(!r&&this.isByEnemy(f,n,!p)&&this.isByEnemy(o,n,!p)){continue}g.setCell(o,m);if(e.call(a||this,b,o)!==false){return[g,o]}if(m>=q){continue}if(j&&(p||j.visible[n])){continue}if((p||b.visible[n])&&b.base&&(b.base.player!==n)){continue}l.push(o)}}return[g,null]},findTarget:function(e,c,g,d,b,f){var a=this.getDistanceMatrix(e,c,g,d,b,f);return a[1]?this.backtracePath(a[0],a[1],c,b):null},isControllable:function(){return(this.player===0)&&!this.animationManager.sequential},isUnitBlockProduction:function(c){if(!c){return false}var a=c.unitType.get();if(!c.cell.unit||!a){return false}if((c.cell.unit.type===a)&&(c.cell.unit.getCount()<a.capacity)){return false}var b=(c.player===0)?1:FL.AI.productionCoef;var d=c.production[a.id]+c.overflow+Math.round(b*c.mining);return d>=a.cost},_generateMap:function(){this.map=new FL.Matrix(FL.mapSize);for(var d=0;d<FL.mapSize;++d){for(var b=0;b<FL.mapSize;++b){var c=[d,b];var a=new FL.Cell(this,c);this.map.setCell(c,a)}}this._generateRocks();this._generateResources();this._generateBases();this.bases.each(function(e){this.map.eachWithin(e.ij,FL.baseMiningRangeSqr,function(g){if(g.resource){if(g.resource.deniedAtStart){this._generateResource(g.resource);g.setResource(null)}else{if(g.resource.bonus&&(e.mining-g.resource.bonus>=20)){g.setResource(null)}}}},this);var f;if(e.mining<20){f="aluminum"}else{if(e.mining<24){f="oil"}else{if(e.mining<26){f="iron"}else{if(e.mining<30){f="copper"}else{return}}}}this.map.eachWithin(e.ij,2,function(g){if(f&&!g.resource){g.setResource(FL.Resource.types[f]);f=null}},this)},this);this._equalizeResources()},_generateRocks:function(){for(var f=0;f<FL.rockCount;++f){var l,b;do{l=this.map.ijRandom();b=this.isPassable(l)&&!this.isChoke(l)}while(!b);var e=[];var a=JW.inScope(function(i){if(!this.isPassable(i)||this.isChoke(i)){return}e.push(i);this.map.getCell(i).setRock(true);for(var m=0;m<4;++m){var j=FL.Vector.add(i,FL.dir4[m]);if(this.map.inMatrix(j)&&(Math.random()<FL.rockHillChance)){this.map.getCell(j).setHill(true)}}},this);a(l);var k=FL.random(FL.rockDensity);for(var c=0;c<k;++c){var h=FL.random(4);var g=FL.Vector.add(e[FL.random(e.length)],FL.dir4[h]);a(g)}}},_generateResources:function(){JW.Array.each(FL.Resource.typeArray,function(b){for(var a=0;a<b.count;++a){this._generateResource(b)}},this)},_generateResource:function(c){var b,a;do{b=this.map.ijRandom();a=this.map.getCell(b)}while(a.rock||a.resource||a.miningBase||this._isResourceTooClose(c,b));a.setResource(c)},_isResourceTooClose:function(c,b){if(!c.minDistanceSqr){return false}var a=false;this.map.eachWithin(b,c.minDistanceSqr,function(d){a=a||(d.resource===c)},this);return a},_equalizeResources:function(){if(this.map.every(function(k){return k.resource==null})){return}function b(l){var k=Math.max(0,1-l/FL.resourceEqualizeRange);return k*k}var a=new FL.Matrix(this.map.size);this.map.every(function(k,m){var n=this.map.getSideDistance(m);var l=FL.resourceEqualizeSideBuff*b(n);a.setCell(m,Math.max(0,l))},this);var c=JW.Map.map(FL.Resource.types,function(l){var k=new FL.Matrix(this.map.size);k.fill(0);return k},this);var g=JW.inScope(function(m,n,l){if(!n){return}var k=l?1:-1;this.map.everyWithin8(m,FL.resourceEqualizeRange,function(t,r){var s=FL.Vector.length(FL.Vector.diff(r,m));var q=k*n.profit*b(s);a.setCell(r,a.getCell(r)+q)},this);if(!n.minDistanceSqr){return}var o=c[n.id];this.map.eachWithin(m,n.minDistanceSqr,function(r,q){o.setCell(q,o.getCell(q)+k)},this)},this);this.map.every(function(k,l){g(l,k.resource,true)},this);while(true){var j=-1,f;this.map.every(function(k,m){if(!k.resource||k.miningBase){return}var l=a.getCell(m);if(j<l){j=l;f=k}},this);if(j<0){break}var d=f.resource;var e=c[d.id];f.setResource(null);g(f.ij,d,false);var h=Number.POSITIVE_INFINITY,i;this.map.every(function(k,m){if(k.rock||k.resource||k.miningBase||e.getCell(m)){return}var l=a.getCell(m);if(h>l){h=l;i=k}},this);i.setResource(d);g(i.ij,d,true);a.setCell(i.ij,Number.NEGATIVE_INFINITY)}},_generateBases:function(){for(var g=0;g<FL.playerCount;++g){var f;while(true){f=this.map.ijRandom();if(!this.isBaseBuildable(f,FL.minMainBaseDistanceSqr)){continue}var b=this.map.getSideDistance(f);if(b<FL.minMainBaseSideDistance){continue}if(b>FL.maxMainBaseSideDistance){continue}break}for(var e=-1;e<=1;++e){for(var c=-1;c<=1;++c){var a=this.map.getCell(FL.Vector.add(f,[e,c]));if(a){a.setRock(false)}}}this.createBase(f,g).health.set(1);for(var h=0;h<4;++h){this.createUnit(FL.Vector.add(f,FL.dir4[h]),g,FL.Unit.types.militia,"hold")}}},backtracePath:function(g,b,m,j){var n=[];var a=g.getCell(b);if(a==null){return null}var c=this.map.getCell(b).unit;var f,h;if(c&&(c.player!==m)&&(j||c.visible[m])){f=false}else{f=this.isByEnemy(b,m,!j)}while(true){if(a===0){n.reverse();return n}--a;var e,l;for(var i=0;i<8;++i){e=(i<4)?(2*i):(2*i-7);l=FL.Vector.diff(b,FL.dir8[e]);if(g.getCell(l)!==a){continue}h=this.isByEnemy(l,m,!j);if(f&&h){continue}var k=this.map.getCell(l);if(a&&k.unit&&(j||k.unit.visible[m])){continue}if((j||k.visible[m])&&k.base&&(k.base.player!==m)){continue}break}n.push([e,b]);f=h;b=l}},_produce:function(a){this.bases.each(function(e){if(e.player!==a){return}var c=e.unitType.get();if(!c){return}var d=(a===0)?1:FL.AI.productionCoef;var f=e.production[c.id]+e.overflow+Math.round(d*e.mining);var b=this.map.getCell(e.ij);if(f<c.cost){e.production[c.id]=f;e.overflow=0;if(this.isUnitBlockProduction(e)){e.cell.unit.hold=false}return}if(!b.unit){if(e.player===0){FL.sound("produced")}this.createUnit(e.ij,e.player,c,e.unitBehaviour)}else{if((b.unit.type===e.unitType.get())&&(b.unit.getCount()<b.unit.type.capacity)){b.unit.merge([new FL.Unit.Person(b.unit.type)])}else{if(this.isUnitBlockProduction(e)){e.cell.unit.hold=false}return}}e.production[c.id]=0;
e.overflow=f-c.cost;e.unitType.set(null);e.unitBehaviour=null},this)},_testBasesMining:function(){this.bases.each(function(a){if(a.mining!==a.getTotalMining()){throw new Error("Base mining is spoiled")}},this)}});FL.Data.AnimationManager=function(a){FL.Data.AnimationManager._super.call(this);this.data=a;this.animationQueue=[];this.lastHit=new Date().getTime();this.lastHitRounded=this.lastHit;this.changePlayerOnFinish=false;this.timer=this.own(new JW.Property(new JW.Interval(this._onInterval,this,17))).ownValue();this.success=true};JW.extend(FL.Data.AnimationManager,JW.Class,{enqueue:function(a){if(!JW.Array.containsItem(this.animationQueue,a)){this.animationQueue.push(a)}},animate:function(){this.animateAll();if(this.animationQueue.length===0){if(this.data.ai&&!this.data.ai.doSomething()){this.changePlayerOnFinish=true}if(this.changePlayerOnFinish){this.changePlayerOnFinish=false;this.data.nextPlayer()}}},animateSingle:function(){while(this.animationQueue.length){var a=this.animationQueue[0];if(this._animateUnit(a)){this.animationQueue.shift()}else{break}}},animateAll:function(){var b=this.animationQueue;this.animationQueue=[];for(var c=0,a=b.length;c<a;++c){var d=b[c];if(!this._animateUnit(d)){this.animationQueue.push(d)}}},animateParticles:function(a){this.data.particles.$toArray().each(function(b){if(b.animate(a)){this.data.particles.removeItem(b)}},this)},addParticles:function(g,d){if(!d){return}if(d.sound){FL.sound(d.sound)}for(var e=0;e<d.originCount;++e){var b=FL.Vector.mult(this._randomVectorInCircle(),d.originDistance);var a=FL.Vector.add(g,FL.Vector.mult(b,FL.cellSize));for(var c=0;c<d.spreadCount;++c){var f=FL.Vector.mult(this._randomVectorInCircle(),d.spreadDistance);this.data.particles.add(new FL.Data.Particle(JW.apply({},d.particle,{xyFrom:a,xyTo:FL.Vector.add(a,FL.Vector.mult(f,FL.cellSize)),radiusFrom:this._convertRadius(d.particle.radiusFrom),radiusTo:this._convertRadius(d.particle.radiusTo),radius:this._convertRadius(d.particle.radius)})))}}},_animateUnit:function(a){while(a.animations.length){var b=a.animations[0];if(!b.inited){b.inited=true;b.init()}if(!b.animate()){return false}a.animations.shift();if(!b.immediate){return false}}return true},_onInterval:function(){if(!this.success){this.timer.set(null);return}this.success=false;var a=new Date().getTime();while(this.lastHitRounded<a){this.lastHitRounded+=1000/FL.animationStepsPerSecond;this.animate()}this.animateParticles(a-this.lastHit);this.lastHit=a;this.success=true},_randomRadiusVector:function(){var a=2*Math.PI*Math.random();return[Math.cos(a),Math.sin(a)]},_randomVectorInCircle:function(){return FL.Vector.mult(this._randomRadiusVector(),Math.random())},_convertRadius:function(a){return(a==null)?null:(FL.cellSize*a)}});FL.Data.Particle=function(a){FL.Data.Particle._super.call(this);a=a||{};this.xyFrom=a.xyFrom||a.xy;this.xyTo=a.xyTo||a.xy;this.colorFrom=a.colorFrom||a.color;this.colorTo=a.colorTo||a.color;this.opacityFrom=JW.defn(JW.defn(a.opacityFrom,a.opacity),1);this.opacityTo=JW.defn(JW.defn(a.opacityTo,a.opacity),1);this.radiusFrom=a.radiusFrom||a.radius;this.radiusTo=a.radiusTo||a.radius;this.progress=0;this.duration=a.duration||1000;this.xy=this.own(new JW.Property(this.xyFrom));this.color=this.own(new JW.Property(this.colorFrom));this.opacity=this.own(new JW.Property(this.opacity));this.radius=this.own(new JW.Property(this.radiusFrom))};JW.extend(FL.Data.Particle,JW.Class,{animate:function(b){this.progress=Math.min(1,this.progress+b/this.duration);var a=(1-this.progress)*this.radiusFrom+this.progress*this.radiusTo;var c=FL.Vector.between(this.xyFrom,this.xyTo,this.progress);this.xy.set(FL.Vector.diff(c,[a,a]));this.color.set(JW.Color.str(JW.Color.gradient(this.colorFrom,this.colorTo,this.progress)));this.opacity.set((1-this.progress)*this.opacityFrom+this.progress*this.opacityTo);this.radius.set(a);return this.progress===1}});FL.El={xy:function(b,a){b.css({left:a[1]+"px",top:a[0]+"px"})},size:function(b,a){b.css({width:a[1]+"px",height:a[0]+"px"})}};FL.Matrix=function(b){FL.Matrix._super.call(this);this.size=b;this.cells=new Array(b);for(var a=0;a<b;++a){this.cells[a]=new Array(b)}};JW.extend(FL.Matrix,JW.Class,{getCell:function(a){return JW.get(this.cells,a)},setCell:function(a,b){this.cells[a[0]][a[1]]=b},fill:function(c){for(var b=0;b<this.size;++b){for(var a=0;a<this.size;++a){this.cells[b][a]=c}}},inMatrix:function(a){return(a[0]>=0)&&(a[0]<this.size)&&(a[1]>=0)&&(a[1]<this.size)},ijRandom:function(){return[FL.random(this.size),FL.random(this.size)]},ijCenter:function(){return FL.Vector.round(FL.Vector.mult([this.size,this.size],0.5))},getRect:function(a,b){return{iMin:Math.max(0,a[0]-b),iMax:Math.min(this.size-1,a[0]+b),jMin:Math.max(0,a[1]-b),jMax:Math.min(this.size-1,a[1]+b)}},getSideDistance:function(a){return Math.min(a[0],a[1],this.size-a[0]-1,this.size-a[1]-1)},every:function(e,d){for(var c=0;c<this.size;++c){for(var a=0;a<this.size;++a){var b=[c,a];if(e.call(d||this,this.getCell(b),b)===false){return false}}}return true},some:function(b,a){return !this.every(function(){return !b.apply(this,arguments)},a||this)},eachWithin:function(c,a,h,k){var b=Math.ceil(Math.sqrt(a));var f=this.getRect(c,b);for(var e=f.iMin;e<=f.iMax;++e){for(var d=f.jMin;d<=f.jMax;++d){var g=[e,d];if(FL.Vector.lengthSqr(FL.Vector.diff(g,c))<=a){h.call(k||this,this.getCell(g),g)}}}},everyWithin8:function(d,h,g,e){var f=this.getRect(d,h);for(var c=f.iMin;c<=f.iMax;++c){for(var a=f.jMin;a<=f.jMax;++a){var b=[c,a];if(g.call(e||this,this.getCell(b),b)===false){return false}}}return true},someWithin8:function(a,d,c,b){return !this.everyWithin8(a,d,function(){return !c.apply(this,arguments)},b||this)}});FL.Monitor=function(a){FL.Monitor._super.call(this);this.data=a;this.cellSelect=null;this.cellAnimation=this.own(new JW.Property()).ownValue();this.selectNextAnimation=this.own(new JW.Property()).ownValue();this.endTurnAnimation=this.own(new JW.Property()).ownValue();this.endTurnSound=this.own(new JW.Property()).ownValue();this.army=this.own(new JW.Property()).ownValue();this.panel=this.own(new JW.Property()).ownValue();this.selectionQueue=[];this.selectionTail=0;this.distanceMatrix=null;this.hoverCell=null;this.activePath=this.own(new JW.Property()).ownValue();this.hoverPath=this.own(new JW.Property()).ownValue();this.baseExitAttachment=this.own(new JW.Property()).ownValue();this.order=null;this.cells=new FL.Matrix(this.data.map.size);this.unitSelection=[];this.collapsed=false;this.beginTime=new Date().getTime();this.own(this.data.nextPlayerEvent.bind(this.selectNext,this));this.own(this.data.mapUpdateEvent.bind(this.updateMap,this));this.own(new JW.Interval(this._animateArrows,this,40))};JW.extend(FL.Monitor,JW.UI.Component,{arrowsRotationPeriod:4000,arrowsScalingPeriod:1000,arrowsSize:100,activePathColor:"#0F0",hoverPathColor:"#FF0",renderTurn:function(a){this.own(new JW.UI.TextUpdater(a,this.data.turn))},renderSurrender:function(a){a.click(JW.inScope(function(){FL.sound("button");this.getElement("surrender-dialog").dialog("open")},this))},renderNext:function(a){a.click(JW.inScope(function(){FL.sound("button");this.selectNext()},this))},renderEndTurn:function(a){a.click(JW.inScope(function(){if(!this.data.isControllable()){return}FL.sound("button");this.selectionQueue=[];this.endTurnAnimation.set(null);this.endTurnSound.set(null);this.selectCell(null);this.data.endTurn()},this))},renderArmy:function(a){return this.army},renderCells:function(f){f.mousedown(JW.inScope(this._onMapMouseDown,this));f.mouseover(JW.inScope(this._onMapMouseOver,this));f.mouseleave(JW.inScope(this._onMapMouseLeave,this));var g=this.data.map;for(var e=0;e<g.size;++e){var c=jQuery('<div class="fl-monitor-row"></div>');for(var b=0;b<g.size;++b){var d=[e,b];var a=jQuery('<div class="fl-monitor-cell"></div>');this.cells.setCell(d,a);a.attr("fl-i",e);a.attr("fl-j",b);this._updateCell(a,d);c.append(a)}c.append('<div class="fl-clear"></div>');f.append(c)}},renderUnits:function(){return this.data.units.createMapper({createItem:function(a){return new FL.UnitView(a)
},destroyItem:JW.destroy,scope:this}).target},renderParticles:function(){return this.data.particles.createMapper({createItem:function(a){return new FL.Monitor.Particle(a)},destroyItem:JW.destroy,scope:this}).target},renderActivePath:function(){return this.activePath},renderHoverPath:function(){return this.hoverPath},renderPanel:function(){return this.panel},renderSurrenderDialog:function(a){var b=this.data;a.dialog({autoOpen:false,title:"Surrender confirmation",buttons:[{text:"No",click:function(){FL.sound("button");jQuery(this).dialog("close")}},{text:"Yes",click:function(){jQuery(this).dialog("close");b.lose(0)}}]})},afterRender:function(){this._super();this.selectNext()},unrender:function(){this.getElement("surrender-dialog").dialog("destroy");this._super()},selectCell:function(f){if(!this.data.isControllable()){f=null}this.resetOrder();if(this.cellSelect){this.cellAnimation.set(null)}this.baseExitAttachment.set(null);this.selectNextAnimation.set(null);this.unitSelection=[];var d=this.cellSelect!=null;this.cellSelect=f?this.data.map.getCell(f):null;if(this.cellSelect){var c=this._getCell(f);this.cellAnimation.set(new FL.AlternateAnimation({updater:function(i){c.children(".fl-border").css("background","rgba(255, 255, 255, "+i.toFixed(2)+")")},finish:function(){c.children(".fl-border").css("background","")},scope:this}));var g=this.cellSelect.base;if(this._isBaseAutoSelectable(g)){this.baseExitAttachment.set(g.unitType.changeEvent.bind(this.selectNextIfDone,this))}else{if(g){this.baseExitAttachment.set(g.unitType.changeEvent.bind(this.reselectCell,this))}}if(this.cellSelect.unit&&(this.cellSelect.unit.player===0)){this.unitSelection=JW.Array.map(this.cellSelect.unit.persons.get(),function(){return false})}this.army.set((this.cellSelect.visible[0]&&this.cellSelect.unit)?new FL.Panel.Unit(this,this.cellSelect.unit):null);this.panel.set(new FL.Panel(this,this.cellSelect));this.getElement("arrows").css("display","");var b=FL.ijToXy(this.cellSelect.ij);var h=(FL.cellSize-this.arrowsSize)/2;var a=FL.Vector.add(b,[h,h]);var e={left:Math.round(a[0])+"px",top:Math.round(a[1])+"px"};if(d){this.getElement("arrows").stop().animate(e,500,"easeOutQuad")}else{this.getElement("arrows").css(e)}}else{this.army.set(null);this.panel.set(null);this.distanceMatrix=null;this.getElement("arrows").css("display","none")}if(this.cellSelect&&this.cellSelect.unit&&(this.cellSelect.unit.player===0)){this.distanceMatrix=this.data.getDistanceMatrix(f,0,function(){return false},this)[0];this._updatePath(this.activePath,this.activePathColor,this.cellSelect.unit.ijTarget);this._updatePath(this.hoverPath,this.hoverPathColor,this.hoverCell?this.hoverCell.ij:null)}else{this.distanceMatrix=null;this.activePath.set(null);this.hoverPath.set(null)}},selectNext:function(){if(!this.data.isControllable()||(this.data.lostPlayer!=null)){this.selectCell(null);return}while(this.selectionTail<this.selectionQueue.length){var a=this.data.map.getCell(this.selectionQueue[this.selectionTail++]);if(this._isCellAutoSelectable(a)){this.selectCell(a.ij);return}}this._refreshSelectionQueue();if(this.selectionQueue.length){this.selectCell(this.selectionQueue[this.selectionTail++]);return}this.data.moveUnits(0);this._refreshSelectionQueue();if(this.selectionQueue.length){this.selectCell(this.selectionQueue[this.selectionTail++]);return}this.selectCell(null);this.endTurnAnimation.set(new FL.ButtonAnimation(this.getElement("end-turn")));FL.sound("end-turn");this.endTurnSound.set(new JW.Interval(function(){FL.sound("end-turn")},this,2000))},selectNextIfDone:function(){if(this.cellSelect&&this._isBaseAutoSelectable(this.cellSelect.base)){this.reselectCell()}else{if(this.cellSelect&&this._isUnitAutoSelectable(this.cellSelect.unit)){this.reselectCell()}else{this.selectNext()}}},reselectCell:function(){this.selectCell(this.cellSelect.ij)},updateMap:function(e){var f=this.data.map;for(var d=0;d<f.size;++d){for(var b=0;b<f.size;++b){var c=[d,b];var a=this.data.map.getCell(c);if(e||a.invalid){this._updateCell(this._getCell(c),c)}}}},initOrder:function(a){this.selectCell(null);this.order=a;this.getElement("cells").addClass("fl-order-active");for(var d=0;d<this.data.map.size;++d){for(var b=0;b<this.data.map.size;++b){var c=[d,b];if(!this.order.test.call(this.order.scope||this,c)){this._getCell(c).append('<div class="fl-order-overlay"></div>')}}}this.panel.set(new FL.Panel.Order())},resetOrder:function(){if(!this.order){return}var a=this.order;this.order=null;this.getElement("cells").removeClass("fl-order-active");this.getElement("cells").find(".fl-order-overlay").remove();if(a.finish){a.finish.call(a.scope||this)}},collapse:function(){this.getElement("left-panel").add(this.getElement("right-panel")).css("visibility","hidden").animate({"margin-right":0,width:0},2000);this.panel.set(null);this.endTurnSound.set(null);this.selectCell(null);this.collapsed=true},_getCell:function(a){return this.cells.getCell(a)},_updateCell:function(a,h){a=a||this._getCell(h);var i=this.data.map.getCell(h);i.invalid=false;a.empty();a.toggleClass("fl-scouted",i.scouted[0]);a.toggleClass("fl-visible",i.visible[0]);a.toggleClass("fl-rock",i.rock);a.toggleClass("fl-hill",i.hill);if(i.miningBase){a.attr("fl-player",i.miningBase.player);a.append('<div class="fl-mining"></div>')}else{a.removeAttr("fl-player")}var c=jQuery('<div class="fl-border"></div>');c.toggleClass("fl-hold",(i.unit!=null)&&i.unit.hold&&(i.unit.player===0));for(var g=0;g<4;++g){var f=FL.Vector.add(i.ij,FL.dir4[g]);var b=this.data.map.getCell(f);c.toggleClass("fl-border-"+g,b&&!b.rock&&!i.rock&&i.miningBase&&(b.miningBase!==i.miningBase)&&(b.miningBase?(i.miningBase._iid>b.miningBase._iid):true))}a.append(c);if(i.resource){var e=jQuery('<div class="fl-resource"></div>');e.attr("fl-type",i.resource.id);a.append(e)}if(i.base){var j=jQuery('<div class="fl-base"></div>');j.attr("fl-player",i.base.player);a.append(j)}if(i.scouted[0]&&!i.visible[0]){a.append('<div class="fl-fog"></div>')}},_onMapMouseDown:function(b){b.preventDefault();var a=this._getCellByEl(jQuery(b.target));if(!a){return}switch(b.which){case 1:this._onLeftMouseDown(a);break;case 3:this._onRightMouseDown(a);break}},_onLeftMouseDown:function(a){if(this.collapsed){return}FL.sound("button");this.selectCell(a.ij);if(!this._isCellAutoSelectable(this.cellSelect)&&!this.endTurnAnimation.get()){this.selectNextAnimation.set(new FL.ButtonAnimation(this.getElement("next")))}},_onRightMouseDown:function(a){if(!this.data.isControllable()){return}var b=a.ij;if(this.order){if(!this.order.test.call(this.order.scope||this,b)){return}this.order.execute.call(this.order.scope||this,b);this.resetOrder();this.selectNextIfDone();return}if(!this.cellSelect){return}var d=this.cellSelect.unit;if(!d||(d.player!==0)){return}var e=FL.Vector.length8(FL.Vector.diff(b,d.ij.get()));if(e===0){d.ijTarget=null;this.selectNext();return}d.ijTarget=b;var c=this.data.moveUnit(d,this.unitSelection);if(!c){this.reselectCell()}else{if(c.alive&&c.movement.get()){this.selectCell(c.ij.get())}else{if(d.alive&&d.movement.get()){this.reselectCell()}else{this.selectNextIfDone()}}}},_onMapMouseOver:function(a){this.hoverCell=this._getCellByEl(jQuery(a.target));if(!this.hoverCell){this.hoverPath.set(null);return}this._updatePath(this.hoverPath,this.hoverPathColor,this.hoverCell?this.hoverCell.ij:null)},_onMapMouseLeave:function(a){this.hoverCell=null;this.hoverPath.set(null)},_getCellByEl:function(a){if(!a.hasClass("fl-monitor-cell")){a=a.parents(".fl-monitor-cell").eq(0)}if(!a.hasClass("fl-monitor-cell")){return null}var b=[+a.attr("fl-i"),+a.attr("fl-j")];return this.data.map.getCell(b)},_refreshSelectionQueue:function(){this.selectionQueue=[];this.selectionTail=0;this.data.units.each(function(a){if(this._isUnitAutoSelectable(a)){this.selectionQueue.push(a.ij.get())}},this);this.data.bases.each(function(b){var a=JW.Array.some(this.selectionQueue,function(c){return FL.Vector.equal(c,b.ij)},this);if(!a&&this._isBaseAutoSelectable(b)){this.selectionQueue.push(b.ij)}},this)
},_isUnitAutoSelectable:function(a){return(a!=null)&&(a.player===0)&&(a.movement.get()!==0)&&!a.hold&&!a.skipped&&!a.ijTarget},_isBaseAutoSelectable:function(a){return(a!=null)&&(a.player===0)&&(a.unitType.get()==null)},_isCellAutoSelectable:function(a){return(a!=null)&&(this._isUnitAutoSelectable(a.unit)||this._isBaseAutoSelectable(a.base))},_animateArrows:function(){var c=new Date().getTime()-this.beginTime;var a=360*JW.mod(c/this.arrowsRotationPeriod,1);var b=0.75+0.5*Math.abs(JW.smod(c/this.arrowsScalingPeriod,1));this.getElement("arrows").css("transform","rotate("+Math.round(a)+"deg) scale("+b.toFixed(3)+")")},_updatePath:function(d,b,c){if(this.distanceMatrix&&c){var a=this.data.backtracePath(this.distanceMatrix,c,0);if(a){d.set(new FL.Monitor.Path(a,b));return}}d.set(null)}});JW.UI.template(FL.Monitor,{main:'<div jwclass="fl-monitor"><div jwid="left-panel"><div jwid="buttons"><div jwid="turn-box">Turn: <span jwid="turn"></span></div><button jwid="surrender">Surrender</button> <button jwid="next">Select next</button> <button jwid="end-turn">End turn</button></div><div jwid="army"></div><div jwid="help"><div>Left mouse button - select unit or base.</div><div>Right mouse button - move unit.</div><div>&nbsp;</div><div>Units can\'t move from a tile near an enemy unit to another tile near an enemy unit. You must retreat, fight or defend in this case.</div><div>&nbsp;</div><div>Two units can\'t share the same tile. Beware: your base can\'t produce a unit if the tile is taken by another unit.</div></div></div><div jwid="map"><div jwid="cells"></div><div jwid="units"></div><div jwid="particles"></div><div jwid="path active-path"></div><div jwid="path hover-path"></div><div jwid="arrows"></div></div><div jwid="right-panel"><div jwid="panel"></div></div><div class="fl-clear"></div><div jwid="surrender-dialog">Are you sure you want to surrender?</div></div>'});FL.Monitor.Particle=function(a){FL.Monitor.Particle._super.call(this);this.particle=a};JW.extend(FL.Monitor.Particle,JW.UI.Component,{renderRoot:function(c){c.addClass("fl-monitor-particle");this.own(new FL.PositionUpdater(c,this.particle.xy));this.own(new JW.UI.CssUpdater(c,"background-color",this.particle.color));this.own(new JW.UI.CssUpdater(c,"opacity",this.particle.opacity));var a=this.own(new JW.Functor([this.particle.radius],function(d){return Math.round(d)+"px"},this)).target;this.own(new JW.UI.CssUpdater(c,"border-radius",a));var b=this.own(new JW.Functor([this.particle.radius],function(d){return Math.round(2*d)+"px"},this)).target;this.own(new JW.UI.CssUpdater(c,"width",b));this.own(new JW.UI.CssUpdater(c,"height",b))}});FL.Monitor.Path=function(b,a){FL.Monitor.Path._super.call(this);this.path=b;this.color=a};JW.extend(FL.Monitor.Path,JW.UI.Component,{renderRoot:function(d){for(var c=0;c<this.path.length;++c){var b=this.path[c][1];var e=FL.ijToXy(b);var a=jQuery('<div class="fl-monitor-path-dot"></div>');a.css({"background-color":this.color,"border-color":JW.Color.str(JW.Color.darken(this.color,0.5)),left:e[0]+"px",top:e[1]+"px"});d.append(a)}}});FL.baseNames=["Derico","Borul","Ulelu","Waldin","Nodonod","Isr","Enzi","Elgisan","Evaria","Mavoru","Tradeslife","Nundotraud","Geire","Stanindad","Frodlodi","Daur","Nolealbo","Itfreda","Rorico","Orroch","Isia","Rades","Ceer","Iseju","Tigano","Alrond","Oweld","Atifi","Thiroll","Rondoh","Mayo","Stanfrido","Milor","Zialbo","Wegrod","Tareti","Bhogrim","Taic","Elnelia","Ideset","Slavotraud","Noph","Orwold","Xogild","Lion","Egiven","Rioleif","Rin","Elara","Ernia","Adaku","Anvi","Gianna","Viotu","Crisco"];FL.infantryNames=["Alligators","Hyenas","Lions","Foxes","Raccoons","Tse Tse Flies","Boars","Bears","Leopards","Mosquitos","Piranhas","Dragons","Crocodiles","Cobras","Wolves","Eagles","Sharks","Frogs","Spiders","Fossas","Scorpions","Stalkers","Tigers","Jackals","Martens","Weasels","Polecats","Mongooses","Minks","Coatis","Lynxi","Cheetahs","Dholes","Meerkats","Otters"];FL.vehicleNames=["Centurions","Pattons","Devastators","Terminators","Dominators","Leopards","Chieftains","Vickers","Elephants","Challengers","Vultures","Goliaphs","Wraiths","Ghosts","Tortoises","Comets","Meteors","Centaurs","Valkyries","Corsairs","Crusaders","Chariots","Conquerors","Liberty","Swarm","Locust","Punishers","Bulldogs","Storm","Priests"];FL.Panel=function(b,a){FL.Panel._super.call(this);this.monitor=b;this.cell=a};JW.extend(FL.Panel,JW.UI.Component,{renderTerrainName:function(a){if(!this.cell.scouted[0]){}else{if(this.cell.rock){a.text("Mountain")}else{if(this.cell.hill){a.text("Hill")}else{a.text("Plain")}}}},renderTerrainDescription:function(a){if(!this.cell.scouted[0]){a.text("This area is not scouted yet.")}else{if(this.cell.rock){a.text("Doesn't make production. Units can not pass.")}else{if(this.cell.hill){a.html('Improves defense and sight. Production: <span class="fl-id">2</span>.')}else{a.html('Increases production by <span class="fl-id">1</span>.')}}}},renderResourceName:function(a){if(this.cell.scouted[0]&&this.cell.resource){a.text(this.cell.resource.name)}},renderResourceDescription:function(a){if(this.cell.scouted[0]&&this.cell.resource){a.html(this.cell.resource.descriptionHtml)}},renderBase:function(){if(this.cell.visible[0]&&this.cell.base&&(this.cell.base.player===0)){return this.own(new FL.Panel.Base(this.cell.base))}}});JW.UI.template(FL.Panel,{main:'<div jwclass="fl-panel"><div jwid="terrain block"><div jwid="terrain-name" class="fl-title"></div><div jwid="terrain-description"></div></div><div jwid="resource block"><div jwid="resource-name" class="fl-title"></div><div jwid="resource-description"></div></div><div jwid="base block"></div></div>'});FL.Panel.Base=function(a){FL.Panel.Base._super.call(this);this.base=a;this.selectAnimation=this.own(new JW.Property()).ownValue()};JW.extend(FL.Panel.Base,JW.UI.Component,{renderName:function(a){a.text(this.base.name)},renderDefense:function(a){var b=this.base.health.get();a.html(((b===1)?('<span class="fl-good">'+FL.baseArmor+"</span>"):('<span class="fl-bad">'+(FL.baseArmor*b).toFixed(1)+"</span>")))},renderArmor:function(a){a.text(FL.baseArmor)},renderMining:function(a){a.text(this.base.mining)},renderUnitsBox:function(a){a.width(16*FL.Unit.typeArray.length+"px");if(this.base.unitType.get()){return}this.selectAnimation.set(new FL.AlternateAnimation({updater:function(b){a.css("background",JW.Color.str(JW.Color.gradient("#FFF","#BFB",b)));a.css("border-color",JW.Color.str(JW.Color.gradient("#FFF","#0F0",b)));a.css("color",JW.Color.str(JW.Color.gradient("#BFB","#0D0",b)))},finish:function(b){a.css("background","");a.css("border-color","");a.css("color","")},scope:this}));this.own(this.base.unitType.changeEvent.bind(function(){this.selectAnimation.set(null)},this))},renderSelectProduction:function(a){var b=this.own(new JW.Functor([this.base.unitType],function(c){return !c},this)).target;this.own(new JW.UI.VisibleUpdater(a,b))},renderUnits:function(){return JW.Array.$map(FL.Unit.typeArray,function(a){return this.own(new FL.Panel.UnitButton(this.base,a))},this)},renderProduction:function(){return this.own(new JW.Mapper([this.base.unitType],{createValue:function(a){return new FL.Panel.Production(this.base)},destroyValue:JW.destroy,scope:this})).target}});JW.UI.template(FL.Panel.Base,{main:'<div jwclass="fl-panel-base"><div class="fl-title">Base <span jwid="name" class="fl-id"></span></div><div class="fl-title">Defense: <span jwid="defense"></span>/<span jwid="armor" class="fl-id"></span></div><div class="fl-title">Production: <span jwid="mining" class="fl-id"></span></div><div jwid="units-box"><div jwid="select-production">Select production</div><div jwid="units"></div></div><div jwid="production"></div></div>'});FL.Panel.Order=function(){FL.Panel.Order._super.call(this)};JW.extend(FL.Panel.Order,JW.UI.Component,{renderRoot:function(a){a.text("Right mouse button - issue order")}});FL.Panel.Production=function(a){FL.Panel.Production._super.call(this);this.base=a;this.type=this.base.unitType.get()};JW.extend(FL.Panel.Production,JW.UI.Component,{progressWidth:150,renderProgress:function(c){c.css("width",this.progressWidth+"px");
if(!this.base.mining){return}var d=this.base.overflow+this.base.production[this.type.id];var e=this._getOffset(d);c.append('<div class="fl-panel-production-progress-fill" style="width: '+e+'px"></div>');while(d<this.type.cost){var b=d+this.base.mining;var a=this._getOffset(b);c.append('<div class="fl-panel-production-progress-fill" style="width: '+(a-e)+'px"></div>');d=b;e=a}},renderTurns:function(b){if(!this.base.mining){return}var c=this.base.overflow+this.base.production[this.type.id];var a=Math.ceil((this.type.cost-c)/this.base.mining);b.text(a+" turn"+((a!==1)?"s":""))},renderUnit:function(){return this.own(new FL.UnitInfo(this.type,this.base.player,true))},_getOffset:function(a){return Math.round(this.progressWidth*Math.min(1,a/this.type.cost))}});JW.UI.template(FL.Panel.Production,{main:'<div jwclass="fl-panel-production"><div jwid="progress"></div><div jwid="turns"></div><div class="clear"></div><div jwid="unit"></div></div>'});FL.Panel.Unit=function(a,b){FL.Panel.Unit._super.call(this);this.monitor=a;this.unit=b;this.blocksProduction=a.data.isUnitBlockProduction(b.cell.base);this.requiresAction=a._isUnitAutoSelectable(b)};JW.extend(FL.Panel.Unit,JW.UI.Component,{renderName:function(a){a.text(this.unit.name[0]+" #"+this.unit.name[1])},renderHeader:function(){return this.own(new FL.UnitInfo.Header(this.unit.type,this.unit.player))},renderPersons:function(){return JW.Array.$map(this.unit.persons.get(),function(b,a){return this.own(new FL.Panel.UnitPerson(this.unit,this.monitor.unitSelection,a))},this)},renderLeave:function(a){if((this.unit.player!==0)||!this.blocksProduction){return false}this.own(new FL.AlternateAnimation({updater:function(b){a.css("background",JW.Color.str(JW.Color.gradient("#FFF","#FBB",b)));a.css("border-color",JW.Color.str(JW.Color.gradient("#FFF","#F00",b)));a.css("color",JW.Color.str(JW.Color.gradient("#FBB","#D00",b)))},finish:function(b){a.css("background","");a.css("border-color","");a.css("color","")},scope:this}))},renderButtons:function(a){return this.unit.player===0},renderHold:function(a){if(!this.unit.isHealed()){if(this.requiresAction&&!this.blocksProduction){this.own(new FL.ButtonAnimation(a))}a.text("Heal")}a.click(JW.inScope(function(){FL.sound("hold-position");this.unit.hold=true;this.monitor._updateCell(null,this.unit.ij.get());this.monitor.selectNextIfDone()},this))},renderSkip:function(a){a.click(JW.inScope(function(){FL.sound("hold-position");this.unit.hold=false;this.unit.skipped=true;this.monitor._updateCell(null,this.unit.ij.get());this.monitor.selectNextIfDone()},this))},renderBuild:function(a){if((this.unit.type.id!=="mcv")||(this.unit.movement.get()===0)){return false}if(!this.monitor.data.isBaseBuildable(this.unit.ij.get(),FL.minBaseDistanceSqr)){return false}if(this.requiresAction){this.own(new FL.ButtonAnimation(a))}a.click(JW.inScope(function(){this.monitor.data.buildBase(this.unit);this.monitor.selectCell(this.unit.ij.get())},this))},renderDrop:function(a){if(!this.unit.canDrop()){return false}if(this.requiresAction){this.own(new FL.ButtonAnimation(a))}a.click(JW.inScope(function(){var c=this.unit;var b=this.monitor;var d=this.monitor.data;b.getElement("cells").addClass("fl-order-paradrop");this.monitor.initOrder({test:function(e){return d.isDroppable(e,0)},execute:function(e){c.drop(e)},finish:function(){b.getElement("cells").removeClass("fl-order-paradrop")},scope:this})},this))},renderStats:function(){return this.own(new FL.UnitInfo.Stats(this.unit.type,false))}});JW.UI.template(FL.Panel.Unit,{main:'<div jwclass="fl-panel-unit"><div jwid="title" class="fl-title">Squad <span jwid="name" class="fl-id"></span></div><div jwid="header"></div><div jwid="persons"></div><div jwid="leave">This squad blocks unit production at the next turn and should leave the base!</div><div jwid="buttons"><button jwid="skip">Skip turn</button> <button jwid="hold">Hold position</button> <button jwid="build">Build base</button> <button jwid="drop">Paradrop</button></div><div jwid="stats"></div></div>'});FL.Panel.UnitButton=function(b,a){FL.Panel.UnitButton._super.call(this);this.base=b;this.type=a};JW.extend(FL.Panel.UnitButton,JW.UI.Component,{renderRoot:function(a){a.click(JW.UI.preventDefault);a.attr("fl-type",this.type.id);if(this.base.isUnitTypeAvailable(this.type)){a.attr("title",'Produce <span class="fl-id">'+this.type.name+'</span> (cost:&nbsp;<span class="fl-id">'+this.type.cost+"</span>)");a.attr("fl-player",this.base.player);a.click(JW.inScope(function(c){FL.sound("production-selected");this.base.unitType.set(this.type)},this))}else{var b=JW.Array.map(this.type.resources,function(c){return'<span class="fl-id">'+FL.Resource.types[c].name+"</span>"},this);a.attr("title",'<span class="fl-id">'+this.type.name+"</span> requires "+b.join(", "))}}});JW.UI.template(FL.Panel.UnitButton,{main:'<a href="#" class="fl-panel-unitbutton fl-unit blocklink"></a>'});FL.Panel.UnitPerson=function(c,b,a){FL.Panel.UnitPerson._super.call(this);this.unit=c;this.selection=b;this.index=a;this.person=c.persons.get()[a]};JW.extend(FL.Panel.UnitPerson,JW.UI.Component,{healthWidth:60,renderRoot:function(a){if(this.unit.player!==0){return}a.toggleClass("fl-selected",this.selection[this.index]);a.mousedown(JW.UI.preventDefault);a.click(JW.inScope(function(){this.selection[this.index]=!this.selection[this.index];a.toggleClass("fl-selected",this.selection[this.index])},this))},renderHealthValue:function(a){var b=this.person.health;a.text((this.unit.type.armor*b).toFixed(1));a.addClass((b===1)?"fl-good":"fl-bad")},renderHealth:function(a){a.css("width",this.healthWidth+"px")},renderHealthFill:function(a){a.css("width",Math.floor(this.healthWidth*this.person.health)+"px");a.css("background",FL.getHealthColor(this.person.health))},renderMovement:function(b){for(var a=this.unit.type.movement-1;a>=0;--a){b.append('<div class="fl-panel-unitperson-movement-point '+(a<this.person.movement?"fl-remaining":"fl-spent")+'"></div>')}},renderAttack:function(){return(this.unit.player===0)&&(this.unit.type.damage!==0)&&this.person.attack},renderDefend:function(){return(this.unit.player!==0)&&(this.unit.type.damage!==0)&&this.person.defend},renderFortified:function(){return(this.unit.type.defense!==0)&&this.person.fortified}});JW.UI.template(FL.Panel.UnitPerson,{main:'<div jwclass="fl-panel-unitperson"><div jwid="health-value" title="Unit armor"></div><div jwid="right"><div jwid="health" title="Unit armor"><div jwid="health-fill"></div></div><div jwid="status"><div jwid="movement" title="Movement points"></div><div jwid="fortified" title="This unit is fortified and has a defensive bonus"></div><div jwid="defend" title="This unit can strike in defense at this turn"></div><div jwid="attack" title="This unit can attack at this turn"></div><div class="clear"></div></div></div><div class="clear"></div></div>'});FL.PositionUpdater=function(a,b){FL.PositionUpdater._super.call(this);this.el=a;this.own(new JW.Updater([b],function(c){this.el.css({left:Math.round(c[0])+"px",top:Math.round(c[1])+"px"})},this))};JW.extend(FL.PositionUpdater,JW.Class);FL.Resource={initDescription:function(){JW.Array.each(FL.Resource.typeArray,function(c){var a="";if(c.description){a+=c.description+"<br>"}if(c.bonus){a+='Increases production by <span class="fl-id">'+c.bonus+"</span>.<br>"}var b=JW.Array.filter(FL.Unit.typeArray,function(e){return(e.resources!=null)&&JW.Array.containsItem(e.resources,c.id)});if(b.length){var d=JW.Array.map(b,function(e){return'<span class="fl-id">'+e.name+"</span>"});a+="Required to produce units: "+d.join(", ")+"<br />"}c.descriptionHtml=a})}};FL.Resource.typeArray=[{id:"copper",name:"Copper",bonus:4,count:20,profit:4,},{id:"iron",name:"Iron",bonus:6,count:15,profit:6},{id:"oil",name:"Oil",bonus:10,count:10,profit:10},{id:"aluminum",name:"Aluminum",bonus:15,count:5,profit:15},{id:"yard",name:"Advanced training yard",count:10,deniedAtStart:true,minDistanceSqr:30,aiProduction:true,profit:10},{id:"light",name:"Light vehicle factory",count:10,deniedAtStart:true,minDistanceSqr:30,aiProduction:true,profit:12},{id:"heavy",name:"Heavy vehicle factory",count:6,deniedAtStart:true,minDistanceSqr:50,aiProduction:true,profit:15},{id:"airport",name:"Airport",description:"Drops paratroopers to any visible tile.",count:4,deniedAtStart:true,minDistanceSqr:100,aiProfit:8,profit:8}];
FL.Resource.types=JW.Array.index(FL.Resource.typeArray,JW.byField("id"));FL.ScreenWin=function(a){FL.ScreenWin._super.call(this);this.win=a;localStorage.wins=+(localStorage.wins||0);localStorage.losses=+(localStorage.losses||0);localStorage.wisdom=+(localStorage.wisdom||0)+1;if(a){FL.sound("win");localStorage.wins=+localStorage.wins+1}else{FL.sound("lose");localStorage.losses=+localStorage.losses+1}};JW.extend(FL.ScreenWin,JW.UI.Component,{renderTitle:function(a){a.text(this.win?"You win!":"You lost...")},renderWins:function(a){a.text(localStorage.wins)},renderLosses:function(a){a.text(localStorage.losses)},renderDifficulty:function(a){a.text(Math.round(FL.AI.productionCoef*100))},renderDifficultyModifier:function(a){if(this.win){a.text("+"+Math.round(FL.AI.productionCoefPerWin*100))}else{a.text("-"+Math.round(FL.AI.productionCoefPerLoss*100))}},renderClear:function(a){a.click(JW.inScope(function(b){b.preventDefault();localStorage.wins=0;localStorage.losses=0;this.getElement("wins").text(0);this.getElement("losses").text(0);this.getElement("difficulty").text(100);this.getElement("difficulty-modifier").text(0)},this))},renderWisdom:function(a){a.text(FL.ScreenWin.wisdoms[+localStorage.wisdom%FL.ScreenWin.wisdoms.length])}});FL.ScreenWin.wisdoms=["Soldiers usually win the battles and generals get the credit for it. -- Napoleon","The tragedy of war is that it uses man's best to do man's worst.","The Fourth World War will be fought with stones. -- Einstein","Diplomats are just as essential in starting a war as soldiers in finishing it. -- Rogers","There is no such thing as an inevitable war. If war comes it will be from failure of human wisdom. -- Law","Dictators ride to and from on tigers from which they dare not dismount. And the tigers are getting hungry. -- Churchill"];JW.UI.template(FL.ScreenWin,{main:'<div jwclass="fl-screen-win"><div jwid="title"></div><div jwid="statistics"><div><div jwid="statistics-left">Wins:</div><div jwid="statistics-right wins"></div><div class="fl-clear"></div></div><div><div jwid="statistics-left">Losses:</div><div jwid="statistics-right losses"></div><div class="fl-clear"></div></div><div><div jwid="statistics-left">Difficulty played:</div><div jwid="statistics-right"><span jwid="difficulty"></span>% (<span jwid="difficulty-modifier"></span>%)</div><div class="fl-clear"></div></div></div><a jwid="clear" class="fl-blocklink" href="#">Reset statistics and difficulty</a><div jwid="wisdom"></div><a jwid="refresh" class="fl-blocklink" href="javascript:location.reload()">Start again to find more wisdom</a></div>'});FL.Unit=function(e,b,a,c,d){FL.Unit._super.call(this);this.data=e;this.ij=this.own(new JW.Property(b));this.player=a;this.type=c;this.movement=this.own(new JW.Property(this.type.movement));this.cell=null;this.ijTarget=null;this.name=["Unnamed",1];this.hold=false;this.skipped=false;this.behaviour=d||c.ai[FL.random(c.ai.length)];this.visible=[false,true];this.persons=this.own(new JW.Property([new FL.Unit.Person(c)]));this.alive=true;this.xy=this.own(new JW.Property(FL.ijToXy(this.ij.get())));this.opacity=this.own(new JW.Property(0));this.animations=[];this.ijSwitcher=this.own(new JW.Property(new JW.Switcher([this.ij],{init:function(g){this.cell=this.data.map.getCell(g);if(!this.cell.unit){this.cell.setUnit(this)}this.data.reveal(g,this.getSightRangeSqr(),this.player);var f=this.visible[0]||this.cell.visible[0];this.setVisible(this.cell.visible[0],0);if(!f&&!this.animations.length){this.resetAnimation()}else{var h=f?new FL.Unit.MovementAnimation(this):new FL.Unit.JumpAnimation(this);this.animations.push(h);this.data.animationManager.enqueue(this)}},done:function(f){if(this.cell.unit===this){this.cell.setUnit(null)}},scope:this}))).ownValue()};JW.extend(FL.Unit,JW.Class,{destroy:function(){this.alive=false;this.movement.set(0);this._super()},kill:function(){if(!this.alive){return}this.alive=false;this.ijSwitcher.set(null)},resetAnimation:function(){this.animations=[];this.xy.set(FL.ijToXy(this.ij.get()));this.opacity.set(this.visible[0]?1:0)},getCount:function(){return this.persons.get().length},getAttackCount:function(){return JW.Array.count(this.persons.get(),JW.byField("attack"))},getDefendCount:function(){return JW.Array.count(this.persons.get(),JW.byField("defend"))},getSightRangeSqr:function(){return this.cell.hill?this.type.sightRangeSqrHill:this.type.sightRangeSqr},getShotAnimation:function(){return this.type.shotAnimation},getDeathAnimation:function(){return this.type.deathAnimation},getCenter:function(){return FL.Vector.add(this.xy.get(),[FL.cellSize/2,FL.cellSize/2])},onBattleFinish:function(){if(!this.alive){this.data.destroyUnit(this)}},merge:function(a){this.setPersons(a.concat(this.persons.get()));this.ijTarget=null},split:function(b){var a=[];var d=[];JW.Array.filter(this.persons.get(),function(f,e){if(!b||b[e]){a.push(f)}else{d.push(f)}},this);this.setPersons(d);var c=this.data.createUnit(this.ij.get(),this.player,this.type,this.behaviour,this.name[0]);c.ijTarget=this.ijTarget;this.ijTarget=null;c.setPersons(a);return c},setPersons:function(a,b){if(a.length===0){if(b){this.kill()}else{this.data.destroyUnit(this)}}else{this.persons.set(JW.Array.toSorted(a,JW.byField("health"),this,-1));this.movement.set(Math.min.apply(Math,JW.Array.map(a,JW.byField("movement"))))}},retainAttacks:function(a){this.setPersons(JW.Array.map(this.persons.get(),function(b){if(b.attack){if(a){--a}else{if(!this.type.blitz){b.attack=false}b.fortified=false;--b.movement}}return b},this))},retainDefends:function(a){if(this.type.cover){return}this.setPersons(JW.Array.map(this.persons.get(),function(b){if(b.defend){b.defend=(--a>=0)}return b},this))},decreaseMovement:function(){this.setPersons(JW.Array.map(this.persons.get(),function(a){a.decreaseMovement();return a},this))},isHealed:function(){return JW.Array.every(this.persons.get(),JW.byValue("health",1))},heal:function(){var a=this.isHealed();this.setPersons(JW.Array.map(this.persons.get(),JW.byMethod("heal")));if(!a&&this.isHealed()){this.hold=false}},refresh:function(){this.setPersons(JW.Array.map(this.persons.get(),JW.byMethod("refresh")));this.skipped=false},canDrop:function(){return this.type.paradroppable&&(this.movement.get()!==0)&&this.cell.isAirportBy(this.player)},drop:function(a){this.decreaseMovement();this.ijTarget=null;this.hold=false;this.ij.set(a);if(this.visible[0]){FL.sound("paradrop")}this.data.mapUpdateEvent.trigger()},setVisible:function(b,a){if(this.visible[a]===b){return}this.visible[a]=b;if(b&&(a===0)&&(this.player!==0)&&!this.data.enemyScouted&&!FL.revealAll){this.data.enemyScouted=true;FL.sound("enemy-units-approaching")}}});FL.Unit.shotAnimations={rifle:{sound:"rifle",countPerDamage:8,originCount:1,spreadCount:1,originDistance:0.5,spreadDistance:0,particle:{color:"#FFF",opacity:1,radius:0.04,duration:200}},lightCannon:{sound:"light-cannon",countPerDamage:2,originCount:1,spreadCount:1,originDistance:0.5,spreadDistance:0,particle:{colorFrom:"#FF0",colorTo:"#000",opacityFrom:1,opacityTo:0,radius:0.2,duration:1000}},heavyCannon:{sound:"heavy-cannon",countPerDamage:0.5,originCount:1,spreadCount:1,originDistance:0.5,spreadDistance:0,particle:{colorFrom:"#FF0",colorTo:"#000",opacityFrom:1,opacityTo:0,radius:0.3,duration:1200}}};FL.Unit.deathAnimations={mcv:{sound:"death-heavy",originCount:1,spreadCount:1,originDistance:0,spreadDistance:0,particle:{colorFrom:"#FFF",colorTo:"#FF0",opacityFrom:1,opacityTo:0.2,radiusFrom:0.2,radiusTo:1,duration:1500}},infantry:{sound:"death-infantry",originCount:2,spreadCount:4,originDistance:0.3,spreadDistance:0.6,particle:{color:"#D00",opacity:0.8,radius:0.05,duration:500}},lightVehicle:{sound:"death-light",originCount:1,spreadCount:1,originDistance:0.3,spreadDistance:0,particle:{colorFrom:"#FFF",colorTo:"#FF0",opacityFrom:1,opacityTo:0.2,radiusFrom:0.15,radiusTo:0.5,duration:1000}},heavyVehicle:{sound:"death-heavy",originCount:1,spreadCount:1,originDistance:0.2,spreadDistance:0,particle:{colorFrom:"#FFF",colorTo:"#FF0",opacityFrom:1,opacityTo:0.2,radiusFrom:0.2,radiusTo:0.8,duration:1200}}};
FL.Unit.typeArray=[{id:"mcv",name:"Mobile Construction Vehicle",description:'<div class="fl-skill">- Can build a new base</div>',damage:0,armor:5,defense:0,healRate:0.1,movement:1,sightRangeSqr:2,sightRangeSqrHill:5,cost:300,ai:["build"],capacity:1,aiPreferred:true,naming:"worker",shotAnimation:FL.Unit.shotAnimations.rifle,deathAnimation:FL.Unit.deathAnimations.mcv,movementSound:"move-infantry"},{id:"militia",name:'Militia "Meat shield"',description:'<div class="fl-info">Weak defensive unit. Used for base defense in emergencies. Can be used for scouting in the early stages of the game. In the late game, can be used to slow down the enemy forces.</div>',damage:1,armor:3,defense:1.5,healRate:0.1,movement:1,sightRangeSqr:2,sightRangeSqrHill:5,cost:50,ai:["hold","rush"],capacity:5,aiPreferred:false,naming:"infantry",shotAnimation:FL.Unit.shotAnimations.rifle,deathAnimation:FL.Unit.deathAnimations.infantry,movementSound:"move-infantry"},{id:"infantry",name:'Infantry "Cannon fodder"',description:'<div class="fl-info">Spendable attacking unit. Can be used for early push and weakening the enemy defenses, but requires protection.</div>',damage:2,armor:3,defense:0,healRate:0.1,movement:1,sightRangeSqr:2,sightRangeSqrHill:5,cost:60,ai:["attack"],capacity:5,aiPreferred:false,naming:"infantry",shotAnimation:FL.Unit.shotAnimations.rifle,deathAnimation:FL.Unit.deathAnimations.infantry,movementSound:"move-infantry"},{id:"marine",name:'Marine "Hotheads"',description:'<div class="fl-skill">- Has enhanced heal rate</div><div class="fl-info">Strong defensive unit. Increased heal rate and low cost make them essential in the choke points protection.</div>',damage:2,armor:4,defense:2,healRate:0.2,movement:1,sightRangeSqr:5,sightRangeSqrHill:10,cost:80,resources:["yard"],ai:["hold","rush"],capacity:5,aiPreferred:true,naming:"infantry",shotAnimation:FL.Unit.shotAnimations.rifle,deathAnimation:FL.Unit.deathAnimations.infantry,movementSound:"move-infantry"},{id:"paratrooper",name:'Paratrooper "Here\'s Jonny!"',description:'<div class="fl-skill">- Can be paradropped</div><div class="fl-info">Strong attacking unit. Has very slow movement speed but can be paradropped to any visible point of the map from a secured airport.</div>',damage:3,armor:5,defense:0,healRate:0.1,movement:1,sightRangeSqr:5,sightRangeSqrHill:10,cost:100,resources:["yard"],paradroppable:true,ai:["drop"],capacity:5,aiPreferred:true,naming:"infantry",shotAnimation:FL.Unit.shotAnimations.rifle,deathAnimation:FL.Unit.deathAnimations.infantry,movementSound:"move-infantry"},{id:"humvee",name:'Hum-Vee "Us will not catch up"',description:'<div class="fl-info">Low-armored, fast unit. High movement speed makes it essential in scouting, rushing enemy bases and supporting the main forces.</div>',damage:2,armor:4,defense:0,healRate:0.1,movement:3,sightRangeSqr:5,sightRangeSqrHill:10,cost:80,resources:["light"],ai:["patrol","attack"],capacity:5,aiPreferred:true,naming:"vehicle",shotAnimation:FL.Unit.shotAnimations.rifle,deathAnimation:FL.Unit.deathAnimations.lightVehicle,movementSound:"move-light"},{id:"radar",name:'Radar vehicle "Eye of Sauron"',description:'<div class="fl-skill">- Has enhanced sight range</div><div class="fl-info">Strong defensive unit. High sight range lets it see the enemy forces from the distance and provide nasty drop locations for paratroopers.</div>',damage:2,armor:5,defense:2.5,healRate:0.1,movement:2,sightRangeSqr:18,sightRangeSqrHill:27,bombRangeSqr:12,bombAttack:2,cost:125,resources:["light"],ai:["patrol","hold","rush"],capacity:5,aiPreferred:true,naming:"vehicle",shotAnimation:FL.Unit.shotAnimations.lightCannon,deathAnimation:FL.Unit.deathAnimations.lightVehicle,movementSound:"move-light"},{id:"tank",name:'Tank "Shushpanzer"',description:'<div class="fl-skill">- Can attack twice in one turn</div><div class="fl-info">Powerful attacking unit. Has the highest damage and armor values among all units in the game.</div>',damage:4,armor:10,defense:0,healRate:0.1,movement:2,sightRangeSqr:5,sightRangeSqrHill:10,cost:200,resources:["heavy"],ai:["attack"],blitz:true,capacity:3,aiPreferred:true,naming:"vehicle",shotAnimation:FL.Unit.shotAnimations.heavyCannon,deathAnimation:FL.Unit.deathAnimations.heavyVehicle,movementSound:"move-heavy"},{id:"mobile",name:'"Wunderwaffe" mobile site',description:'<div class="fl-skill">- Can strike in defense multiple times in one turn</div><div class="fl-info">Powerful defensive unit. Has the highest defensive armor value among all units in the game.</div>',damage:3,armor:8,defense:4,healRate:0.1,movement:2,sightRangeSqr:5,sightRangeSqrHill:10,cost:200,resources:["heavy"],ai:["patrol","assaulting","rush"],cover:true,capacity:3,aiPreferred:true,naming:"vehicle",shotAnimation:FL.Unit.shotAnimations.lightCannon,deathAnimation:FL.Unit.deathAnimations.heavyVehicle,movementSound:"move-heavy"}];FL.Unit.baseType={id:"base",name:"Base",damage:0,armor:10,defense:0,movement:0};FL.Unit.types=JW.Array.index(FL.Unit.typeArray,JW.byField("id"));FL.Unit.Animation=function(a){FL.Unit.Animation._super.call(this);this.unit=a;this.inited=false};JW.extend(FL.Unit.Animation,JW.Class,{immediate:false,init:function(){}});FL.Unit.BattleAnimation=function(f,b,e,d,a,c,g){FL.Unit.BattleAnimation._super.call(this,b);this.data=f;this.attackerSide=new FL.Unit.BattleAnimation.Side(this.data,a,b,e,d);this.defenderSide=new FL.Unit.BattleAnimation.Side(this.data,b,a,c,g);this.speed=this.animationsPerSecond/FL.animationStepsPerSecond;this.progress=0;this.duration=0};JW.extend(FL.Unit.BattleAnimation,FL.Unit.Animation,{animationsPerSecond:1,animate:function(){this.progress=Math.min(1,this.progress+this.speed);this.attackerSide.animate(this.progress);this.defenderSide.animate(this.progress);return this.progress===1}});FL.Unit.BattleAnimation.Side=function(e,b,a,d,c){FL.Unit.BattleAnimation.Side._super.call(this);this.data=e;this.attacker=b;this.defender=a;this.damage=d;this.victims=c;this.shots=0;this.shotAnimation=this.attacker.getShotAnimation();this.deathAnimation=this.defender.getDeathAnimation()};JW.extend(FL.Unit.BattleAnimation.Side,JW.Class,{animate:function(b){var a=this.defender.getCenter();if(this.shotAnimation){var d=Math.round(this.shotAnimation.countPerDamage*b*this.damage);while(this.shots<d){++this.shots;this.data.animationManager.addParticles(a,this.shotAnimation)}}if(b===1){for(var c=0;c<this.victims;++c){this.data.animationManager.addParticles(a,this.deathAnimation)}this.defender.onBattleFinish()}}});FL.Unit.JumpAnimation=function(a){FL.Unit.JumpAnimation._super.call(this,a);this.xyTo=FL.ijToXy(a.ij.get());this.opacityTo=a.visible[0]?1:0};JW.extend(FL.Unit.JumpAnimation,FL.Unit.Animation,{immediate:true,animate:function(){this.unit.xy.set(this.xyTo);this.unit.opacity.set(this.opacityTo);return true}});FL.Unit.MovementAnimation=function(a){FL.Unit.MovementAnimation._super.call(this,a);this.xyFrom=null;this.opacityFrom=null;this.xyTo=FL.ijToXy(a.ij.get());this.opacityTo=a.visible[0]?1:0;this.speed=this.animationsPerSecond*a.type.movement/FL.animationStepsPerSecond;this.progress=0;this.func=null;this.duration=0};JW.extend(FL.Unit.MovementAnimation,FL.Unit.Animation,{animationsPerSecond:4,animate:function(){if(!this.xyFrom){this.xyFrom=this.unit.xy.get();this.opacityFrom=this.unit.opacity.get();this.func=(this.unit.animations.length===1)?this._slowDownFunc:this._flatFunc;this.duration=(this.unit.animations.length===1)?2:1}this.progress=Math.min(this.duration,this.progress+this.speed);var a=this.func(this.progress);this.unit.xy.set(FL.Vector.between(this.xyFrom,this.xyTo,a));this.unit.opacity.set((1-a)*this.opacityFrom+a*this.opacityTo);return this.progress===this.duration},_slowDownFunc:function(a){return a-a*a/4},_flatFunc:function(a){return a}});FL.Unit.Person=function(a){FL.Unit.Person._super.call(this);this.type=a;this.health=1;this.movement=a?a.movement:0;this.attack=true;this.defend=true;this.fortified=false};JW.extend(FL.Unit.Person,JW.Class,{clone:function(){var a=new FL.Unit.Person(this.type);
a.health=this.health;a.movement=this.movement;a.attack=this.attack;a.defend=this.defend;a.fortified=this.fortified;return a},decreaseMovement:function(){if(--this.movement===0){this.attack=false}this.fortified=false},heal:function(){if(!this.fortified){return this}var a=this.clone();a.health=FL.heal(this.health,this.type.healRate);return a},refresh:function(){var a=new FL.Unit.Person(this.type);a.health=this.health;a.fortified=(this.movement===this.type.movement);a.movement=this.type?this.type.movement:0;a.attack=true;a.defend=true;return a}});FL.UnitInfo=function(c,b,a){FL.UnitInfo._super.call(this);this.type=c;this.player=b||0;this.showCost=a||false};JW.extend(FL.UnitInfo,JW.UI.Component,{renderHeader:function(){return this.own(new FL.UnitInfo.Header(this.type,this.player))},renderStats:function(){return this.own(new FL.UnitInfo.Stats(this.type,this.showCost))}});JW.UI.template(FL.UnitInfo,{main:'<div jwclass="fl-unitinfo"><div jwid="header"></div><div jwid="stats"></div></div>'});FL.UnitInfo.Header=function(b,a){FL.UnitInfo.Header._super.call(this);this.type=b;this.player=a||0};JW.extend(FL.UnitInfo.Header,JW.UI.Component,{renderIcon:function(a){a.attr("fl-type",this.type.id);a.attr("fl-player",this.player)},renderName:function(a){a.text(this.type.name)}});JW.UI.template(FL.UnitInfo.Header,{main:'<div jwclass="fl-unitinfo-header"><div jwid="icon" class="fl-unit"></div> <span jwid="name"></span></div>'});FL.UnitInfo.Stats=function(b,a){FL.UnitInfo.Stats._super.call(this);this.type=b;this.showCost=a||false};JW.extend(FL.UnitInfo.Stats,JW.UI.Component,{renderDamageBox:function(){return this.type.damage!==0},renderDamage:function(a){a.text(this.type.damage)},renderArmorBox:function(){return this.type.armor!==0},renderArmor:function(a){a.text(this.type.armor)},renderDefenseBox:function(){return this.type.defense!==0},renderDefense:function(a){a.text(Math.round(100*this.type.defense/this.type.armor)+"%")},renderHealRate:function(a){a.text(Math.round(100*this.type.healRate)+"%")},renderMovement:function(a){a.text(this.type.movement)},renderCostBox:function(a){return this.showCost},renderCost:function(a){a.text(this.type.cost)},renderCapacity:function(a){a.text(this.type.capacity)},renderDescription:function(a){a.html(this.type.description)}});JW.UI.template(FL.UnitInfo.Stats,{main:'<div jwclass="fl-unitinfo-stats"><div jwid="damage-box"><span title="Damage dealt to enemy unit in an attack or a defensive strike"> Damage: <span jwid="damage" class="fl-id"></span></span></div><div jwid="armor-box"><span title="Maximum number of hit points"> Armor: <span jwid="armor" class="fl-id"></span></span></div><div jwid="defense-box"><span title="Bonus to armor in defense, plus one if the unit is positioned on a hill, plus one if unit is fortified (i.e. didn\'t move last turn). So, this bonus can stack up to 3 times"> Defense bonus: <span jwid="defense" class="fl-id"></span></span></div><div jwid="heal-rate-box"><span title="Number of hit points replenished per turn if unit doesn\'t move"> Heal rate: <span jwid="heal-rate" class="fl-id"></span></span></div><div jwid="movement-box"><span title="Number of movement points"> Movement: <span jwid="movement" class="fl-id"></span></span></div><div jwid="cost-box"><span title="Total amount of production neccessary to spawn this unit in a base"> Cost: <span jwid="cost" class="fl-id"></span></span></div><div jwid="capacity-box"><span title="Maximum number of units in a squad. Units in a squad fight together which makes them tougher and stronger"> Squad limit: <span jwid="capacity" class="fl-id"></span></span></div><div jwid="description"></div></div>'});FL.UnitNameList=function(a){FL.UnitNameList._super.call(this);this.names=a;this.counts=JW.Array.$index(a,JW.byField()).map(function(){return 0})};JW.extend(FL.UnitNameList,JW.Class,{checkout:function(a){var a=a||this.names[FL.random(this.names.length)];return[a,++this.counts[a]]}});FL.UnitView=function(a){FL.UnitView._super.call(this);this.unit=a};JW.extend(FL.UnitView,JW.UI.Component,{renderRoot:function(b){b.addClass("fl-unit fl-monitor-unit");b.attr("fl-type",this.unit.type.id);b.attr("fl-player",this.unit.player);this.own(new FL.PositionUpdater(b,this.unit.xy));this.own(new JW.UI.CssUpdater(b,"opacity",this.unit.opacity));this.own(new JW.Updater([this.unit.persons],function(c){b.html(JW.Array.map(c,function(e){var d=FL.getHealthColor(e.health);return('<div class="fl-monitor-unit-health"><div class="fl-monitor-unit-health-point" style="background-color: '+d+';"></div></div>')},this).join(""))},this));if(this.unit.player===0){var a=this.own(new JW.Functor([this.unit.movement],function(c){return c===0},this)).target;this.own(new JW.UI.ClassUpdater(b,"fl-moved",a))}}});FL.Vector={add:function(d,c){return[d[0]+c[0],d[1]+c[1]]},diff:function(d,c){return[d[0]-c[0],d[1]-c[1]]},mult:function(b,d){return[d*b[0],d*b[1]]},equal:function(d,c){return(d[0]===c[0])&&(d[1]===c[1])},length:function(b){return Math.sqrt(FL.Vector.lengthSqr(b))},lengthSqr:function(b){return b[0]*b[0]+b[1]*b[1]},length8:function(b){return Math.max(Math.abs(b[0]),Math.abs(b[1]))},between:function(e,d,f){return FL.Vector.add(e,FL.Vector.mult(FL.Vector.diff(d,e),f))},round:function(b){return[Math.round(b[0]),Math.round(b[1])]},norm8:function(b){return[JW.sgn(b[0]),JW.sgn(b[1])]},parse:function(a){a=a.split(",");return[+a[0],+a[1]]}};var data,app;jQuery(function(){FL.Resource.initDescription();data=new FL.Data();app=new FL.App(data);app.renderTo("body")});