var FL={mapSize:32,cellSize:16,rockCount:20,rockDensity:20,playerCount:2,minBaseDistanceSqr:8,minMainBaseDistanceSqr:100,minMainBaseSideDistance:4,minMainBaseCenterDistance:5,baseSightRangeSqr:12,baseDefense:6,baseMiningRangeSqr:5,dir4:[[0,1],[-1,0],[0,-1],[1,0]],dir8:[[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1],[1,0],[1,1]],sound:function(a){var b=new Audio();b.src="audio/"+a+".ogg";b.play()},random:function(a){return Math.floor(Math.random()*a)},getIjs4:function(b){var a=[];for(var c=0;c<4;++c){a.push(FL.Vector.add(b,FL.dir4[c]))}return a},getIjs8:function(b){var a=[];for(var c=0;c<8;++c){a.push(FL.Vector.add(b,FL.dir8[c]))}return a},fight:function(b,a){return FL.random(b+a)<b}};FL.AI={behaviours:["build","patrol","hold","rush","attack","attacking","assaulting","support","bombard","fly"],attack:2,patrolDistance:3,aquisitionDistanceSqr:50,baseHoldRangeSqr:10,unitHoldRangeSqr:4,patrolPerBase:3,initialProductionCoef:1,productionCoefPerWin:0.2,productionCoefPerLoss:0.05,process:function(f,n){var a=f.bases.$toArray().filter(JW.byValue("player",n));var k=f.units.$toArray().filter(JW.byValue("player",n));var l=JW.Map.map(FL.Unit.types,function(){return 0});var g=JW.Map.map(FL.Unit.types,function(){return 0});var o=JW.Array.$index(FL.AI.behaviours,JW.byField()).map(function(){return[]});JW.Array.each(k,function(i){++l[i.type.id];++g[i.type.id];if((i.behaviour==="patrol")&&(o.patrol.length>=FL.AI.patrolPerBase*a.length)){i.behaviour="attack"}o[i.behaviour].push(i)});JW.Array.each(a,function(j){var i=j.unitType.get();if(i){++g[i.id]}});JW.Array.each(a,function(p){if(p.unitType.get()){return}var j=p.getAvailableUnitTypes();if(g.mcv!==0){JW.Array.removeItem(j,FL.Unit.types.mcv)}var i=j[FL.random(j.length)];p.unitType.set(i);++g[i.id]});JW.Array.each(o.build,function(j){var i=j.ijTarget||FL.AI.findBaseSpot(f,j.ij,n);if(FL.Vector.equal(i,j.ij)){f.buildBase(j)}else{j.ijTarget=i}});var h=new JW.Set();f.units.each(function(r){if(r.player===n){return}var j,s=Number.POSITIVE_INFINITY;JW.Array.each(a,function(u){var t=FL.Vector.lengthSqr(FL.Vector.diff(r.ij,u.ij));if(t<s){j=u;s=t}});if(s>FL.AI.aquisitionDistanceSqr){return}var i,q=Number.POSITIVE_INFINITY;JW.Array.each(o.patrol,function(u){if(h.contains(u)){return}var t=FL.Vector.lengthSqr(FL.Vector.diff(u.ij,j.ij));if(t<q){i=u;q=t}});if(!i){return}h.add(i);var p=FL.Vector.round(FL.Vector.between(r.ij,j.ij,0.45));if(!i.ijTarget||!FL.Vector.equal(p,i.ijTarget)){i.ijTarget=p}else{if(r.type.attack*i.type.attack>r.type.defense*i.type.defense){i.ijTarget=r.ij}}});if(o.attack.length<FL.AI.attack){o.patrol=o.patrol.concat(o.attack)}else{FL.AI.attack++;var c=FL.random(2)?"assaulting":"attacking";o[c]=o[c].concat(o.attack);JW.Array.each(o.attack,function(i){i.behaviour=c})}JW.Array.each(o.patrol,function(j){if(h.contains(j)){return}if(j.ijTarget){return}var p=a[FL.random(a.length)];if(!p){return}var i=f.map.getRect(p.ij,FL.AI.patrolDistance);j.ijTarget=[i.iMin+FL.random(i.iMax-i.iMin+1),i.jMin+FL.random(i.jMax-i.jMin+1)]});FL.AI.issueAttack(f,n,o.attacking,true,true);FL.AI.issueAttack(f,n,o.assaulting,false,true);var b=new FL.Matrix(f.map.size);JW.Array.each(a,function(i){f.map.eachWithin(i.ij,FL.AI.baseHoldRangeSqr,function(j,p){b.setCell(p,true)})});JW.Array.each(o.hold,function(i){if(!i.hold){return}f.map.eachWithin(i.ij,FL.AI.unitHoldRangeSqr,function(j,p){b.setCell(p,true)})});for(var e=0;e<f.map.size;++e){for(var d=0;d<f.map.size;++d){var m=[e,d];if(!f.isPassable(m)||f.isChoke(m)){b.setCell(m,true)}}}JW.Array.each(o.hold,function(v){if(!b.getCell(v.ij)){v.hold=true;f.map.eachWithin(v.ij,FL.AI.unitHoldRangeSqr,function(i,j){b.setCell(j,true)})}if(v.hold){return}var p,u=Number.POSITIVE_INFINITY;for(var t=0;t<f.map.size;++t){for(var q=0;q<f.map.size;++q){var s=[t,q];if(b.getCell(s)){continue}var r=FL.Vector.lengthSqr(FL.Vector.diff(v.ij,s))+0.2*FL.Vector.lengthSqr(FL.Vector.diff(f.map.ijCenter(),s));if(r<u){p=s;u=r}}}if(p){v.ijTarget=p}else{v.ijTarget=FL.Vector.add(v.ij,FL.dir8[FL.random(8)]);if(!f.map.inMatrix(v.ijTarget)){v.ijTarget=null}}})},findBaseSpot:function(d,b,k){var g=null;var f=Number.NEGATIVE_INFINITY;for(var e=0;e<d.map.size;++e){for(var c=0;c<d.map.size;++c){var l=[e,c];var h=d.map.getCell(l);if(h.rock||h.miningBase){continue}if(h.unit&&!FL.Vector.equal(b,l)){continue}var a=FL.AI.getBaseProfit(d,l,k)-3*FL.Vector.length(FL.Vector.diff(b,l));if(a<=f){continue}if(!d.isBaseBuildable(l)){continue}g=l;f=a}}return g},getBaseProfit:function(c,d,b){var a=0;c.map.eachWithin(d,FL.baseMiningRangeSqr,function(e,f){if(e.rock||e.miningBase){return}if(e.unit&&(e.unit.player!==b)){a-=2*(e.unit.type.attack||0)}++a;if(e.resource){a+=e.resource.aiProfit}});return a},issueAttack:function(f,c,a,d,b){var e=[];if(b){f.bases.each(function(g){if(g.player!==c){e.push(g.ij)}})}if(d){f.units.each(function(g){if(g.player!==c){e.push(g.ij)}})}JW.Array.each(a,function(i){var g,h=Number.POSITIVE_INFINITY;JW.Array.each(e,function(k){var j=FL.Vector.lengthSqr(FL.Vector.diff(i.ij,k));if(j<h){g=k;h=j}});if(!g){return}if(f.getPath(i.ij,g,c)){i.ijTarget=g}else{i.behaviour="attacking";i.ijTarget=FL.Vector.add(i.ij,FL.dir8[FL.random(8)]);if(!f.map.inMatrix(i.ijTarget)){i.ijTarget=null}}})}};FL.AI.productionCoef=FL.AI.initialProductionCoef+(localStorage.wins||0)*FL.AI.productionCoefPerWin-(localStorage.losses||0)*FL.AI.productionCoefPerLoss;FL.App=function(a){FL.App._super.call(this);this.data=a};JW.extend(FL.App,JW.UI.Component,{renderRoot:function(a){a.bind("contextmenu",JW.UI.preventDefault)},renderMonitor:function(){return new FL.Monitor(this.data)},afterRender:function(){this._super();this.data.lostEvent.bind(this._onLost,this)},_onLost:function(a){this.children.set(new FL.ScreenWin(a!==0),"monitor")}});JW.UI.template(FL.App,{main:'<div jwclass="fl-app"><div jwid="monitor"></div></div>'});FL.Base=function(b,a){FL.Base._super.call(this);this.ij=b;this.player=a;this.unitType=this.own(new JW.Property(null));this.production=JW.Map.map(FL.Unit.types,function(){return 0});this.mining=0;this.overflow=0;this.resources=[]};JW.extend(FL.Base,JW.Class,{isUnitTypeAvailable:function(a){if(!a.resources){return true}return JW.Array.every(a.resources,function(b){return JW.Array.containsItem(this.resources,FL.Resource.types[b])},this)},getAvailableUnitTypes:function(){return JW.Array.filter(FL.Unit.typeArray,this.isUnitTypeAvailable,this)}});FL.Cell=function(a){FL.Cell._super.call(this);this.ij=a;this.rock=false;this.base=null;this.miningBase=null;this.unit=null;this.resource=null;this.scouted=false;this.visible=false;this.invalid=false};JW.extend(FL.Cell,JW.Class,{reveal:function(){if(this.scouted&&this.visible){return}this.scouted=true;this.visible=true;this.invalid=true},hide:function(){if(!this.scouted||!this.visible){return}this.visible=false;this.invalid=true},setBase:function(a){if(this.base===a){return}this.base=a;this.invalid=true},setMiningBase:function(a){if(a||(a!==this.miningBase)){this.invalid=true}this.miningBase=a},setUnit:function(a){if(this.unit===a){return}this.unit=a;this.invalid=true}});FL.Data=function(){FL.Data._super.call(this);this.map=null;this.bases=new JW.Set();this.units=new JW.Set();this.logEvent=new JW.Event();this.lostEvent=new JW.Event();this.turn=1;this._generateMap()};JW.extend(FL.Data,JW.Class,{createBase:function(b,a){var c=new FL.Base(b,a);this.bases.add(c);this.map.getCell(b).base=c;if(a==0){this.reveal(b,FL.baseSightRangeSqr)}return c},destroyBase:function(a){this.bases.remove(a);this.map.getCell(a.ij).setBase(null);a.destroy();if(this.bases.count(JW.byValue("player",a.player))===0){this.lostEvent.trigger(a.player)}},createUnit:function(b,a,c,e){var d=new FL.Unit(b,a,c,e);this.units.add(d);this.map.getCell(b).setUnit(d);if(a==0){this.reveal(b,c.sightRangeSqr)}},destroyUnit:function(a){this.units.remove(a);this.map.getCell(a.ij).setUnit(null);a.destroy()},moveUnit:function(d){if(!d.ijTarget){return}var e=this.getPath(d.ij,d.ijTarget,d.player);if(!e){d.ijTarget=null;return}d.hold=false;for(var c=0;(c<e.length)&&d.movement;++c){var b=FL.Vector.add(d.ij,FL.dir8[e[c]]);
if(!this.isPassable(b)){break}var f=this.map.getCell(d.ij);var a=this.map.getCell(b);if(a.unit){if((a.unit.player!==d.player)&&FL.Vector.equal(b,d.ijTarget)&&(d.type.attack!==0)){--d.movement;f.invalid=true;this.fightUnit(d,a.unit)}d.ijTarget=null;break}if(a.base&&(a.base.player!==d.player)){if(FL.Vector.equal(b,d.ijTarget)&&(d.type.attack!==0)){--d.movement;f.invalid=true;this.fightBase(d,a.base)}d.ijTarget=null;break}--d.movement;this.transferUnit(d,b)}if(d.ijTarget&&FL.Vector.equal(d.ij,d.ijTarget)){d.ijTarget=null}},transferUnit:function(b,a){this.map.getCell(b.ij).setUnit(null);b.ij=a;this.map.getCell(a).setUnit(b);if(b.player===0){this.reveal(a,b.type.sightRangeSqr)}},moveUnits:function(a){this.units.$filter(JW.byValue("player",a)).each(this.moveUnit,this)},fightUnit:function(b,a){var c=FL.fight(b.type.attack,a.type.defense);if(c){this.destroyUnit(a);if(b.player===0){this.log("Your "+b.type.name+" (attack: "+b.type.attack+") has killed enemy "+a.type.name+" (defense: "+a.type.defense+") in successful attack","fl-good")}else{this.log("Enemy "+b.type.name+" (attack: "+b.type.attack+") has killed your "+a.type.name+" (defense: "+a.type.defense+") in successful attack","fl-bad")}}else{this.destroyUnit(b);if(b.player===0){this.log("Your "+b.type.name+" (attack: "+b.type.attack+") has been killed by enemy "+a.type.name+" (defense: "+a.type.defense+") in failed attack","fl-bad")}else{this.log("Enemy "+b.type.name+" (attack: "+b.type.attack+") has been killed by your "+a.type.name+" (defense: "+a.type.defense+") in failed attack","fl-good")}}},fightBase:function(a,b){var c=FL.fight(a.type.attack,FL.baseDefense);if(c){this.destroyBase(b);this.resetMining();if(a.player===0){this.log("Your "+a.type.name+" (attack: "+a.type.attack+") has destroyed enemy base (defense: "+FL.baseDefense+") in successful attack","fl-good")}else{this.log("Enemy "+a.type.name+" (attack: "+a.type.attack+") has destroyed your base (defense: "+FL.baseDefense+") in successful attack","fl-bad")}}else{this.destroyUnit(a);if(a.player===0){this.log("Your "+a.type.name+" (attack: "+a.type.attack+") has been killed by enemy base (defense: "+FL.baseDefense+") in failed attack","fl-bad")}else{this.log("Enemy "+a.type.name+" (attack: "+a.type.attack+") has been killed by your base (defense: "+FL.baseDefense+") in failed attack","fl-good")}}},endTurn:function(){this.log("End turn");this._endTurnPlayer(0);FL.AI.process(this,1);this._endTurnPlayer(1);++this.turn;this.log("Turn "+this.turn)},_endTurnPlayer:function(a){this.moveUnits(a);this.units.$filter(JW.byValue("player",a)).each(function(b){b.movement=b.type.movement},this);this.resetVision();this._produce(a)},reveal:function(b,a){this.map.eachWithin(b,a,JW.byMethod("reveal"))},resetVision:function(){for(var b=0;b<this.map.size;++b){for(var a=0;a<this.map.size;++a){this.map.getCell([b,a]).hide()}}this.bases.each(function(c){if(c.player===0){this.reveal(c.ij,FL.baseSightRangeSqr)}},this);this.units.each(function(c){if(c.player===0){this.reveal(c.ij,c.type.sightRangeSqr)}},this)},resetMining:function(){var b=new FL.Matrix(this.map.size);this.bases.each(function(g){g.mining=0;g.resources=[];this.map.eachWithin(g.ij,FL.baseMiningRangeSqr,function(h,i){if(h.rock){return}var j=b.getCell(i);if(!j){b.setCell(i,g);return}if(FL.Vector.lengthSqr(FL.Vector.diff(i,j.ij))>FL.Vector.lengthSqr(FL.Vector.diff(i,g.ij))){b.setCell(i,g);return}},this)},this);for(var e=0;e<this.map.size;++e){for(var c=0;c<this.map.size;++c){var d=[e,c];var f=b.getCell(d);this.map.getCell(d).setMiningBase(f);if(!f){continue}var a=this.map.getCell(d);if(a.resource){f.resources.push(a.resource)}if(a.rock){continue}f.mining++;if(a.resource&&a.resource.bonus){f.mining+=a.resource.bonus}}}},buildBase:function(a){this.createBase(a.ij,a.player);this.destroyUnit(a);this.resetMining()},isBaseBuildable:function(a,b){if(!this.isPassable(a)){return false}if(this.map.getCell(a).resource){return false}b=b||FL.minBaseDistanceSqr;return this.bases.every(function(c){return FL.Vector.lengthSqr(FL.Vector.diff(a,c.ij))>=b},this)},isPassable:function(a){return this.map.inMatrix(a)&&!this.map.getCell(a).rock},isDroppable:function(d,b,e,c){if(FL.Vector.lengthSqr(FL.Vector.diff(d,b))>e){return false}var a=this.map.getCell(b);if(!this.isPassable(b)||a.unit||a.base){return false}if((c===0)&&!a.scouted){return false}return true},isChoke:function(c){var a=FL.getIjs8(c);if(this.isPassable(a[0])&&!this.isPassable(a[2])&&this.isPassable(a[4])&&!this.isPassable(a[6])){return true}if(!this.isPassable(a[0])&&this.isPassable(a[2])&&!this.isPassable(a[4])&&this.isPassable(a[6])){return true}for(var e=0;e<8;e+=2){if(!this.isPassable(a[e])&&this.isPassable(a[e+1])&&!this.isPassable(a[(e+2)%8])){for(var b=3;b<8;++b){if(this.isPassable(a[(e+b)%8])){return true}}}}return false},isByEnemy:function(e,c){for(var g=0;g<FL.dir8.length;++g){var a=FL.Vector.add(e,FL.dir8[g]);var b=this.map.getCell(a);if(!b){continue}var f=b.unit;if(f&&(f.player!==c)){return true}}return false},getPath:function(m,b,n){if(FL.Vector.equal(m,b)){return[]}var g=[m];var i=0;var a=new FL.Matrix(this.map.size);a.setCell(m,true);while(i<g.length){var f=g[i++];for(var j=0;j<FL.dir8.length;++j){var e=(j<4)?(2*j):(2*j-7);var h=FL.Vector.add(f,FL.dir8[e]);if(!this.map.inMatrix(h)||(a.getCell(h)!=null)){continue}var l=this.map.getCell(h);if((n!==0)||l.scouted){if(!this.isPassable(h)){continue}}if((n!==0)||l.visible){var k=l.unit;if(k){if((k.player===n)||!FL.Vector.equal(h,b)){continue}}if(!k&&this.isByEnemy(f,n)&&this.isByEnemy(h,n)){continue}var c=l.base;if(c&&(c.player!==n)&&!FL.Vector.equal(h,b)){continue}}g.push(h);a.setCell(h,e);if(FL.Vector.equal(h,b)){return this._backtracePath(a,b)}}}return null},log:function(b,a){this.logEvent.trigger([b,a])},_generateMap:function(){this.map=new FL.Matrix(FL.mapSize);for(var d=0;d<FL.mapSize;++d){for(var b=0;b<FL.mapSize;++b){var c=[d,b];var a=new FL.Cell(c);this.map.setCell(c,a)}}this._generateRocks();this._generateResources();this._generateBases();this.resetMining();this.bases.each(function(e){var f;if(e.mining<20){f="aluminum"}else{if(e.mining<24){f="oil"}else{if(e.mining<26){f="iron"}else{if(e.mining<30){f="copper"}else{return}}}}this.map.eachWithin(e.ij,2,function(g){if(f&&!g.resource){g.resource=FL.Resource.types[f];f=null}},this)},this);this.resetMining()},_generateRocks:function(){for(var f=0;f<FL.rockCount;++f){var l,b;do{l=this.map.ijRandom();b=this.isPassable(l)&&!this.isChoke(l)}while(!b);var e=[];var a=JW.inScope(function(d){if(!this.isPassable(d)||this.isChoke(d)){return}e.push(d);this.map.getCell(d).rock=true},this);a(l);var k=FL.random(FL.rockDensity);for(var c=0;c<k;++c){var h=FL.random(4);var g=FL.Vector.add(e[FL.random(e.length)],FL.dir4[h]);a(g)}}},_generateResources:function(){JW.Array.each(FL.Resource.typeArray,function(d){for(var c=0;c<d.count;++c){var b;do{b=this.map.ijRandom();var a=this.map.getCell(b)}while(a.rock||a.resource);a.resource=d}},this)},_generateBases:function(){for(var a=0;a<FL.playerCount;++a){var l;while(true){l=this.map.ijRandom();if(!this.isBaseBuildable(l,FL.minMainBaseDistanceSqr)){continue}var f=this.map.ijCenter();var h=FL.Vector.diff(l,f);var g=FL.Vector.length8(h);if(g<FL.minMainBaseCenterDistance){continue}var m=this.map.size/2-g;if(m<FL.minMainBaseSideDistance){continue}break}for(var c=-1;c<=1;++c){for(var b=-1;b<=1;++b){var k=this.map.getCell(FL.Vector.add(l,[c,b]));if(k){k.rock=false}}}this.createBase(l,a);for(var e=0;e<4;++e){this.createUnit(FL.Vector.add(l,FL.dir4[e]),a,FL.Unit.types.militia,"patrol")}}},_backtracePath:function(c,a){var b=[];while(true){var e=c.getCell(a);if(e===true){b.reverse();return b}b.push(e);a=FL.Vector.diff(a,FL.dir8[e])}},_produce:function(a){this.bases.each(function(e){if(e.player!==a){return}var c=e.unitType.get();if(!c){return}var d=(a===0)?1:FL.AI.productionCoef;var f=e.production[c.id]+e.overflow+Math.round(d*e.mining);var b=this.map.getCell(e.ij);if((f>=c.cost)&&!b.unit){this.createUnit(e.ij,e.player,c);e.production[c.id]=0;e.overflow=f-c.cost;
e.unitType.set(null)}else{e.production[c.id]=Math.min(f,c.cost);e.overflow=0}},this)}});FL.El={xy:function(b,a){b.css({left:a[1]+"px",top:a[0]+"px"})},size:function(b,a){b.css({width:a[1]+"px",height:a[0]+"px"})}};FL.Matrix=function(b){FL.Matrix._super.call(this);this.size=b;this.cells=new Array(b);for(var a=0;a<b;++a){this.cells[a]=new Array(b)}};JW.extend(FL.Matrix,JW.Class,{getCell:function(a){return JW.get(this.cells,a)},setCell:function(a,b){this.cells[a[0]][a[1]]=b},inMatrix:function(a){return(a[0]>=0)&&(a[0]<this.size)&&(a[1]>=0)&&(a[1]<this.size)},ijRandom:function(){return[FL.random(this.size),FL.random(this.size)]},ijCenter:function(){return FL.Vector.mult([this.size,this.size],0.5)},getRect:function(a,b){return{iMin:Math.max(0,a[0]-b),iMax:Math.min(this.size-1,a[0]+b),jMin:Math.max(0,a[1]-b),jMax:Math.min(this.size-1,a[1]+b)}},eachWithin:function(c,a,h,k){var b=Math.ceil(Math.sqrt(a));var f=this.getRect(c,b);for(var e=f.iMin;e<=f.iMax;++e){for(var d=f.jMin;d<=f.jMax;++d){var g=[e,d];if(FL.Vector.lengthSqr(FL.Vector.diff(g,c))<=a){h.call(k||this,this.getCell(g),g)}}}}});FL.Monitor=function(a){FL.Monitor._super.call(this);this.data=a;this.cellSelect=null;this.panel=this.own(new JW.Property()).ownValue();this.selectionQueue=[];this.selectionTail=0;this.baseExitAttachment=this.own(new JW.Property()).ownValue();this.orderIj=null;this.orderRangeSqr=null;this.orderCallback=null;this.orderScope=null;this.cells=new FL.Matrix(this.data.map.size)};JW.extend(FL.Monitor,JW.UI.Component,{renderNext:function(a){a.click(JW.inScope(function(){this.selectNext()},this))},renderEndTurn:function(a){a.click(JW.inScope(function(){this.selectionQueue=[];a.removeClass("fl-active");this.selectCell(null);this.data.endTurn();this.updateMap();this.selectNext()},this))},renderLog:function(a){this.data.logEvent.bind(function(b){var c=jQuery('<div class="fl-message"></div>');c.text(b[0]);if(b[1]){c.addClass(b[1])}a.append(c);a.scrollTop(1000000)},this)},renderMap:function(f){f.mousedown(JW.inScope(this._onMapMouseDown,this));var g=this.data.map;for(var e=0;e<g.size;++e){var c=jQuery('<div class="fl-monitor-row"></div>');for(var b=0;b<g.size;++b){var d=[e,b];var a=jQuery('<div class="fl-monitor-cell"></div>');this.cells.setCell(d,a);a.attr("fl-i","n"+e);a.attr("fl-j","n"+b);this._updateCell(a,d);c.append(a)}c.append('<div class="fl-clear"></div>');f.append(c)}},renderPanel:function(){return this.panel},afterRender:function(){this._super();this.selectNext()},selectCell:function(a){this.resetOrder();if(this.cellSelect){this._getCell(this.cellSelect.ij).removeClass("fl-selected")}this.baseExitAttachment.set(null);this.cellSelect=a?this.data.map.getCell(a):null;if(this.cellSelect){this._getCell(a).addClass("fl-selected");var b=this.cellSelect.base;if(this._isBaseAutoSelectable(b)){this.baseExitAttachment.set(b.unitType.changeEvent.bind(this.selectNext,this))}this.panel.set(new FL.Panel(this,this.cellSelect))}else{this.panel.set(null)}},selectNext:function(){while(this.selectionTail<this.selectionQueue.length){var a=this.data.map.getCell(this.selectionQueue[this.selectionTail++]);var b=this._isUnitAutoSelectable(a.unit);var c=this._isBaseAutoSelectable(a.base);if(b||c){this.selectCell(a.ij);return}}this._refreshSelectionQueue();if(this.selectionQueue.length){this.selectCell(this.selectionQueue[this.selectionTail++]);return}this.data.moveUnits(0);this.updateMap();this._refreshSelectionQueue();if(this.selectionQueue.length){this.selectCell(this.selectionQueue[this.selectionTail++]);return}this.selectCell(null);this.getElement("end-turn").addClass("fl-active")},updateMap:function(e){var f=this.data.map;for(var d=0;d<f.size;++d){for(var b=0;b<f.size;++b){var c=[d,b];var a=this.data.map.getCell(c);if(e||a.invalid){this._updateCell(this._getCell(c),c)}}}},initOrder:function(d,f,g,e){this.selectCell(null);this.orderIj=d;this.orderRangeSqr=f;this.orderCallback=g;this.orderScope=e;this.getElement("map").addClass("fl-order-active");for(var c=0;c<this.data.map.size;++c){for(var a=0;a<this.data.map.size;++a){var b=[c,a];if(!this.data.isDroppable(this.orderIj,b,this.orderRangeSqr,0)){this._getCell(b).append('<div class="fl-order-overlay"></div>')}}}this.panel.set(new FL.Panel.Order())},resetOrder:function(){if(!this.orderIj){return}this.orderIj=null;this.orderRangeSqr=null;this.orderCallback=null;this.orderScope=null;this.getElement("map").removeClass("fl-order-active");this.getElement("map").find(".fl-order-overlay").remove()},_getCell:function(a){return this.cells.getCell(a)},_updateCell:function(a,i){a=a||this._getCell(i);var j=this.data.map.getCell(i);j.invalid=false;a.empty();a.toggleClass("fl-scouted",j.scouted);a.toggleClass("fl-visible",j.visible);a.toggleClass("fl-rock",j.rock);if(j.miningBase){a.attr("fl-player","n"+j.miningBase.player);a.append('<div class="fl-mining"></div>')}else{a.removeAttr("fl-player")}var e=jQuery('<div class="fl-border"></div>');e.toggleClass("fl-hold",(j.unit!=null)&&j.unit.hold&&(j.unit.player===0));for(var h=0;h<4;++h){var g=FL.Vector.add(j.ij,FL.dir4[h]);var c=this.data.map.getCell(g);e.toggleClass("fl-border-"+h,c&&!c.rock&&!j.rock&&j.miningBase&&(c.miningBase!==j.miningBase)&&(c.miningBase?(j.miningBase._iid>c.miningBase._iid):true))}a.append(e);if(j.resource){var f=jQuery('<div class="fl-resource"></div>');f.attr("fl-type",j.resource.id);a.append(f)}if(j.base){var k=jQuery('<div class="fl-base"></div>');k.attr("fl-player","n"+j.base.player);a.append(k)}if(j.unit){var b=jQuery('<div class="fl-unit"></div>');b.attr("fl-type",j.unit.type.id);b.attr("fl-player","n"+j.unit.player);b.toggleClass("fl-moved",j.unit.movement===0);a.append(b)}if(j.scouted&&!j.visible){a.append('<div class="fl-fog"></div>')}},_onMapMouseDown:function(c){c.preventDefault();var a=jQuery(c.target);if(!a.hasClass("fl-monitor-cell")){a=a.parents(".fl-monitor-cell").eq(0)}if(!a.hasClass("fl-monitor-cell")){return}var b=[+a.attr("fl-i").substr(1),+a.attr("fl-j").substr(1)];switch(c.which){case 1:this._onLeftMouseDown(a,b);break;case 3:this._onRightMouseDown(a,b);break}},_onLeftMouseDown:function(a,b){this.selectCell(b)},_onRightMouseDown:function(a,b){if(this.orderIj){if(!this.data.isDroppable(this.orderIj,b,this.orderRangeSqr,0)){return}this.orderCallback.call(this.orderScope,b);this.resetOrder();this.selectNext();return}if(!this.cellSelect){return}var c=this.cellSelect.unit;if(!c||(c.player!==0)){return}c.ijTarget=b;this.data.moveUnit(c);this.updateMap();if(c.movement){this.selectCell(c.ij)}else{this.selectNext()}},_refreshSelectionQueue:function(){this.selectionQueue=[];this.selectionTail=0;this.data.units.each(function(a){if(this._isUnitAutoSelectable(a)){this.selectionQueue.push(a.ij)}},this);this.data.bases.each(function(b){var a=JW.Array.some(this.selectionQueue,function(c){return FL.Vector.equal(c,b.ij)},this);if(!a&&this._isBaseAutoSelectable(b)){this.selectionQueue.push(b.ij)}},this)},_isUnitAutoSelectable:function(a){return a&&(a.player===0)&&(a.movement!==0)&&!a.hold&&!a.ijTarget},_isBaseAutoSelectable:function(a){return a&&(a.player===0)&&(a.unitType.get()==null)}});JW.UI.template(FL.Monitor,{main:'<div jwclass="fl-monitor"><div jwid="left-panel"><div jwid="buttons"><button jwid="next">Next unit/base</button> <button jwid="end-turn">End turn</button></div><div jwid="log"></div><div jwid="help"><div>Left mouse button - select unit or base.</div><div>Right mouse button - move unit.</div><div>&nbsp;</div><div>Units can\'t move from a tile near an enemy unit to another tile near an enemy unit. You must retreat, fight or defend in this case.</div><div>&nbsp;</div><div>Two units can\'t share the same tile. Beware: your base can\'t produce a unit if the tile is taken by another unit.</div></div></div><div jwid="map"></div><div jwid="panel"></div><div class="fl-clear"></div></div>'});FL.Panel=function(b,a){FL.Panel._super.call(this);this.monitor=b;this.cell=a};JW.extend(FL.Panel,JW.UI.Component,{renderTerrainName:function(a){if(!this.cell.scouted){}else{if(this.cell.rock){a.text("Mountain")
}else{a.text("Plain")}}},renderTerrainDescription:function(a){if(!this.cell.scouted){a.text("This area is not scouted yet.")}else{if(this.cell.rock){a.text("Doesn't make production. Units can not pass.")}else{a.text("Increases production by 1.")}}},renderResourceName:function(a){if(this.cell.scouted&&this.cell.resource){a.text(this.cell.resource.name)}},renderResourceDescription:function(a){if(this.cell.scouted&&this.cell.resource){a.html(this.cell.resource.descriptionHtml)}},renderUnit:function(){if(this.cell.visible&&this.cell.unit){return this.own(new FL.Panel.Unit(this.monitor,this.cell.unit))}},renderBase:function(){if(this.cell.visible&&this.cell.base&&(this.cell.base.player===0)){return this.own(new FL.Panel.Base(this.cell.base))}}});JW.UI.template(FL.Panel,{main:'<div jwclass="fl-panel"><div jwid="terrain"><div jwid="terrain-name" class="fl-title"></div><div jwid="terrain-description"></div></div><div jwid="resource"><div jwid="resource-name" class="fl-title"></div><div jwid="resource-description"></div></div><div jwid="unit"></div><div jwid="base"></div></div>'});FL.Panel.Base=function(a){FL.Panel.Base._super.call(this);this.base=a};JW.extend(FL.Panel.Base,JW.UI.Component,{renderDefense:function(a){a.text(FL.baseDefense)},renderMining:function(a){a.text(this.base.mining)},renderUnits:function(){return JW.Array.$map(FL.Unit.typeArray,function(a){return this.own(new FL.Panel.UnitButton(this.base,a))},this)},renderProduction:function(){return this.own(new JW.Mapper([this.base.unitType],{createValue:function(a){return new FL.Panel.Production(this.base)},destroyValue:JW.destroy,scope:this})).target}});JW.UI.template(FL.Panel.Base,{main:'<div jwclass="fl-panel-base"><div class="fl-title">Base defense: <span jwid="defense"></span></div><div class="fl-title">Production: <span jwid="mining"></span></div><div jwid="units"></div><div jwid="production"></div></div>'});FL.Panel.Order=function(){FL.Panel.Order._super.call(this)};JW.extend(FL.Panel.Order,JW.UI.Component,{renderRoot:function(a){a.text("Right mouse button - issue order")}});FL.Panel.Production=function(a){FL.Panel.Production._super.call(this);this.base=a;this.type=this.base.unitType.get()};JW.extend(FL.Panel.Production,JW.UI.Component,{progressWidth:200,renderProgress:function(a){a.css("width",this.progressWidth+"px")},renderProgressFill:function(b){var c=this.base.overflow+this.base.production[this.type.id];var a=Math.min(1,c/this.type.cost);b.css("width",Math.floor(200*a)+"px")},renderUnit:function(){return this.own(new FL.UnitInfo(this.type,this.base.player,this.type.movement,true))}});JW.UI.template(FL.Panel.Production,{main:'<div jwclass="fl-panel-production"><div jwid="progress"><div jwid="progress-fill"></div></div><div jwid="unit"></div></div>'});FL.Panel.Unit=function(a,b){FL.Panel.Unit._super.call(this);this.monitor=a;this.unit=b};JW.extend(FL.Panel.Unit,JW.UI.Component,{renderInfo:function(){return this.own(new FL.UnitInfo(this.unit.type,this.unit.player,this.unit.movement,false))},renderHold:function(a){a.click(JW.inScope(function(){this.unit.hold=true;this.monitor._updateCell(null,this.unit.ij);this.monitor.selectNext()},this))},renderBuild:function(a){if((this.unit.type.id!=="mcv")||(this.unit.movement===0)){return false}if(!this.monitor.data.isBaseBuildable(this.unit.ij,FL.minBaseDistanceSqr)){return false}a.click(JW.inScope(function(){this.monitor.data.buildBase(this.unit);this.monitor.updateMap();this.monitor.selectCell(this.unit.ij)},this))},renderDrop:function(a){if(!this.unit.type.paradropRangeSqr||(this.unit.movement===0)){return false}if(!this.monitor.data.map.getCell(this.unit.ij).base){return false}a.click(JW.inScope(function(){var c=this.unit;var b=this.monitor;var d=this.monitor.data;this.monitor.initOrder(c.ij,c.type.paradropRangeSqr,function(e){c.movement=0;c.ijTarget=null;d.transferUnit(c,e);b.updateMap()})},this))}});JW.UI.template(FL.Panel.Unit,{main:'<div jwclass="fl-panel-unit"><div jwid="title" class="fl-title">Army</div><div jwid="info"></div><div jwid="buttons"><button jwid="hold">Hold position</button> <button jwid="build" class="fl-active">Build base</button> <button jwid="drop" class="fl-active">Air drop</button></div></div>'});FL.Panel.UnitButton=function(b,a){FL.Panel.UnitButton._super.call(this);this.base=b;this.type=a};JW.extend(FL.Panel.UnitButton,JW.UI.Component,{renderRoot:function(a){a.click(JW.UI.preventDefault);a.attr("fl-type",this.type.id);if(this.base.isUnitTypeAvailable(this.type)){a.attr("title","Produce "+this.type.name+" (cost: "+this.type.cost+")");a.attr("fl-player","n"+this.base.player);a.click(JW.inScope(function(c){this.base.unitType.set(this.type)},this))}else{var b=JW.Array.map(this.type.resources,function(c){return FL.Resource.types[c].name},this);a.attr("title",this.type.name+" requires "+b.join(", "))}}});JW.UI.template(FL.Panel.UnitButton,{main:'<a href="#" class="fl-panel-unitbutton fl-unit blocklink"></a>'});FL.Resource={initDescription:function(){JW.Array.each(FL.Resource.typeArray,function(c){var a="";if(c.bonus){a+="Increases production by "+c.bonus+".<br>"}var b=JW.Array.filter(FL.Unit.typeArray,function(e){return(e.resources!=null)&&JW.Array.containsItem(e.resources,c.id)});if(b.length){var d=JW.Array.map(b,JW.byField("name"));a+="Required to produce units: "+d.join(", ")+"<br />"}c.descriptionHtml=a})}};FL.Resource.typeArray=[{id:"copper",name:"Copper",bonus:4,count:20,aiProfit:2},{id:"iron",name:"Iron",bonus:6,count:15,aiProfit:4},{id:"oil",name:"Oil",bonus:10,count:10,aiProfit:6},{id:"aluminum",name:"Aluminum",bonus:15,count:5,aiProfit:8},{id:"yard",name:"Advanced training yard",count:10,aiProfit:3},{id:"light",name:"Light vehicle factory",count:10,aiProfit:4},{id:"heavy",name:"Heavy vehicle factory",count:6,aiProfit:5}];FL.Resource.types=JW.Array.index(FL.Resource.typeArray,JW.byField("id"));FL.ScreenWin=function(a){FL.ScreenWin._super.call(this);this.win=a;localStorage.wins=+(localStorage.wins||0);localStorage.losses=+(localStorage.losses||0);localStorage.wisdom=+(localStorage.wisdom||0)+1;if(a){localStorage.wins=+localStorage.wins+1}else{localStorage.losses=+localStorage.losses+1}};JW.extend(FL.ScreenWin,JW.UI.Component,{renderTitle:function(a){a.text(this.win?"You win!":"You lost...")},renderWins:function(a){a.text(localStorage.wins)},renderLosses:function(a){a.text(localStorage.losses)},renderDifficulty:function(a){a.text(Math.round(FL.AI.productionCoef*100))},renderDifficultyModifier:function(a){if(this.win){a.text("+"+Math.round(FL.AI.productionCoefPerWin*100))}else{a.text("-"+Math.round(FL.AI.productionCoefPerLoss*100))}},renderClear:function(a){a.click(JW.inScope(function(b){b.preventDefault();localStorage.wins=0;localStorage.losses=0;this.getElement("wins").text(0);this.getElement("losses").text(0);this.getElement("difficulty").text(100);this.getElement("difficulty-modifier").text(0)},this))},renderWisdom:function(a){a.text(FL.ScreenWin.wisdoms[+localStorage.wisdom%FL.ScreenWin.wisdoms.length])}});FL.ScreenWin.wisdoms=["Soldiers usually win the battles and generals get the credit for it. -- Napoleon","The tragedy of war is that it uses man's best to do man's worst.","The Fourth World War will be fought with stones. -- Einstein","Diplomats are just as essential in starting a war as soldiers in finishing it. -- Rogers","There is no such thing as an inevitable war. If war comes it will be from failure of human wisdom. -- Law","Dictators ride to and from on tigers from which they dare not dismount. And the tigers are getting hungry. -- Churchill"];JW.UI.template(FL.ScreenWin,{main:'<div jwclass="fl-screen-win"><div jwid="title"></div><div jwid="statistics"><div><div jwid="statistics-left">Wins:</div><div jwid="statistics-right wins"></div><div class="fl-clear"></div></div><div><div jwid="statistics-left">Losses:</div><div jwid="statistics-right losses"></div><div class="fl-clear"></div></div><div><div jwid="statistics-left">Difficulty played:</div><div jwid="statistics-right"><span jwid="difficulty"></span>% (<span jwid="difficulty-modifier"></span>%)</div><div class="fl-clear"></div></div></div><a jwid="clear" class="fl-blocklink" href="#">Reset statistics and difficulty</a><div jwid="wisdom"></div><a jwid="refresh" class="fl-blocklink" href="javascript:location.reload()">Start again to find more wisdom</a></div>'});
FL.Unit=function(b,a,c,d){FL.Unit._super.call(this);this.ij=b;this.player=a;this.type=c;this.movement=this.type.movement;this.ijTarget=null;this.hold=false;this.behaviour=d||c.ai[FL.random(c.ai.length)]};JW.extend(FL.Unit,JW.Class,{});FL.Unit.typeArray=[{id:"mcv",name:"Mobile Construction Vehicle",attack:0,defense:1,movement:1,sightRangeSqr:2,cost:300,ai:["build"]},{id:"militia",name:'Militia "Meat shield"',attack:1,defense:3,movement:1,sightRangeSqr:2,cost:60,ai:["patrol","hold"]},{id:"infantry",name:'Infantry "Cannon fodder"',attack:3,defense:2,movement:1,sightRangeSqr:2,cost:90,ai:["patrol","attack"]},{id:"marine",name:'Marine "Hotheads"',attack:3,defense:6,movement:1,sightRangeSqr:8,cost:120,resources:["yard"],ai:["patrol","hold"]},{id:"paratrooper",name:'Paratrooper "Zealot bomb"',attack:6,defense:3,movement:1,sightRangeSqr:8,cost:150,resources:["yard"],paradropRangeSqr:20,ai:["attack"]},{id:"humvee",name:'Hum-Vee "Us will not catch up"',attack:5,defense:2,movement:4,sightRangeSqr:8,cost:150,resources:["light"],ai:["patrol","attack"]},{id:"radar",name:'Radar vehicle "I see you"',attack:3,defense:8,movement:2,sightRangeSqr:18,bombRangeSqr:12,bombAttack:2,cost:200,resources:["light"],ai:["patrol"]},{id:"tank",name:'Tank "Shushpanzer"',attack:14,defense:8,movement:2,sightRangeSqr:8,cost:360,resources:["heavy"],ai:["attack"]},{id:"mobile",name:'"Wunderwaffe" mobile site',attack:8,defense:18,movement:2,sightRangeSqr:8,cost:360,resources:["heavy"],ai:["attack"]}];FL.Unit.types=JW.Array.index(FL.Unit.typeArray,JW.byField("id"));FL.UnitInfo=function(d,c,a,b){FL.UnitInfo._super.call(this);this.type=d;this.player=c||0;this.movement=JW.defn(a,d.movement);this.showCost=b||false};JW.extend(FL.UnitInfo,JW.UI.Component,{renderIcon:function(a){a.attr("fl-type",this.type.id);a.attr("fl-player","n"+this.player)},renderName:function(a){a.text(this.type.name)},renderAttack:function(a){a.text(this.type.attack||"N/A")},renderDefense:function(a){a.text(this.type.defense)},renderMovement:function(a){if((this.movement===this.type.movement)||(this.player!==0)){a.text(this.movement)}else{a.text(this.movement+"/"+this.type.movement)}},renderCostBox:function(a){return this.showCost},renderCost:function(a){a.text(this.type.cost)}});JW.UI.template(FL.UnitInfo,{main:'<div jwclass="fl-unitinfo"><div jwid="header"><div jwid="icon" class="fl-unit"></div> <span jwid="name"></span></div><div>Attack: <span jwid="attack"></span></div><div>Defense: <span jwid="defense"></span></div><div>Movement: <span jwid="movement"></span></div><div jwid="cost-box">Cost: <span jwid="cost"></span></div></div>'});FL.Vector={add:function(d,c){return[d[0]+c[0],d[1]+c[1]]},diff:function(d,c){return[d[0]-c[0],d[1]-c[1]]},mult:function(b,d){return[Math.round(d*b[0]),Math.round(d*b[1])]},equal:function(d,c){return(d[0]===c[0])&&(d[1]===c[1])},length:function(b){return Math.sqrt(FL.Vector.lengthSqr(b))},lengthSqr:function(b){return b[0]*b[0]+b[1]*b[1]},length8:function(b){return Math.max(Math.abs(b[0]),Math.abs(b[1]))},between:function(e,d,f){return FL.Vector.add(e,FL.Vector.mult(FL.Vector.diff(d,e),f))},round:function(b){return[Math.round(b[0]),Math.round(b[1])]},norm8:function(b){return[JW.sgn(b[0]),JW.sgn(b[1])]}};var data,app;jQuery(function(){FL.Resource.initDescription();data=new FL.Data();app=new FL.App(data);app.renderTo("body")});